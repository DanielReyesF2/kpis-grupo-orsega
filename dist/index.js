var Ct=Object.defineProperty;var $n=Object.getOwnPropertyDescriptor;var _n=Object.getOwnPropertyNames;var Dn=Object.prototype.hasOwnProperty;var de=(a,r)=>()=>(a&&(r=a(a=0)),r);var pe=(a,r)=>{for(var e in r)Ct(a,e,{get:r[e],enumerable:!0})},Rn=(a,r,e,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let c of _n(r))!Dn.call(a,c)&&c!==e&&Ct(a,c,{get:()=>r[c],enumerable:!(o=$n(r,c))||o.enumerable});return a};var $t=a=>Rn(Ct({},"__esModule",{value:!0}),a);var Ne={};pe(Ne,{actionPlans:()=>Ae,areas:()=>J,clients:()=>ne,companies:()=>ue,companyIdSchema:()=>ft,cycleTimeMetricsSchema:()=>Yn,emailOutbox:()=>Tr,exchangeRates:()=>Z,insertActionPlanSchema:()=>Fn,insertAreaSchema:()=>Dt,insertClientSchema:()=>Ut,insertCompanyKpiValueSchema:()=>br,insertCompanySchema:()=>_t,insertEmailOutboxSchema:()=>oo,insertExchangeRateSchema:()=>ro,insertJobProfileSchema:()=>Gn,insertKpiDuraSchema:()=>Un,insertKpiOrsegaSchema:()=>Kn,insertKpiSchema:()=>Rt,insertKpiValueSchema:()=>vt,insertNotificationSchema:()=>zn,insertPaymentComplementSchema:()=>to,insertPaymentReceiptSchema:()=>eo,insertPaymentVoucherSchema:()=>no,insertProductSchema:()=>Qn,insertProviderSchema:()=>Xn,insertScheduledPaymentSchema:()=>Zn,insertShipmentCycleTimesSchema:()=>Jn,insertShipmentItemSchema:()=>qn,insertShipmentNotificationSchema:()=>Wn,insertShipmentSchema:()=>Mt,insertShipmentUpdateSchema:()=>Bn,insertSupplierSchema:()=>bt,insertUserActivationTokenSchema:()=>On,insertUserSchema:()=>Xe,jobProfileWithDetails:()=>Hn,jobProfiles:()=>we,kpiValuesDura:()=>Qe,kpiValuesOrsega:()=>Ze,kpisDura:()=>qe,kpisOrsega:()=>Be,loginSchema:()=>kn,notifications:()=>L,paymentComplements:()=>Pr,paymentReceipts:()=>xr,paymentVouchers:()=>W,products:()=>Sr,providers:()=>Er,registerUserSchema:()=>Ln,scheduledPayments:()=>Ft,shipmentCycleTimes:()=>te,shipmentItems:()=>Se,shipmentNotifications:()=>Ir,shipmentStatusEnum:()=>ht,shipmentUpdates:()=>Re,shipments:()=>se,suppliers:()=>Kt,updateKpiSchema:()=>jt,updateKpiValueSchema:()=>Vn,updateShipmentStatusSchema:()=>Ot,userActivationTokens:()=>Te,users:()=>ee,voucherStatusEnum:()=>wr});import{pgTable as H,text as v,serial as X,integer as U,boolean as ye,timestamp as j,json as Le,pgEnum as vr,real as ge,varchar as jn}from"drizzle-orm/pg-core";import{sql as Mn}from"drizzle-orm";import{createInsertSchema as Q}from"drizzle-zod";import{z as _}from"zod";var ht,ee,Xe,Te,On,ue,_t,J,Dt,qe,Be,Un,Kn,Qe,Ze,ft,ot,Rt,br,vt,Ae,Fn,kn,Vn,jt,Ln,se,Mt,Se,qn,Re,Bn,L,zn,Ir,Wn,Ot,we,Gn,Hn,te,Jn,Yn,ne,Ut,Er,Xn,Kt,bt,Sr,Qn,wr,Ft,Zn,xr,eo,Pr,to,Z,ro,W,no,Tr,oo,ie=de(()=>{"use strict";ht=vr("shipment_status",["pending","in_transit","delayed","delivered","cancelled"]),ee=H("users",{id:X("id").primaryKey(),name:v("name").notNull(),email:v("email").notNull().unique(),password:v("password").notNull(),role:v("role").notNull().default("viewer"),companyId:U("company_id"),areaId:U("area_id"),lastLogin:j("last_login")}),Xe=Q(ee).omit({id:!0,lastLogin:!0}),Te=H("user_activation_tokens",{id:X("id").primaryKey(),token:v("token").notNull().unique(),email:v("email").notNull(),expiresAt:j("expires_at").notNull(),used:ye("used").default(!1),createdAt:j("created_at").defaultNow()}),On=Q(Te).omit({id:!0,createdAt:!0}),ue=H("companies",{id:X("id").primaryKey(),name:v("name").notNull(),description:v("description"),sector:v("sector"),logo:v("logo"),createdAt:j("created_at").defaultNow()}),_t=Q(ue).omit({id:!0,createdAt:!0}),J=H("areas",{id:X("id").primaryKey(),name:v("name").notNull(),description:v("description"),companyId:U("company_id").notNull()}),Dt=Q(J).omit({id:!0}),qe=H("kpis_dura",{id:X("id").primaryKey(),area:v("area").notNull(),kpiName:v("kpi_name").notNull(),description:v("description"),calculationMethod:v("calculation_method"),goal:v("goal"),unit:v("unit"),frequency:v("frequency"),source:v("source"),responsible:v("responsible"),period:v("period"),createdAt:j("created_at").defaultNow()}),Be=H("kpis_orsega",{id:X("id").primaryKey(),area:v("area").notNull(),kpiName:v("kpi_name").notNull(),description:v("description"),calculationMethod:v("calculation_method"),goal:v("goal"),unit:v("unit"),frequency:v("frequency"),source:v("source"),responsible:v("responsible"),period:v("period"),createdAt:j("created_at").defaultNow()}),Un=Q(qe).omit({id:!0,createdAt:!0}),Kn=Q(Be).omit({id:!0,createdAt:!0}),Qe=H("kpi_values_dura",{id:X("id").primaryKey(),kpi_id:U("kpi_id").notNull(),month:v("month").notNull(),year:U("year").notNull(),value:ge("value").notNull(),created_at:j("created_at").defaultNow()}),Ze=H("kpi_values_orsega",{id:X("id").primaryKey(),kpi_id:U("kpi_id").notNull(),month:v("month").notNull(),year:U("year").notNull(),value:ge("value").notNull(),created_at:j("created_at").defaultNow()}),ft=_.union([_.literal(1),_.literal(2)]),ot=_.union([_.string(),_.number()]).transform(a=>typeof a=="number"?a.toString():a),Rt=_.object({companyId:ft.optional(),areaId:_.number().int().positive().optional(),area:_.string().min(1,"El \xE1rea es requerida").optional(),name:_.string().min(1,"El nombre es requerido"),description:_.string().optional().nullable(),target:ot.optional(),goal:ot.optional(),unit:_.string().optional().nullable(),frequency:_.string().optional().nullable(),calculationMethod:_.string().optional().nullable(),responsible:_.string().optional().nullable(),source:_.string().optional().nullable(),period:_.string().optional().nullable()}).refine(a=>a.areaId!==void 0||!!a.area,{message:"Debe seleccionarse un \xE1rea v\xE1lida",path:["areaId"]}),br=_.object({companyId:ft.optional(),kpiId:_.number().int().positive(),value:ot,period:_.string().optional().nullable(),month:_.string().optional().nullable(),year:_.number().int().optional().nullable(),compliancePercentage:_.string().optional().nullable(),status:_.string().optional().nullable(),comments:_.string().optional().nullable(),updatedBy:_.number().int().optional().nullable()}),vt=br,Ae=H("action_plans",{id:X("id").primaryKey(),kpiId:U("kpi_id").notNull(),problemDescription:v("problem_description").notNull(),correctiveActions:v("corrective_actions").notNull(),responsible:v("responsible").notNull(),startDate:j("start_date").notNull(),endDate:j("end_date").notNull(),status:v("status").notNull(),results:v("results")}),Fn=Q(Ae).omit({id:!0}),kn=_.object({username:_.string().min(3,"El nombre de usuario debe tener al menos 3 caracteres"),password:_.string().min(6,"La contrase\xF1a debe tener al menos 6 caracteres")}),Vn=vt.extend({compliancePercentage:_.string().optional(),status:_.string().optional()}),jt=_.object({name:_.string().optional(),description:_.string().optional(),areaId:_.number().int().positive().optional(),area:_.string().optional(),companyId:ft.optional(),unit:_.string().optional(),target:ot.optional(),goal:ot.optional(),frequency:_.string().optional(),calculationMethod:_.string().optional(),responsible:_.string().optional(),source:_.string().optional(),period:_.string().optional(),invertedMetric:_.boolean().optional()}),Ln=Xe.extend({password:_.string().min(6,"La contrase\xF1a debe tener al menos 6 caracteres"),confirmPassword:_.string().min(6,"La contrase\xF1a debe tener al menos 6 caracteres")}).refine(a=>a.password===a.confirmPassword,{message:"Las contrase\xF1as no coinciden",path:["confirmPassword"]}),se=H("shipments",{id:X("id").primaryKey(),trackingCode:v("tracking_code").notNull().unique(),companyId:U("company_id").notNull(),customerId:U("customer_id"),customerName:v("customer_name").notNull(),purchaseOrder:v("purchase_order").notNull(),customerEmail:v("customer_email"),customerPhone:v("customer_phone"),invoiceNumber:v("invoice_number"),destination:v("destination").notNull(),origin:v("origin").notNull(),product:v("product").notNull(),quantity:v("quantity").notNull(),unit:v("unit").notNull(),departureDate:j("departure_date"),estimatedDeliveryDate:j("estimated_delivery_date"),actualDeliveryDate:j("actual_delivery_date"),status:ht("status").notNull().default("pending"),carrier:v("carrier"),vehicleInfo:v("vehicle_info"),vehicleType:v("vehicle_type"),fuelType:v("fuel_type"),distance:v("distance"),carbonFootprint:v("carbon_footprint"),driverName:v("driver_name"),driverPhone:v("driver_phone"),comments:v("comments"),createdAt:j("created_at").defaultNow(),updatedAt:j("updated_at").defaultNow(),destinationLat:ge("destination_lat"),destinationLng:ge("destination_lng"),originLat:ge("origin_lat"),originLng:ge("origin_lng"),purchaseOrderNumber:v("purchase_order_number"),notificationEmails:Le("notification_emails")}),Mt=Q(se).omit({id:!0,createdAt:!0,updatedAt:!0}),Se=H("shipment_items",{id:X("id").primaryKey(),shipmentId:U("shipment_id").notNull(),product:v("product").notNull(),quantity:v("quantity").notNull(),unit:v("unit").notNull(),description:v("description"),createdAt:j("created_at").defaultNow()}),qn=Q(Se).omit({id:!0,createdAt:!0}),Re=H("shipment_updates",{id:X("id").primaryKey(),shipmentId:U("shipment_id").notNull(),status:ht("status").notNull(),location:v("location"),comments:v("comments"),updatedBy:U("updated_by"),timestamp:j("timestamp").defaultNow()}),Bn=Q(Re).omit({id:!0,timestamp:!0}),L=H("notifications",{id:X("id").primaryKey(),title:v("title").notNull(),message:v("message").notNull(),type:v("type").notNull().default("info"),fromUserId:U("from_user_id").notNull(),toUserId:U("to_user_id"),companyId:U("company_id"),areaId:U("area_id"),priority:v("priority").notNull().default("normal"),read:ye("read").default(!1),createdAt:j("created_at").defaultNow(),readAt:j("read_at")}),zn=Q(L).omit({id:!0,createdAt:!0}),Ir=H("shipment_notifications",{id:X("id").primaryKey(),shipmentId:U("shipment_id").notNull(),emailTo:v("email_to").notNull(),subject:v("subject").notNull(),status:v("status").notNull(),sentAt:j("sent_at").defaultNow(),sentBy:U("sent_by").notNull(),shipmentStatus:ht("shipment_status").notNull(),errorMessage:v("error_message")}),Wn=Q(Ir).omit({id:!0,sentAt:!0}),Ot=_.object({status:_.enum(["pending","in_transit","delayed","delivered","cancelled"]),sendNotification:_.boolean().default(!0),comments:_.string().optional(),location:_.string().optional(),invoiceNumber:_.string().optional()}),we=H("job_profiles",{id:X("id").primaryKey(),areaId:U("area_id").notNull(),companyId:U("company_id").notNull(),title:v("title").notNull(),description:v("description").notNull(),mainActivities:Le("main_activities").notNull(),responsibilities:Le("responsibilities").notNull(),kpiInstructions:Le("kpi_instructions").notNull(),tips:Le("tips").notNull(),processes:Le("processes").notNull(),updateFrequency:Le("update_frequency").notNull(),createdAt:j("created_at").defaultNow(),updatedAt:j("updated_at").defaultNow()}),Gn=Q(we).omit({id:!0,createdAt:!0,updatedAt:!0}),Hn=_.object({id:_.number(),areaId:_.number(),companyId:_.number(),title:_.string(),description:_.string(),mainActivities:_.array(_.string()),responsibilities:_.array(_.string()),kpiInstructions:_.array(_.object({kpiName:_.string(),description:_.string(),updateFrequency:_.string(),instructions:_.string()})),tips:_.array(_.object({category:_.string(),tip:_.string()})),processes:_.array(_.object({name:_.string(),description:_.string(),steps:_.array(_.string())})),updateFrequency:_.object({daily:_.array(_.string()),weekly:_.array(_.string()),monthly:_.array(_.string())}),areaName:_.string(),companyName:_.string(),userKpis:_.array(_.object({id:_.number(),name:_.string(),target:_.string(),frequency:_.string()}))}),te=H("shipment_cycle_times",{id:X("id").primaryKey(),shipmentId:U("shipment_id").notNull().unique(),companyId:U("company_id").notNull(),createdAt:j("created_at").notNull(),pendingAt:j("pending_at"),inTransitAt:j("in_transit_at"),deliveredAt:j("delivered_at"),closedAt:j("closed_at"),hoursPendingToTransit:v("hours_pending_to_transit"),hoursTransitToDelivered:v("hours_transit_to_delivered"),hoursDeliveredToClosed:v("hours_delivered_to_closed"),hoursTotalCycle:v("hours_total_cycle"),hoursToDelivery:v("hours_to_delivery"),computedAt:j("computed_at").defaultNow(),updatedAt:j("updated_at").defaultNow()}),Jn=Q(te).omit({id:!0,computedAt:!0,updatedAt:!0}),Yn=_.object({period:_.string(),startDate:_.string(),endDate:_.string(),companyId:_.number().optional(),avgPendingToTransit:_.number().nullable(),avgTransitToDelivered:_.number().nullable(),avgDeliveredToClosed:_.number().nullable(),avgTotalCycle:_.number().nullable(),avgToDelivery:_.number().nullable(),totalShipments:_.number(),completedShipments:_.number()}),ne=H("clients",{id:X("id").primaryKey(),name:v("name").notNull(),email:v("email").notNull(),phone:v("phone"),contactPerson:v("contact_person"),company:v("company"),address:v("address"),paymentTerms:U("payment_terms"),createdAt:j("created_at").defaultNow(),updatedAt:j("updated_at").defaultNow(),requiresReceipt:ye("requires_receipt").default(!0),reminderFrequency:U("reminder_frequency"),isActive:ye("is_active").default(!0),notes:v("notes"),companyId:U("company_id"),clientCode:v("client_code"),secondaryEmail:v("secondary_email"),city:v("city"),state:v("state"),postalCode:v("postal_code"),country:v("country").default("M\xE9xico"),emailNotifications:ye("email_notifications").default(!0),customerType:v("customer_type"),requiresPaymentComplement:ye("requires_payment_complement").default(!1)}),Ut=Q(ne).omit({id:!0,createdAt:!0,updatedAt:!0}),Er=H("provider",{id:jn("id").primaryKey().default(Mn`gen_random_uuid()`),name:v("name").notNull(),email:v("email"),phone:v("phone"),contactName:v("contact_name"),notes:v("notes"),rating:ge("rating"),isActive:ye("is_active").notNull().default(!0),shortName:v("short_name"),companyId:U("company_id"),location:v("location"),requiresRep:ye("requires_rep").default(!1),repFrequency:U("rep_frequency"),reminderEmail:v("reminder_email"),createdAt:j("created_at").notNull().defaultNow(),updatedAt:j("updated_at").notNull().defaultNow()}),Xn=Q(Er).omit({id:!0,createdAt:!0,updatedAt:!0}),Kt=H("suppliers",{id:X("id").primaryKey(),name:v("name").notNull(),shortName:v("short_name"),email:v("email"),location:v("location"),requiresRep:ye("requires_rep").default(!1),repFrequency:U("rep_frequency"),companyId:U("company_id"),isActive:ye("is_active").default(!0),notes:v("notes"),createdAt:j("created_at").defaultNow(),updatedAt:j("updated_at").defaultNow()}),bt=Q(Kt).omit({id:!0,createdAt:!0,updatedAt:!0}),Sr=H("products",{id:X("id").primaryKey(),name:v("name").notNull(),companyId:U("company_id").notNull(),isActive:ye("is_active").notNull().default(!0),createdAt:j("created_at").notNull().defaultNow(),updatedAt:j("updated_at").notNull().defaultNow()}),Qn=Q(Sr).omit({id:!0,createdAt:!0,updatedAt:!0}),wr=vr("voucher_status",["pendiente_validacion","validado","pendiente_asociacion","pendiente_complemento","complemento_recibido","cerrado","cierre_contable"]),Ft=H("scheduled_payments",{id:X("id").primaryKey(),companyId:U("company_id").notNull(),supplierId:U("supplier_id").references(()=>Kt.id),supplierName:v("supplier_name"),amount:ge("amount").notNull(),currency:v("currency").notNull().default("MXN"),dueDate:j("due_date").notNull(),status:v("status").notNull().default("idrall_imported"),reference:v("reference"),notes:v("notes"),sourceType:v("source_type").default("manual"),hydralFileUrl:v("hydral_file_url"),hydralFileName:v("hydral_file_name"),approvedAt:j("approved_at"),approvedBy:U("approved_by"),paymentScheduledAt:j("payment_scheduled_at"),paidAt:j("paid_at"),paidBy:U("paid_by"),voucherId:U("voucher_id").references(()=>W.id),createdBy:U("created_by").notNull(),createdAt:j("created_at").notNull().defaultNow(),updatedAt:j("updated_at").notNull().defaultNow()}),Zn=Q(Ft).omit({id:!0,createdAt:!0,updatedAt:!0}),xr=H("payment_receipts",{id:X("id").primaryKey(),paymentId:U("payment_id").references(()=>Ft.id,{onDelete:"cascade"}),fileName:v("file_name").notNull(),fileUrl:v("file_url").notNull(),fileType:v("file_type").notNull(),uploadedBy:U("uploaded_by").notNull(),uploadedAt:j("uploaded_at").notNull().defaultNow(),sentTo:v("sent_to").array(),sentAt:j("sent_at")}),eo=Q(xr).omit({id:!0,uploadedAt:!0}),Pr=H("payment_complements",{id:X("id").primaryKey(),companyId:U("company_id").notNull(),clientName:v("client_name").notNull(),invoiceReference:v("invoice_reference").notNull(),amount:ge("amount").notNull(),currency:v("currency").notNull().default("MXN"),complementUrl:v("complement_url"),status:v("status").notNull().default("pending"),generatedAt:j("generated_at"),sentAt:j("sent_at"),createdBy:U("created_by").notNull(),createdAt:j("created_at").notNull().defaultNow()}),to=Q(Pr).omit({id:!0,createdAt:!0}),Z=H("exchange_rates",{id:X("id").primaryKey(),date:j("date").notNull().defaultNow(),buyRate:ge("buy_rate").notNull(),sellRate:ge("sell_rate").notNull(),source:v("source"),notes:v("notes"),createdBy:U("created_by").notNull(),createdAt:j("created_at").notNull().defaultNow()}),ro=Q(Z).omit({id:!0,createdAt:!0}),W=H("payment_vouchers",{id:X("id").primaryKey(),companyId:U("company_id").notNull(),payerCompanyId:U("payer_company_id").notNull(),clientId:U("client_id").notNull(),clientName:v("client_name").notNull(),scheduledPaymentId:U("scheduled_payment_id"),status:wr("status").notNull().default("pendiente_validacion"),voucherFileUrl:v("voucher_file_url").notNull(),voucherFileName:v("voucher_file_name").notNull(),voucherFileType:v("voucher_file_type").notNull(),invoiceFileUrl:v("invoice_file_url"),invoiceFileName:v("invoice_file_name"),invoiceFileType:v("invoice_file_type"),complementFileUrl:v("complement_file_url"),complementFileName:v("complement_file_name"),complementFileType:v("complement_file_type"),extractedAmount:ge("extracted_amount"),extractedDate:j("extracted_date"),extractedBank:v("extracted_bank"),extractedReference:v("extracted_reference"),extractedCurrency:v("extracted_currency"),extractedOriginAccount:v("extracted_origin_account"),extractedDestinationAccount:v("extracted_destination_account"),extractedTrackingKey:v("extracted_tracking_key"),extractedBeneficiaryName:v("extracted_beneficiary_name"),ocrConfidence:ge("ocr_confidence"),notify:ye("notify").default(!1),emailTo:v("email_to").array(),emailCc:v("email_cc").array(),emailMessage:v("email_message"),linkedInvoiceId:U("linked_invoice_id"),linkedInvoiceUuid:v("linked_invoice_uuid"),notes:v("notes"),uploadedBy:U("uploaded_by").notNull(),createdAt:j("created_at").notNull().defaultNow(),updatedAt:j("updated_at").notNull().defaultNow(),lastReminderSent:j("last_reminder_sent"),reminderCount:U("reminder_count").default(0)}),no=Q(W).omit({id:!0,createdAt:!0,updatedAt:!0}),Tr=H("email_outbox",{id:X("id").primaryKey(),voucherId:U("voucher_id").references(()=>W.id,{onDelete:"cascade"}),emailTo:v("email_to").notNull().array(),emailCc:v("email_cc").array(),subject:v("subject").notNull(),htmlContent:v("html_content").notNull(),status:v("status").notNull().default("pending"),messageId:v("message_id"),errorMessage:v("error_message"),sentAt:j("sent_at"),createdAt:j("created_at").notNull().defaultNow(),updatedAt:j("updated_at").notNull().defaultNow()}),oo=Q(Tr).omit({id:!0,createdAt:!0,updatedAt:!0})});var Ke={};pe(Ke,{db:()=>P,pool:()=>Ar});import{Pool as ao,neonConfig as so}from"@neondatabase/serverless";import{drizzle as io}from"drizzle-orm/neon-serverless";import co from"ws";var Ar,P,le=de(()=>{"use strict";ie();so.webSocketConstructor=co;if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL must be set. Did you forget to provision a database?");Ar=new ao({connectionString:process.env.DATABASE_URL}),P=io({client:Ar,schema:Ne})});import{eq as R,and as ze,desc as je,sql as at}from"drizzle-orm";var st,ha,Nr=de(()=>{"use strict";ie();le();st=class{constructor(){}resolveCompany(r){if(r===1||r===2)return r;throw new Error(`Unsupported companyId ${r}. Use 1 for Dura or 2 for Orsega.`)}getKpiTable(r){return r===1?qe:Be}getKpiValuesTable(r){return r===1?Qe:Ze}async getCompanyAreaMap(r){let e=await P.select().from(J).where(R(J.companyId,r)),o=new Map;for(let c of e)o.set(c.name.trim().toLowerCase(),c);return o}normalizeAreaName(r){return r?r.trim().toLowerCase():null}async findCompanyForKpiId(r){let[e]=await P.select({id:qe.id}).from(qe).where(R(qe.id,r)).limit(1);if(e)return 1;let[o]=await P.select({id:Be.id}).from(Be).where(R(Be.id,r)).limit(1);if(o)return 2}async findCompanyForKpiValueId(r){let[e]=await P.select({id:Qe.id}).from(Qe).where(R(Qe.id,r)).limit(1);if(e)return 1;let[o]=await P.select({id:Ze.id}).from(Ze).where(R(Ze.id,r)).limit(1);if(o)return 2}mapKpiRecord(r,e,o){let c=this.normalizeAreaName(r.area),l=c?o.get(c):void 0;return{id:r.id,area:l?.name??r.area??null,kpiName:r.kpiName,name:r.kpiName,description:r.description??null,calculationMethod:r.calculationMethod??null,goal:r.goal??null,target:r.goal??null,unit:r.unit??null,frequency:r.frequency??null,source:r.source??null,responsible:r.responsible??null,period:r.period??null,createdAt:r.createdAt??null,companyId:e,areaId:l?.id??null}}mapKpiValueRecord(r,e){let o=r.month&&r.year?`${r.month.charAt(0).toUpperCase()}${r.month.slice(1).toLowerCase()} ${r.year}`:null;return{id:r.id,kpiId:r.kpi_id,value:r.value?.toString()??"0",period:o,date:r.created_at??new Date,compliancePercentage:null,status:null,comments:null,updatedBy:null,month:r.month??null,year:r.year??null,companyId:e}}async getCompanyKpisNormalized(r){let e=this.resolveCompany(r),o=this.getKpiTable(e),c=await this.getCompanyAreaMap(e);return(await P.select().from(o)).map(p=>this.mapKpiRecord(p,e,c))}async getAllCompanyKpisNormalized(){let r=await this.getCompanyKpisNormalized(1),e=await this.getCompanyKpisNormalized(2);return[...r,...e]}async getCompanyKpiNormalized(r,e){let o=this.resolveCompany(r),c=this.getKpiTable(o),l=await this.getCompanyAreaMap(o),p=await P.select().from(c).where(R(c.id,e)).limit(1);if(p.length!==0)return this.mapKpiRecord(p[0],o,l)}async getCompanyKpiValuesNormalized(r){let e=this.resolveCompany(r),o=this.getKpiValuesTable(e);return(await P.select().from(o)).map(l=>this.mapKpiValueRecord(l,e))}async getCompanyKpiValuesByKpiNormalized(r,e){let o=this.resolveCompany(r),c=this.getKpiValuesTable(o);return(await P.select().from(c).where(R(c.kpi_id,e)).orderBy(je(c.year),je(c.created_at)).limit(12)).map(h=>this.mapKpiValueRecord(h,o))}async upsertCompanyKpiValueNormalized(r,e){let o=this.resolveCompany(r),c=this.getKpiValuesTable(o),l=e.month.toUpperCase(),p=await P.select().from(c).where(ze(R(c.kpi_id,e.kpiId),R(c.month,l),R(c.year,e.year))).limit(1);if(p.length>0){let[b]=await P.update(c).set({value:e.value,created_at:new Date}).where(R(c.id,p[0].id)).returning();return this.mapKpiValueRecord(b,o)}let[h]=await P.insert(c).values({kpi_id:e.kpiId,month:l,year:e.year,value:e.value,created_at:new Date}).returning();return this.mapKpiValueRecord(h,o)}async getUser(r){try{let[e]=await P.select().from(ee).where(R(ee.id,r));return e}catch(e){console.error("Error getting user:",e);return}}async getUserByEmail(r){try{let e=r.toLowerCase(),[o]=await P.select().from(ee).where(at`LOWER(${ee.email}) = ${e}`);return o}catch(e){console.error("Error getting user by email:",e);return}}async getUserByUsername(r){try{if(r.includes("@")){let o=r.toLowerCase(),[c]=await P.select().from(ee).where(at`LOWER(${ee.email}) = ${o}`);return c}return(await P.select().from(ee)).find(o=>{let c=o.email.toLowerCase().split("@");return c.length>0&&c[0]===r.toLowerCase()})}catch(e){console.error("Error getting user by username:",e);return}}async createUser(r){try{let[e]=await P.insert(ee).values(r).returning();return e}catch(e){throw console.error("Error creating user:",e),e}}async updateUser(r,e){try{let[o]=await P.update(ee).set(e).where(R(ee.id,r)).returning();return o}catch(o){console.error("Error updating user:",o);return}}async getUsers(){try{return await P.select().from(ee)}catch(r){return console.error("Error getting users:",r),[]}}async deleteUser(r){try{let e=await P.delete(ee).where(R(ee.id,r));return e.rowCount!==null&&e.rowCount>0}catch(e){return console.error("Error deleting user:",e),!1}}async getCompany(r){try{let[e]=await P.select().from(ue).where(R(ue.id,r));return e}catch(e){console.error("Error getting company:",e);return}}async getCompanies(){try{return await P.select().from(ue)}catch(r){return console.error("Error getting companies:",r),[]}}async createCompany(r){try{let[e]=await P.insert(ue).values(r).returning();return e}catch(e){throw console.error("Error creating company:",e),e}}async updateCompany(r,e){try{let[o]=await P.update(ue).set(e).where(R(ue.id,r)).returning();return o}catch(o){console.error("Error updating company:",o);return}}async getArea(r){try{let[e]=await P.select().from(J).where(R(J.id,r));return e}catch(e){console.error("Error getting area:",e);return}}async getAreas(){try{return await P.select().from(J)}catch(r){return console.error("Error getting areas:",r),[]}}async getAreasByCompany(r){try{return await P.select().from(J).where(R(J.companyId,r))}catch(e){return console.error("Error getting areas by company:",e),[]}}async createArea(r){try{let[e]=await P.insert(J).values(r).returning();return e}catch(e){throw console.error("Error creating area:",e),e}}async updateArea(r,e){try{let[o]=await P.update(J).set(e).where(R(J.id,r)).returning();return o}catch(o){console.error("Error updating area:",o);return}}async getKpi(r,e){try{let o=this.resolveCompany(e),c=this.getKpiTable(o),l=await this.getCompanyAreaMap(o),[p]=await P.select().from(c).where(R(c.id,r)).limit(1);return p?this.mapKpiRecord(p,o,l):void 0}catch(o){console.error("Error getting KPI:",o);return}}async getKpis(r){try{return typeof r=="number"?await this.getCompanyKpisNormalized(r):await this.getAllCompanyKpisNormalized()}catch(e){return console.error("Error getting KPIs:",e),[]}}async getKpisByCompany(r){try{return await this.getCompanyKpisNormalized(r)}catch(e){return console.error("Error getting KPIs by company:",e),[]}}async getKpisByArea(r){try{let[e]=await P.select().from(J).where(R(J.id,r)).limit(1);if(!e)return[];let o=this.resolveCompany(e.companyId),c=this.getKpiTable(o),l=await this.getCompanyAreaMap(o),p=this.normalizeAreaName(e.name);return(await P.select().from(c)).filter(b=>this.normalizeAreaName(b.area)===p).map(b=>this.mapKpiRecord(b,o,l))}catch(e){return console.error("Error getting KPIs by area:",e),[]}}async getKpisByCompanyAndArea(r,e){try{let o=this.resolveCompany(r),[c]=await P.select().from(J).where(R(J.id,e)).limit(1);if(!c||this.resolveCompany(c.companyId)!==o)return[];let l=this.getKpiTable(o),p=await this.getCompanyAreaMap(o),h=this.normalizeAreaName(c.name);return(await P.select().from(l)).filter(T=>this.normalizeAreaName(T.area)===h).map(T=>this.mapKpiRecord(T,o,p))}catch(o){return console.error("Error getting KPIs by company and area:",o),[]}}async createKpi(r){try{let e=this.resolveCompany(r.companyId),o=this.getKpiTable(e),c;if(r.areaId){let[T]=await P.select().from(J).where(R(J.id,r.areaId)).limit(1);if(!T)throw new Error(`Area with id ${r.areaId} not found`);if(this.resolveCompany(T.companyId)!==e)throw new Error(`La \xE1rea ${T.id} pertenece a otra compa\xF1\xEDa`);c=T}let l=(c?.name??r.area)?.trim();if(!l)throw new Error("Debe especificarse un \xE1rea v\xE1lida para el KPI");let p={area:l,kpiName:r.name,description:r.description??null,calculationMethod:r.calculationMethod??null,goal:r.goal??r.target??null,unit:r.unit??null,frequency:r.frequency??null,source:r.source??null,responsible:r.responsible??null,period:r.period??null},[h]=await P.insert(o).values(p).returning(),b=await this.getCompanyAreaMap(e);return this.mapKpiRecord(h,e,b)}catch(e){throw console.error("Error creating KPI:",e),e}}async updateKpi(r,e){try{let o=e.companyId??await this.findCompanyForKpiId(r);if(!o){console.warn(`[DatabaseStorage] No se encontr\xF3 compa\xF1\xEDa para KPI ${r}`);return}let c=this.resolveCompany(o),l=this.getKpiTable(c),p={};if(e.name!==void 0&&(p.kpiName=e.name),e.description!==void 0&&(p.description=e.description),e.calculationMethod!==void 0&&(p.calculationMethod=e.calculationMethod),(e.target!==void 0||e.goal!==void 0)&&(p.goal=e.goal??e.target),e.unit!==void 0&&(p.unit=e.unit),e.frequency!==void 0&&(p.frequency=e.frequency),e.source!==void 0&&(p.source=e.source),e.responsible!==void 0&&(p.responsible=e.responsible),e.period!==void 0&&(p.period=e.period),e.areaId!==void 0||e.area!==void 0){let T=e.area;if(e.areaId!==void 0){let[i]=await P.select().from(J).where(R(J.id,e.areaId)).limit(1);if(!i)throw new Error(`Area with id ${e.areaId} not found`);if(this.resolveCompany(i.companyId)!==c)throw new Error(`La \xE1rea ${i.id} pertenece a otra compa\xF1\xEDa`);T=i.name}T&&(p.area=T)}if(Object.keys(p).length===0)return await this.getKpi(r,c);let[h]=await P.update(l).set(p).where(R(l.id,r)).returning();if(!h)return;let b=await this.getCompanyAreaMap(c);return this.mapKpiRecord(h,c,b)}catch(o){console.error("Error updating KPI:",o);return}}async deleteKpi(r,e){try{let o=this.resolveCompany(e),c=this.getKpiValuesTable(o);await P.delete(c).where(R(c.kpi_id,r));let l=this.getKpiTable(o);return((await P.delete(l).where(R(l.id,r))).rowCount??0)>0}catch(o){return console.error("Error deleting KPI:",o),!1}}async getKpiValue(r,e){try{let o;if(e!==void 0?o=this.resolveCompany(e):o=await this.findCompanyForKpiValueId(r),!o)return;let c=this.getKpiValuesTable(o),[l]=await P.select().from(c).where(R(c.id,r)).limit(1);return l?this.mapKpiValueRecord(l,o):void 0}catch(o){console.error("Error getting KPI value:",o);return}}async getKpiValues(r){try{if(typeof r=="number")return await this.getCompanyKpiValuesNormalized(r);let e=await this.getCompanyKpiValuesNormalized(1),o=await this.getCompanyKpiValuesNormalized(2);return[...e,...o]}catch(e){return console.error("Error getting KPI values:",e),[]}}async getKpiValuesByKpi(r,e){try{return await this.getCompanyKpiValuesByKpiNormalized(e,r)}catch(o){return console.error("Error getting KPI values by KPI:",o),[]}}async getKpiValuesByUser(r){return[]}async deleteKpiValuesByUser(r,e){return!1}async getLatestKpiValues(r,e,o){try{return(await this.getCompanyKpiValuesByKpiNormalized(o,r)).slice(0,e)}catch(c){return console.error("Error getting latest KPI values:",c),[]}}extractMonthYear(r){if(r.month&&r.year)return{month:r.month.toUpperCase(),year:r.year};if(r.period){let l=r.period.trim().split(/[\s/-]+/),p=parseInt(l[l.length-1],10);if(!Number.isFinite(p))throw new Error(`No se pudo determinar el a\xF1o a partir del periodo "${r.period}"`);let h=l.slice(0,-1).join(" ");if(!h)throw new Error(`No se pudo determinar el mes a partir del periodo "${r.period}"`);return{month:h.toUpperCase(),year:p}}let e=new Date,o=e.toLocaleString("es-MX",{month:"long"}).toUpperCase(),c=e.getFullYear();return{month:o,year:c}}async createKpiValue(r){try{let e=r.companyId??await this.findCompanyForKpiId(r.kpiId);if(!e)throw new Error(`Unable to determine company for KPI ${r.kpiId}`);let o=this.resolveCompany(e),{month:c,year:l}=this.extractMonthYear(r),p=typeof r.value=="string"?parseFloat(r.value):Number(r.value);if(!Number.isFinite(p))throw new Error(`El valor del KPI debe ser num\xE9rico. Recibido: ${r.value}`);return await this.upsertCompanyKpiValueNormalized(o,{kpiId:r.kpiId,month:c,year:l,value:p,compliancePercentage:r.compliancePercentage??null,status:r.status??null,comments:r.comments??null,updatedBy:r.updatedBy??null})}catch(e){throw console.error("Error creating KPI value:",e),e}}async getActionPlan(r){try{let[e]=await P.select().from(Ae).where(R(Ae.id,r));return e}catch(e){console.error("Error getting action plan:",e);return}}async getActionPlansByKpi(r){try{return await P.select().from(Ae).where(R(Ae.kpiId,r))}catch(e){return console.error("Error getting action plans by KPI:",e),[]}}async createActionPlan(r){try{let[e]=await P.insert(Ae).values(r).returning();return e}catch(e){throw console.error("Error creating action plan:",e),e}}async updateActionPlan(r,e){try{let[o]=await P.update(Ae).set(e).where(R(Ae.id,r)).returning();return o}catch(o){console.error("Error updating action plan:",o);return}}async getShipment(r){try{let[e]=await P.select().from(se).where(R(se.id,r));return e}catch(e){console.error("Error getting shipment:",e);return}}async getShipmentByTrackingCode(r){try{let[e]=await P.select().from(se).where(R(se.trackingCode,r));return e}catch(e){console.error("Error getting shipment by tracking code:",e);return}}async getShipments(){try{let r=await P.select().from(se);return await Promise.all(r.map(async o=>{let c=await this.getShipmentItems(o.id);return{...await this.enrichShipmentWithCycleTimes(o),items:c}}))}catch(r){return console.error("Error getting shipments:",r),[]}}async getShipmentsByCompany(r){try{let e=await P.select().from(se).where(R(se.companyId,r));return await Promise.all(e.map(async c=>{let l=await this.getShipmentItems(c.id);return{...await this.enrichShipmentWithCycleTimes(c),items:l}}))}catch(e){return console.error("Error getting shipments by company:",e),[]}}async createShipment(r){try{let[e]=await P.insert(se).values(r).returning();return e}catch(e){throw console.error("Error creating shipment:",e),e}}async updateShipment(r,e){try{let[o]=await P.update(se).set({...e,updatedAt:new Date}).where(R(se.id,r)).returning();return o}catch(o){console.error("Error updating shipment:",o);return}}async getShipmentItems(r){try{return await P.select().from(Se).where(R(Se.shipmentId,r))}catch(e){return console.error("Error getting shipment items:",e),[]}}async createShipmentItem(r){try{let[e]=await P.insert(Se).values(r).returning();return e}catch(e){throw console.error("Error creating shipment item:",e),e}}async createShipmentItems(r){try{return r.length===0?[]:await P.insert(Se).values(r).returning()}catch(e){throw console.error("Error creating shipment items:",e),e}}async updateShipmentItem(r,e){try{let[o]=await P.update(Se).set(e).where(R(Se.id,r)).returning();return o}catch(o){console.error("Error updating shipment item:",o);return}}async deleteShipmentItem(r){try{return await P.delete(Se).where(R(Se.id,r)),!0}catch(e){return console.error("Error deleting shipment item:",e),!1}}async getShipmentUpdate(r){try{let[e]=await P.select().from(Re).where(R(Re.id,r));return e}catch(e){console.error("Error getting shipment update:",e);return}}async getShipmentUpdates(r){try{return await P.select().from(Re).where(R(Re.shipmentId,r)).orderBy(je(Re.timestamp))}catch(e){return console.error("Error getting shipment updates:",e),[]}}async createShipmentUpdate(r){try{let[e]=await P.insert(Re).values(r).returning();return e}catch(e){throw console.error("Error creating shipment update:",e),e}}async getNotification(r){try{let[e]=await P.select().from(L).where(R(L.id,r));return e}catch(e){console.error("Error getting notification:",e);return}}async getNotificationsForUser(r){try{return await P.select({id:L.id,title:L.title,message:L.message,type:L.type,priority:L.priority,read:L.read,createdAt:L.createdAt,readAt:L.readAt,fromUserId:L.fromUserId,toUserId:L.toUserId,fromUserName:ee.name,fromUserEmail:ee.email}).from(L).leftJoin(ee,R(L.fromUserId,ee.id)).where(R(L.toUserId,r)).orderBy(je(L.createdAt))}catch(e){return console.error("Error getting notifications for user:",e),[]}}async createNotification(r){try{let[e]=await P.insert(L).values(r).returning();return e}catch(e){throw console.error("Error creating notification:",e),e}}async markNotificationAsRead(r,e){try{let[o]=await P.update(L).set({read:!0,readAt:new Date}).where(ze(R(L.id,r),R(L.toUserId,e))).returning();return o}catch(o){console.error("Error marking notification as read:",o);return}}async deleteNotification(r,e){try{return((await P.delete(L).where(ze(R(L.id,r),R(L.toUserId,e)))).rowCount??0)>0}catch(o){return console.error("Error deleting notification:",o),!1}}async getLastKpiUpdateByUser(r){}async getTeamActivitySummary(){try{let r=await P.select().from(ee),e=[];for(let o of r){let c=await this.getLastKpiUpdateByUser(o.id);e.push({userId:o.id,lastLogin:o.lastLogin,lastKpiUpdate:c||null})}return e}catch(r){return console.error("Error getting team activity summary:",r),[]}}async getJobProfile(r){try{let[e]=await P.select().from(we).where(R(we.id,r));return e}catch(e){console.error("Error getting job profile:",e);return}}async getJobProfileByUserArea(r,e){try{let[o]=await P.select().from(we).where(ze(R(we.areaId,r),R(we.companyId,e)));return o}catch(o){console.error("Error getting job profile by area:",o);return}}async getJobProfileWithDetails(r){try{console.log(`[JobProfile] Getting profile for user ID: ${r}`);let e=await this.getUser(r);if(console.log("[JobProfile] User found:",e),!e||!e.areaId||!e.companyId){console.log(`[JobProfile] User or area/company missing for user ${r}`);return}let o=await this.getJobProfileByUserArea(e.areaId,e.companyId);if(console.log("[JobProfile] Profile found:",o),!o){console.log(`[JobProfile] No profile found for area ${e.areaId}, company ${e.companyId}`);return}let c=await this.getArea(e.areaId),l=await this.getCompany(e.companyId),p=await this.getUserKpis(r),h={id:o.id,areaId:o.areaId,companyId:o.companyId,title:o.title,description:o.description,mainActivities:o.mainActivities,responsibilities:o.responsibilities,kpiInstructions:o.kpiInstructions,tips:o.tips,processes:o.processes,updateFrequency:o.updateFrequency,areaName:c?.name||"",companyName:l?.name||"",userKpis:p.map(b=>({id:b.id,name:b.name,target:b.target,frequency:b.frequency}))};return console.log("[JobProfile] Returning profile with details:",h),h}catch(e){console.error("Error getting job profile with details:",e);return}}async createJobProfile(r){try{let[e]=await P.insert(we).values(r).returning();return e}catch(e){throw console.error("Error creating job profile:",e),e}}async updateJobProfile(r,e){try{let[o]=await P.update(we).set(e).where(R(we.id,r)).returning();return o}catch(o){console.error("Error updating job profile:",o);return}}async getUserKpis(r){try{let e=await this.getUser(r);return!e||!e.areaId||!e.companyId?[]:(await this.getCompanyKpisNormalized(e.companyId)).filter(c=>c.areaId===e.areaId)}catch(e){return console.error("Error getting user KPIs:",e),[]}}async getKPIOverview(){try{let[r,e,o]=await Promise.all([P.select().from(ee),P.select().from(J),P.select().from(ue)]),c=r.filter(s=>s.areaId!==null&&s.areaId!==void 0&&s.companyId!==null&&s.companyId!==void 0),l=new Map(e.map(s=>[s.id,s])),p=new Map(o.map(s=>[s.id,s])),h=Array.from(new Set(c.map(s=>s.companyId).filter(s=>typeof s=="number"))),b=new Map,T=new Map;for(let s of h)try{let d=this.resolveCompany(s),u=await this.getCompanyKpisNormalized(d);b.set(s,u);let g=await this.getCompanyKpiValuesNormalized(d);T.set(s,g)}catch(d){console.warn(`[getKPIOverview] Company ${s} skipped: ${d.message}`)}let i=new Map;for(let[s,d]of T.entries())for(let u of d){let g=`${s}-${u.kpiId}`,y=i.get(g),m=u.date?new Date(u.date):null,f=y?.date?new Date(y.date):null;(!y||m&&f&&m>f)&&i.set(g,u)}let n=s=>{if(!s)return NaN;let d=s.replace(/[^\d.-]/g,"");return parseFloat(d)},t=[];for(let s of c){let d=s.areaId?l.get(s.areaId):void 0,u=s.companyId?p.get(s.companyId):void 0;if(!d||!u)continue;let y=(b.get(s.companyId)??[]).filter(m=>m.areaId===s.areaId);for(let m of y){let f=`${s.companyId}-${m.id}`,I=i.get(f),E=m.target??m.goal??null,N=I?.value??null,C=I?.date??null,A="non-compliant",w=n(E),S=n(N);!isNaN(w)&&!isNaN(S)?this.isLowerBetterKPI(m.name)?S<=w?A="compliant":S<=w*1.1?A="alert":A="non-compliant":S>=w?A="compliant":S>=w*.9?A="alert":A="non-compliant":N&&(A="alert"),t.push({userId:s.id,userName:s.name,userEmail:s.email,areaName:d.name,companyName:u.name,kpiId:m.id,kpiName:m.name,kpiTarget:E,kpiFrequency:m.frequency,kpiValue:N,lastUpdate:C,status:A,trend:"stable"})}}return t}catch(r){return console.error("Error getting KPI overview:",r),[]}}isLowerBetterKPI(r){let e=["d\xEDas de cobro","d\xEDas de pago","tiempo de entrega","huella de carbono","costos","gastos","tiempo de respuesta","defectos","errores","quejas","devoluciones","rotaci\xF3n","tiempo de inactividad"],o=r.toLowerCase();return e.some(c=>o.includes(c))}async getKPIHistory(r,e=12,o){try{let c=typeof o=="number"?this.resolveCompany(o):await this.findCompanyForKpiId(r);return c?(await this.getCompanyKpiValuesByKpiNormalized(c,r)).slice(0,e):[]}catch(c){return console.error("[getKPIHistory] Error getting KPI history:",c),[]}}async getUserKPIHistory(r,e=6){return[]}async getKPIHistoryByUsers(r,e=6){try{let o=await this.findCompanyForKpiId(r);if(!o)return null;let c=await this.getCompanyKpiNormalized(o,r);return c?{kpi:c,users:[]}:null}catch(o){return console.error("Error getting KPI history by users:",o),null}}async getShipmentCycleTime(r){try{let[e]=await P.select().from(te).where(R(te.shipmentId,r));return e}catch(e){console.error("Error getting shipment cycle time:",e);return}}async enrichShipmentWithCycleTimes(r){try{let e=await this.getShipmentCycleTime(r.id);return e?{...r,cycleTimes:{hoursTotalCycle:e.hoursTotalCycle,hoursPendingToTransit:e.hoursPendingToTransit,hoursTransitToDelivered:e.hoursTransitToDelivered,hoursDeliveredToClosed:e.hoursDeliveredToClosed,hoursToDelivery:e.hoursToDelivery,computedAt:e.computedAt||void 0,updatedAt:e.updatedAt||void 0}}:{...r,cycleTimes:null}}catch(e){return console.error("Error enriching shipment with cycle times:",e),{...r,cycleTimes:null}}}async upsertShipmentCycleTime(r){try{let[e]=await P.select().from(te).where(R(te.shipmentId,r.shipmentId));if(e){let[o]=await P.update(te).set({...r,updatedAt:new Date}).where(R(te.shipmentId,r.shipmentId)).returning();return o}else{let[o]=await P.insert(te).values(r).returning();return o}}catch(e){throw console.error("Error upserting shipment cycle time:",e),e}}async recalculateShipmentCycleTime(r){try{let e=await this.getShipment(r);if(!e)return;let o=await this.getShipmentUpdates(r),c=null,l=null,p=null,h=null;for(let u of o.reverse())switch(u.status){case"pending":c||(c=u.timestamp);break;case"in_transit":l||(l=u.timestamp);break;case"delivered":p||(p=u.timestamp);break;case"cancelled":h||(h=u.timestamp);break}let b=(u,g)=>!u||!g?null:((g.getTime()-u.getTime())/(1e3*60*60)).toFixed(2),T=b(c,l),i=b(l,p),n=b(p,h),t=b(e.createdAt,h),s=b(e.createdAt,p),d={shipmentId:e.id,companyId:e.companyId,createdAt:e.createdAt,pendingAt:c,inTransitAt:l,deliveredAt:p,closedAt:h,hoursPendingToTransit:T,hoursTransitToDelivered:i,hoursDeliveredToClosed:n,hoursTotalCycle:t,hoursToDelivery:s};return await this.upsertShipmentCycleTime(d)}catch(e){console.error("Error recalculating shipment cycle time:",e);return}}async getAggregateCycleTimes(r,e,o){try{let c=P.select({hoursPendingToTransit:te.hoursPendingToTransit,hoursTransitToDelivered:te.hoursTransitToDelivered,hoursDeliveredToClosed:te.hoursDeliveredToClosed,hoursTotalCycle:te.hoursTotalCycle,hoursToDelivery:te.hoursToDelivery,closedAt:te.closedAt,createdAt:te.createdAt,companyId:te.companyId}).from(te),l=[];if(r&&l.push(R(te.companyId,r)),e&&o){let d=new Date(e),u=new Date(o);l.push(at`${te.createdAt} >= ${d} AND ${te.createdAt} <= ${u}`)}l.length>0&&(c=c.where(ze(...l)));let p=await c;if(p.length===0)return[{period:"all",startDate:e||"",endDate:o||"",companyId:r,avgPendingToTransit:null,avgTransitToDelivered:null,avgDeliveredToClosed:null,avgTotalCycle:null,avgToDelivery:null,totalShipments:0,completedShipments:0}];let h=p.filter(d=>d.hoursPendingToTransit).map(d=>parseFloat(d.hoursPendingToTransit)),b=p.filter(d=>d.hoursTransitToDelivered).map(d=>parseFloat(d.hoursTransitToDelivered)),T=p.filter(d=>d.hoursDeliveredToClosed).map(d=>parseFloat(d.hoursDeliveredToClosed)),i=p.filter(d=>d.hoursTotalCycle).map(d=>parseFloat(d.hoursTotalCycle)),n=p.filter(d=>d.hoursToDelivery).map(d=>parseFloat(d.hoursToDelivery)),t=d=>d.length>0?d.reduce((u,g)=>u+g,0)/d.length:null,s=p.filter(d=>d.closedAt).length;return[{period:"all",startDate:e||"",endDate:o||"",companyId:r,avgPendingToTransit:t(h),avgTransitToDelivered:t(b),avgDeliveredToClosed:t(T),avgTotalCycle:t(i),avgToDelivery:t(n),totalShipments:p.length,completedShipments:s}]}catch(c){return console.error("Error getting aggregate cycle times:",c),[{period:"all",startDate:e||"",endDate:o||"",companyId:r,avgPendingToTransit:null,avgTransitToDelivered:null,avgDeliveredToClosed:null,avgTotalCycle:null,avgToDelivery:null,totalShipments:0,completedShipments:0}]}}async createShipmentNotification(r){try{return await this.createNotification({...r,type:"shipment"})}catch(e){throw console.error("Error creating shipment notification:",e),e}}async updateShipmentNotificationStatus(r,e,o){try{let[c]=await P.update(L).set({read:e==="sent",readAt:e==="sent"?new Date:null}).where(R(L.id,r)).returning();return c}catch(c){throw console.error("Error updating shipment notification status:",c),c}}async getShipmentNotificationsByShipment(r){try{return await P.select().from(L).where(at`${L.message} LIKE '%shipment-${r}%' OR ${L.type} = 'shipment'`).orderBy(je(L.createdAt))}catch(e){return console.error("Error getting shipment notifications:",e),[]}}async createActivationToken(r){try{let e=Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)+Date.now().toString(36),o=new Date;o.setHours(o.getHours()+24);let c={token:e,email:r,expiresAt:o,used:!1},[l]=await P.insert(Te).values(c).returning();return l}catch(e){throw console.error("Error creating activation token:",e),e}}async getActivationToken(r){try{let[e]=await P.select().from(Te).where(R(Te.token,r));return e}catch(e){console.error("Error getting activation token:",e);return}}async markTokenAsUsed(r){try{return((await P.update(Te).set({used:!0}).where(R(Te.token,r))).rowCount??0)>0}catch(e){return console.error("Error marking token as used:",e),!1}}async deleteExpiredTokens(){try{await P.delete(Te).where(at`${Te.expiresAt} < NOW()`)}catch(r){console.error("Error deleting expired tokens:",r)}}async getClient(r){try{let[e]=await P.select().from(ne).where(R(ne.id,r));return e}catch(e){console.error("Error getting client:",e);return}}async getClients(){try{return await P.select().from(ne).orderBy(ne.name)}catch(r){return console.error("Error getting clients:",r),[]}}async getClientsByCompany(r){try{return await P.select().from(ne).where(R(ne.companyId,r)).orderBy(ne.name)}catch(e){return console.error("Error getting clients by company:",e),[]}}async createClient(r){try{let[e]=await P.insert(ne).values(r).returning();return e}catch(e){throw console.error("Error creating client:",e),e}}async updateClient(r,e){try{let[o]=await P.update(ne).set({...e,updatedAt:new Date}).where(R(ne.id,r)).returning();return o}catch(o){console.error("Error updating client:",o);return}}async getPaymentVoucher(r){try{let[e]=await P.select().from(W).where(R(W.id,r));return e}catch(e){console.error("Error getting payment voucher:",e);return}}async getPaymentVouchers(){try{return await P.select().from(W).orderBy(je(W.createdAt))}catch(r){return console.error("Error getting payment vouchers:",r),[]}}async getPaymentVouchersByCompany(r){try{return await P.select().from(W).where(R(W.companyId,r)).orderBy(je(W.createdAt))}catch(e){return console.error("Error getting payment vouchers by company:",e),[]}}async getPaymentVouchersByStatus(r,e){try{return e?await P.select().from(W).where(ze(R(W.status,r),R(W.companyId,e))).orderBy(je(W.createdAt)):await P.select().from(W).where(R(W.status,r)).orderBy(je(W.createdAt))}catch(o){return console.error("Error getting payment vouchers by status:",o),[]}}async createPaymentVoucher(r){try{let[e]=await P.insert(W).values(r).returning();return e}catch(e){throw console.error("Error creating payment voucher:",e),e}}async createScheduledPayment(r){return console.log("Creating scheduled payment:",r),{id:Date.now(),...r}}async updatePaymentVoucher(r,e){try{let[o]=await P.update(W).set({...e,updatedAt:new Date}).where(R(W.id,r)).returning();return o}catch(o){console.error("Error updating payment voucher:",o);return}}async updatePaymentVoucherStatus(r,e){try{let[o]=await P.update(W).set({status:e,updatedAt:new Date}).where(R(W.id,r)).returning();return o}catch(o){console.error("Error updating payment voucher status:",o);return}}async getShipmentsByStatus(r){try{return await P.select().from(se).where(R(se.status,r))}catch(e){return console.error("Error getting shipments by status:",e),[]}}async getShipmentsByCompanyAndStatus(r,e){try{return await P.select().from(se).where(ze(R(se.companyId,r),R(se.status,e)))}catch(o){return console.error("Error getting shipments by company and status:",o),[]}}async getShipmentUpdatesByShipment(r){try{return[]}catch(e){return console.error("Error getting shipment updates:",e),[]}}async getShipmentNotification(r){try{return null}catch(e){return console.error("Error getting shipment notification:",e),null}}},ha=new st});var Cr={};pe(Cr,{MemStorage:()=>kt,storage:()=>x});var kt,x,et=de(()=>{"use strict";Nr();kt=class{constructor(){this.users=new Map,this.companies=new Map,this.areas=new Map,this.kpis=new Map,this.kpiValues=new Map,this.actionPlans=new Map,this.shipments=new Map,this.shipmentUpdates=new Map,this.shipmentNotifications=new Map,this.notifications=new Map,this.jobProfiles=new Map,this.shipmentCycleTimes=new Map,this.userId=1,this.companyId=1,this.areaId=1,this.kpiId=1,this.kpiValueId=1,this.actionPlanId=1,this.shipmentId=1,this.shipmentUpdateId=1,this.shipmentNotificationId=1,this.notificationId=1,this.jobProfileId=1,this.cycleTimeId=1,this.initializeData(),this.initializeShipmentData()}initializeData(){let r={id:this.userId++,name:"Admin",email:"admin@econova.com",password:"password123",role:"admin",companyId:null,areaId:null,lastLogin:new Date};this.users.set(r.id,r);let e={id:this.userId++,name:"Omar Navarro",email:"omar.navarro",password:"ventas2025",role:"user",companyId:null,areaId:null,lastLogin:null};this.users.set(e.id,e);let o={id:this.userId++,name:"Mario Reynoso",email:"mario.reynoso",password:"finanzas2025",role:"user",companyId:null,areaId:null,lastLogin:null};this.users.set(o.id,o);let c={id:this.userId++,name:"Thalia Rodriguez",email:"thalia.rodriguez",password:"logistica2025",role:"user",companyId:null,areaId:null,lastLogin:null};this.users.set(c.id,c);let l={id:this.companyId++,name:"Dura International",description:"Empresa l\xEDder en la industria qu\xEDmica",sector:"Qu\xEDmica",logo:null,createdAt:new Date};this.companies.set(l.id,l);let p={id:this.companyId++,name:"Grupo Orsega",description:"Empresa especializada en productos qu\xEDmicos",sector:"Qu\xEDmica",logo:null,createdAt:new Date};this.companies.set(p.id,p);let b=["Ventas","Log\xEDstica","Contabilidad y Finanzas"],T=new Map,i=new Map;b.forEach(n=>{let t={id:this.areaId++,name:n,description:`\xC1rea de ${n} para Dura International`,companyId:l.id};this.areas.set(t.id,t),T.set(n,t)}),b.forEach(n=>{let t={id:this.areaId++,name:n,description:`\xC1rea de ${n} para Grupo Orsega`,companyId:p.id};this.areas.set(t.id,t),i.set(n,t)}),T.has("Contabilidad y Finanzas")&&i.has("Contabilidad y Finanzas")&&[{name:"Precisi\xF3n en estados financieros",description:"Mide la exactitud de los estados financieros generados. Objetivo: cero errores en emisi\xF3n de informaci\xF3n financiera. Limitar las salvedades a menos de 5 al mes.",unit:"%",duraTarget:"100%",orsegaTarget:"100%",frequency:"monthly",calculationMethod:"Conteo de errores y salvedades. Los datos son procesados por Julio.",responsible:"Mario Reynoso"},{name:"Velocidad de rotaci\xF3n de cuentas por cobrar",description:"Mide el tiempo promedio para cobrar cuentas pendientes. Considerando que para Orsega un cliente clave representa el 80% de ventas.",unit:"d\xEDas",duraTarget:"45 d\xEDas",orsegaTarget:"60 d\xEDas",frequency:"monthly",calculationMethod:"Promedio de d\xEDas para cobrar",responsible:"Mario Reynoso"},{name:"Cumplimiento de obligaciones fiscales",description:"Monitoreo mediante checklist para la presentaci\xF3n de impuestos. Objetivo de cumplimiento 100% para evitar confusiones.",unit:"%",duraTarget:"100%",orsegaTarget:"100%",frequency:"monthly",calculationMethod:"Checklist de obligaciones fiscales. Mario enviar\xE1 el WordCat con la informaci\xF3n a Daniel.",responsible:"Mario Reynoso"},{name:"Facturaci\xF3n sin errores",description:"Mide la precisi\xF3n en la generaci\xF3n de facturas",unit:"%",duraTarget:"100%",orsegaTarget:"100%",frequency:"weekly",calculationMethod:"(Facturas sin errores / Total de facturas) x 100",responsible:"Mario Reynoso"}].forEach(t=>{let s={id:this.kpiId++,name:t.name,description:t.description,unit:t.unit,target:t.duraTarget,frequency:t.frequency,calculationMethod:t.calculationMethod,responsible:t.responsible,areaId:T.get("Contabilidad y Finanzas").id,companyId:l.id,invertedMetric:!1};this.kpis.set(s.id,s),[{value:t.name.includes("Precisi\xF3n")?"98.5%":t.name.includes("Rotaci\xF3n")?"48":t.name.includes("Cumplimiento")?"100%":t.name.includes("Facturaci\xF3n")?"97%":"+2.5%",period:"Q1 2023",status:t.name.includes("Precisi\xF3n")||t.name.includes("Rotaci\xF3n")?"alert":"complies",compliancePercentage:t.name.includes("Precisi\xF3n")?"95%":t.name.includes("Rotaci\xF3n")?"93.8%":"100%",comments:t.name.includes("Rotaci\xF3n")?"Ligeramente por encima del objetivo (45 d\xEDas). Mejorando plazo de cobro.":"Valor registrado para el periodo"},{value:t.name.includes("Precisi\xF3n")?"99.2%":t.name.includes("Rotaci\xF3n")?"42":t.name.includes("Cumplimiento")?"100%":t.name.includes("Facturaci\xF3n")?"98%":"+3.1%",period:"Q2 2023",status:(t.name.includes("Rotaci\xF3n"),"complies"),compliancePercentage:t.name.includes("Rotaci\xF3n")?"107.1%":"100%",comments:t.name.includes("Rotaci\xF3n")?"Por debajo del objetivo (45 d\xEDas). Excelente gesti\xF3n de cobros.":"Mejora respecto al periodo anterior"}].forEach(y=>{let m={id:this.kpiValueId++,kpiId:s.id,userId:1,updatedBy:null,...y,date:new Date};this.kpiValues.set(m.id,m)});let u={id:this.kpiId++,name:t.name,description:t.description,unit:t.unit,target:t.orsegaTarget,frequency:t.frequency,calculationMethod:t.calculationMethod,responsible:t.responsible,areaId:i.get("Contabilidad y Finanzas").id,companyId:p.id,invertedMetric:!1};this.kpis.set(u.id,u),[{value:t.name.includes("Precisi\xF3n")?"99.0%":t.name.includes("Rotaci\xF3n")?"65":t.name.includes("Cumplimiento")?"98%":t.name.includes("Facturaci\xF3n")?"95%":"+1.8%",period:"Q1 2023",status:t.name.includes("Cumplimiento")||t.name.includes("Rotaci\xF3n")||t.name.includes("Facturaci\xF3n")?"alert":"complies",compliancePercentage:t.name.includes("Cumplimiento")?"98%":t.name.includes("Rotaci\xF3n")?"92%":t.name.includes("Facturaci\xF3n")?"95%":"100%",comments:t.name.includes("Rotaci\xF3n")?"Por encima del objetivo. Cliente clave (80% de ventas) paga a 65 d\xEDas":"Valor registrado para el periodo"},{value:t.name.includes("Precisi\xF3n")?"99.5%":t.name.includes("Rotaci\xF3n")?"58":t.name.includes("Cumplimiento")?"100%":t.name.includes("Facturaci\xF3n")?"98%":"+2.5%",period:"Q2 2023",status:(t.name.includes("Rotaci\xF3n"),"complies"),compliancePercentage:"100%",comments:t.name.includes("Rotaci\xF3n")?"Mejora en la rotaci\xF3n. Dentro del objetivo de 60 d\xEDas":"Mejora respecto al periodo anterior"}].forEach(y=>{let m={id:this.kpiValueId++,kpiId:u.id,userId:1,updatedBy:null,...y,date:new Date};this.kpiValues.set(m.id,m)})}),T.has("Compras")&&i.has("Compras")&&[{name:"Nivel de inventario \xF3ptimo",description:"Mantener los niveles \xF3ptimos de inventario para operaciones",unit:"unidades",duraTarget:"M\xE1x. 2 meses secantes",orsegaTarget:"M\xE1x. 6 ton metilato",frequency:"monthly",calculationMethod:"Medici\xF3n directa de inventario vs. objetivo",responsible:"Roberto M\xE9ndez"},{name:"Tiempo de respuesta a Ventas",description:"Mide el tiempo de respuesta a solicitudes de Ventas",unit:"horas",duraTarget:"M\xE1x. 4 horas",orsegaTarget:"M\xE1x. 4 horas",frequency:"weekly",calculationMethod:"Tiempo promedio de respuesta",responsible:"Elena Morales"},{name:"Tiempo de entrega de proveedores",description:"Mide el cumplimiento de tiempos de entrega de proveedores",unit:"%",duraTarget:"95% cumplimiento",orsegaTarget:"95% cumplimiento",frequency:"monthly",calculationMethod:"(Entregas a tiempo / Total de entregas) x 100",responsible:"Miguel \xC1ngel Soto"},{name:"Optimizaci\xF3n de costos de compra",description:"Mide la reducci\xF3n de costos en compras",unit:"%",duraTarget:"< 5%",orsegaTarget:"< 5%",frequency:"quarterly",calculationMethod:"(Costo actual - Costo previo) / Costo previo x 100",responsible:"Josefina Ram\xEDrez"}].forEach(t=>{let s={id:this.kpiId++,name:t.name,description:t.description,unit:t.unit,target:t.duraTarget,frequency:t.frequency,calculationMethod:t.calculationMethod,responsible:t.responsible,areaId:T.get("Compras").id,companyId:l.id,invertedMetric:!1};this.kpis.set(s.id,s),[{value:t.name.includes("Nivel")?"1.8 meses":t.name.includes("Tiempo de respuesta")?"4.5 horas":t.name.includes("Tiempo de entrega")?"92%":"-3.5%",period:"Q1 2023",status:t.name.includes("Tiempo de respuesta")||t.name.includes("Tiempo de entrega")?"alert":"complies",compliancePercentage:t.name.includes("Tiempo de respuesta")?"90%":t.name.includes("Tiempo de entrega")?"92%":"100%",comments:"Valor registrado para el periodo"}].forEach(y=>{let m={id:this.kpiValueId++,kpiId:s.id,userId:1,updatedBy:null,...y,date:new Date};this.kpiValues.set(m.id,m)});let u={id:this.kpiId++,name:t.name,description:t.description,unit:t.unit,target:t.orsegaTarget,frequency:t.frequency,calculationMethod:t.calculationMethod,responsible:t.responsible,areaId:i.get("Compras").id,companyId:p.id,invertedMetric:!1};this.kpis.set(u.id,u),[{value:t.name.includes("Nivel")?"5.8 ton":t.name.includes("Tiempo de respuesta")?"3.8 horas":t.name.includes("Tiempo de entrega")?"96%":"-4.2%",period:"Q1 2023",status:t.name.includes("Nivel")?"alert":"complies",compliancePercentage:t.name.includes("Nivel")?"95%":"100%",comments:"Valor registrado para el periodo"}].forEach(y=>{let m={id:this.kpiValueId++,kpiId:u.id,userId:1,updatedBy:null,...y,date:new Date};this.kpiValues.set(m.id,m)})}),T.has("Ventas")&&i.has("Ventas")&&[{name:"Volumen de ventas alcanzado",description:"Mide el volumen total de ventas mensual en kilogramos",unit:"KG",duraTarget:"55,620 KG",orsegaTarget:"775,735 unidades",frequency:"monthly",calculationMethod:"Suma del volumen de todas las ventas en KG/unidades",responsible:"Omar Navarro"},{name:"Porcentaje de crecimiento en ventas",description:"Mide el crecimiento en ventas respecto al a\xF1o anterior",unit:"%",duraTarget:"+10% vs a\xF1o anterior",orsegaTarget:"+10% vs a\xF1o anterior",frequency:"monthly",calculationMethod:"((Ventas actuales - Ventas a\xF1o anterior) / Ventas a\xF1o anterior) x 100",responsible:"Isabella Vega"},{name:"Nuevos clientes adquiridos",description:"Mide la adquisici\xF3n de nuevos clientes",unit:"clientes",duraTarget:"2 nuevos/mes",orsegaTarget:"2 nuevos/mes",frequency:"monthly",calculationMethod:"Conteo de nuevos clientes",responsible:"Omar Navarro"},{name:"Tasa de retenci\xF3n de clientes",description:"Mide el porcentaje de clientes que permanecen activos",unit:"%",duraTarget:"90%",orsegaTarget:"90%",frequency:"monthly",calculationMethod:"(Clientes activos que renuevan / Total de clientes activos) x 100",responsible:"Alejandra Dur\xE1n"},{name:"Satisfacci\xF3n interdepartamental",description:"Eval\xFAa la colaboraci\xF3n con otros departamentos",unit:"cualitativo",duraTarget:"Retroalimentaci\xF3n continua",orsegaTarget:"Retroalimentaci\xF3n continua",frequency:"quarterly",calculationMethod:"Encuestas de satisfacci\xF3n interdepartamental",responsible:"Sergio Montero"}].forEach(t=>{let s={id:this.kpiId++,name:t.name,description:t.description,unit:t.unit,target:t.duraTarget,frequency:t.frequency,calculationMethod:t.calculationMethod,responsible:t.responsible,areaId:T.get("Ventas").id,companyId:l.id,invertedMetric:!1};this.kpis.set(s.id,s),(t.name.includes("Volumen")?[{value:"59,453 KG",period:"Enero 2025",status:"complies",compliancePercentage:"107%",comments:"Por encima del objetivo mensual de 55,620 KG"},{value:"46,450 KG",period:"Febrero 2025",status:"not_compliant",compliancePercentage:"83%",comments:"Por debajo del objetivo mensual, afectado por fallas en equipos"},{value:"43,602.24 KG",period:"Marzo 2025",status:"not_compliant",compliancePercentage:"78%",comments:"Por debajo del objetivo, plan de acci\xF3n en curso"}]:t.name.includes("Nuevos clientes")?[{value:"0",period:"Enero 2025",status:"not_compliant",compliancePercentage:"0%",comments:"No se registraron nuevos clientes en este periodo"},{value:"0",period:"Febrero 2025",status:"not_compliant",compliancePercentage:"0%",comments:"No se registraron nuevos clientes en este periodo"},{value:"0",period:"Marzo 2025",status:"not_compliant",compliancePercentage:"0%",comments:"No se registraron nuevos clientes en este periodo"}]:[{value:t.name.includes("Porcentaje de crecimiento")?"+8.5%":t.name.includes("Tasa de retenci\xF3n")?"92%":"Satisfactorio",period:"Enero 2025",status:t.name.includes("Porcentaje de crecimiento")?"alert":"complies",compliancePercentage:t.name.includes("Porcentaje de crecimiento")?"85%":"100%",comments:"Valor registrado para el periodo"}]).forEach(y=>{let m={id:this.kpiValueId++,kpiId:s.id,userId:1,updatedBy:null,...y,date:new Date};this.kpiValues.set(m.id,m)});let u={id:this.kpiId++,name:t.name,description:t.description,unit:t.unit,target:t.orsegaTarget,frequency:t.frequency,calculationMethod:t.calculationMethod,responsible:t.responsible,areaId:i.get("Ventas").id,companyId:p.id,invertedMetric:!1};this.kpis.set(u.id,u),(t.name.includes("Volumen")?[{value:"812,340 unidades",period:"Enero 2025",status:"complies",compliancePercentage:"105%",comments:"Por encima del objetivo mensual de 775,735 unidades"},{value:"755,212 unidades",period:"Febrero 2025",status:"alert",compliancePercentage:"97%",comments:"Ligeramente por debajo del objetivo mensual"},{value:"780,430 unidades",period:"Marzo 2025",status:"complies",compliancePercentage:"101%",comments:"Recuperaci\xF3n y cumplimiento del objetivo"},{value:"237,464 unidades",period:"Abril 2025",status:"not_compliant",compliancePercentage:"31%",comments:"Muy por debajo del objetivo, posible error en los datos"}]:t.name.includes("Nuevos clientes")?[{value:"0",period:"Enero 2025",status:"not_compliant",compliancePercentage:"0%",comments:"No se registraron nuevos clientes en este periodo"},{value:"0",period:"Febrero 2025",status:"not_compliant",compliancePercentage:"0%",comments:"No se registraron nuevos clientes en este periodo"},{value:"0",period:"Marzo 2025",status:"not_compliant",compliancePercentage:"0%",comments:"No se registraron nuevos clientes en este periodo"}]:[{value:t.name.includes("Porcentaje de crecimiento")?"+11.2%":t.name.includes("Tasa de retenci\xF3n")?"88%":"Muy satisfactorio",period:"Enero 2025",status:t.name.includes("Tasa de retenci\xF3n")?"alert":"complies",compliancePercentage:t.name.includes("Tasa de retenci\xF3n")?"98%":"100%",comments:"Valor registrado para el periodo"}]).forEach(y=>{let m={id:this.kpiValueId++,kpiId:u.id,userId:1,updatedBy:null,...y,date:new Date};this.kpiValues.set(m.id,m)})}),T.has("Soporte de Ventas")&&i.has("Soporte de Ventas")&&[{name:"Actualizaci\xF3n del CRM",description:"Mide la actualizaci\xF3n oportuna de datos en el CRM",unit:"%",duraTarget:"100%",orsegaTarget:"100%",frequency:"monthly",calculationMethod:"(Registros actualizados / Total de registros) x 100",responsible:"Gabriela Herrera"},{name:"Tiempo de respuesta a solicitudes",description:"Mide el tiempo de respuesta a solicitudes de clientes",unit:"horas",duraTarget:"< 24 horas",orsegaTarget:"< 24 horas",frequency:"weekly",calculationMethod:"Tiempo promedio de respuesta",responsible:"Daniel Ortega"},{name:"Precisi\xF3n en documentaci\xF3n de \xF3rdenes",description:"Mide la exactitud en la documentaci\xF3n de \xF3rdenes",unit:"%",duraTarget:"98%",orsegaTarget:"98%",frequency:"quarterly",calculationMethod:"(Documentos sin errores / Total de documentos) x 100",responsible:"Laura Reyes"},{name:"Eficiencia en reportes de soporte",description:"Mide la entrega oportuna de reportes",unit:"%",duraTarget:"100% en plazo",orsegaTarget:"100% en plazo",frequency:"monthly",calculationMethod:"(Reportes entregados a tiempo / Total de reportes) x 100",responsible:"Roberto Cruz"},{name:"Seguimiento a evaluaci\xF3n de muestras",description:"Mide el seguimiento a muestras enviadas a clientes",unit:"%",duraTarget:"100%",orsegaTarget:"100%",frequency:"monthly",calculationMethod:"(Muestras con seguimiento / Total de muestras) x 100",responsible:"Mariana Fuentes"},{name:"Seguimiento a redes sociales",description:"Mide la actividad en redes sociales",unit:"posts",duraTarget:"2 posts/semana",orsegaTarget:"2 posts/semana",frequency:"weekly",calculationMethod:"Conteo de publicaciones",responsible:"Javier Castillo"},{name:"Recuperaci\xF3n de ventas de clientes",description:"Mide la reactivaci\xF3n de clientes inactivos",unit:"%",duraTarget:"% clientes reactivados",orsegaTarget:"% clientes reactivados",frequency:"bimonthly",calculationMethod:"(Clientes reactivados / Total de clientes inactivos) x 100",responsible:"Ver\xF3nica Torres"}].forEach(t=>{let s={id:this.kpiId++,name:t.name,description:t.description,unit:t.unit,target:t.duraTarget,frequency:t.frequency,calculationMethod:t.calculationMethod,responsible:t.responsible,areaId:T.get("Soporte de Ventas").id,companyId:l.id,invertedMetric:!1};this.kpis.set(s.id,s),[{value:t.name.includes("Actualizaci\xF3n")?"95%":t.name.includes("Tiempo de respuesta")?"22 horas":t.name.includes("Precisi\xF3n")?"97.5%":t.name.includes("Eficiencia")?"98%":t.name.includes("Seguimiento a evaluaci\xF3n")?"100%":t.name.includes("Seguimiento a redes")?"1.5/semana":"15%",period:"Q1 2023",status:t.name.includes("Actualizaci\xF3n")||t.name.includes("Precisi\xF3n")||t.name.includes("Eficiencia")||t.name.includes("Seguimiento a redes")?"alert":"complies",compliancePercentage:t.name.includes("Actualizaci\xF3n")?"95%":t.name.includes("Precisi\xF3n")?"97%":t.name.includes("Eficiencia")?"98%":t.name.includes("Seguimiento a redes")?"75%":"100%",comments:"Valor registrado para el periodo"}].forEach(y=>{let m={id:this.kpiValueId++,kpiId:s.id,userId:1,updatedBy:null,...y,date:new Date};this.kpiValues.set(m.id,m)});let u={id:this.kpiId++,name:t.name,description:t.description,unit:t.unit,target:t.orsegaTarget,frequency:t.frequency,calculationMethod:t.calculationMethod,responsible:t.responsible,areaId:i.get("Soporte de Ventas").id,companyId:p.id,invertedMetric:!1};this.kpis.set(u.id,u),[{value:t.name.includes("Actualizaci\xF3n")?"98%":t.name.includes("Tiempo de respuesta")?"20 horas":t.name.includes("Precisi\xF3n")?"98.5%":t.name.includes("Eficiencia")?"100%":t.name.includes("Seguimiento a evaluaci\xF3n")?"98%":t.name.includes("Seguimiento a redes")?"2/semana":"20%",period:"Q1 2023",status:t.name.includes("Seguimiento a evaluaci\xF3n")?"alert":"complies",compliancePercentage:t.name.includes("Seguimiento a evaluaci\xF3n")?"98%":"100%",comments:"Valor registrado para el periodo"}].forEach(y=>{let m={id:this.kpiValueId++,kpiId:u.id,userId:1,updatedBy:null,...y,date:new Date};this.kpiValues.set(m.id,m)})}),T.has("Log\xEDstica")&&i.has("Log\xEDstica")&&[{name:"Precisi\xF3n de inventarios",description:"Mide la exactitud del inventario f\xEDsico vs. sistema",unit:"%",duraTarget:"100%",orsegaTarget:"100%",frequency:"quarterly",calculationMethod:"(Inventario correcto / Total de inventario) x 100",responsible:"Ricardo Vargas"},{name:"Cumplimiento de tiempos de entrega",description:"Mide el cumplimiento de los tiempos de entrega a clientes",unit:"%",duraTarget:"100%",orsegaTarget:"100%",frequency:"monthly",calculationMethod:"(Entregas a tiempo / Total de entregas) x 100",responsible:"Patricia Lara"},{name:"Costos de transporte",description:"Mide la optimizaci\xF3n de costos de transporte",unit:"%",duraTarget:"< Inflaci\xF3n anual",orsegaTarget:"< Inflaci\xF3n anual",frequency:"yearly",calculationMethod:"Comparaci\xF3n con la inflaci\xF3n anual",responsible:"H\xE9ctor Navarro"},{name:"Satisfacci\xF3n de clientes internos",description:"Mide la satisfacci\xF3n de otros departamentos con Log\xEDstica",unit:"%",duraTarget:"100%",orsegaTarget:"100%",frequency:"semiannually",calculationMethod:"Encuestas de satisfacci\xF3n",responsible:"Carmen Delgado"},{name:"Tiempo de recuperaci\xF3n de evidencias",description:"Mide el tiempo para recuperar evidencias de entrega",unit:"horas",duraTarget:"< 24 horas",orsegaTarget:"< 24 horas",frequency:"monthly",calculationMethod:"Tiempo promedio de recuperaci\xF3n",responsible:"Arturo Guzm\xE1n"}].forEach(t=>{let s={id:this.kpiId++,name:t.name,description:t.description,unit:t.unit,target:t.duraTarget,frequency:t.frequency,calculationMethod:t.calculationMethod,responsible:t.responsible,areaId:T.get("Log\xEDstica").id,companyId:l.id,invertedMetric:!1};this.kpis.set(s.id,s),[{value:t.name.includes("Precisi\xF3n de inventarios")?"98.5%":t.name.includes("Cumplimiento de tiempos")?"95%":t.name.includes("Costos de transporte")?"-2% vs inflaci\xF3n":t.name.includes("Satisfacci\xF3n")?"92%":"28 horas",period:"Q1 2023",status:t.name.includes("Precisi\xF3n de inventarios")||t.name.includes("Cumplimiento de tiempos")||t.name.includes("Satisfacci\xF3n")||t.name.includes("Tiempo de recuperaci\xF3n")?"alert":"complies",compliancePercentage:t.name.includes("Precisi\xF3n de inventarios")?"98%":t.name.includes("Cumplimiento de tiempos")?"95%":t.name.includes("Satisfacci\xF3n")?"92%":t.name.includes("Tiempo de recuperaci\xF3n")?"85%":"100%",comments:"Valor registrado para el periodo"}].forEach(y=>{let m={id:this.kpiValueId++,kpiId:s.id,userId:1,updatedBy:null,...y,date:new Date};this.kpiValues.set(m.id,m)});let u={id:this.kpiId++,name:t.name,description:t.description,unit:t.unit,target:t.orsegaTarget,frequency:t.frequency,calculationMethod:t.calculationMethod,responsible:t.responsible,areaId:i.get("Log\xEDstica").id,companyId:p.id,invertedMetric:!1};this.kpis.set(u.id,u),[{value:t.name.includes("Precisi\xF3n de inventarios")?"99.2%":t.name.includes("Cumplimiento de tiempos")?"97%":t.name.includes("Costos de transporte")?"-1.5% vs inflaci\xF3n":t.name.includes("Satisfacci\xF3n")?"95%":"22 horas",period:"Q1 2023",status:t.name.includes("Cumplimiento de tiempos")||t.name.includes("Satisfacci\xF3n")?"alert":"complies",compliancePercentage:t.name.includes("Cumplimiento de tiempos")?"97%":t.name.includes("Satisfacci\xF3n")?"95%":"100%",comments:"Valor registrado para el periodo"}].forEach(y=>{let m={id:this.kpiValueId++,kpiId:u.id,userId:1,updatedBy:null,...y,date:new Date};this.kpiValues.set(m.id,m)})})}async getUser(r){return this.users.get(r)}async getUserByEmail(r){return Array.from(this.users.values()).find(e=>e.email.toLowerCase()===r.toLowerCase())}async getUserByUsername(r){try{return r.includes("@")?this.getUserByEmail(r):r.toLowerCase()==="admin"?Array.from(this.users.values()).find(e=>e.name.toLowerCase()==="admin"):Array.from(this.users.values()).find(e=>{let o=e.email.toLowerCase().split("@");return o.length>0&&o[0]===r.toLowerCase()})}catch(e){console.error("Error en getUserByUsername:",e);return}}async createUser(r){let e=this.userId++,o={...r,id:e,lastLogin:null,role:r.role||"viewer",companyId:r.companyId||null,areaId:r.areaId||null};return this.users.set(e,o),o}async updateUser(r,e){let o=this.users.get(r);if(!o)return;let c={...o,...e};return this.users.set(r,c),c}async getUsers(){return Array.from(this.users.values())}async getCompany(r){return this.companies.get(r)}async getCompanies(){return Array.from(this.companies.values())}async createCompany(r){let e=this.companyId++,o={...r,id:e,createdAt:new Date,description:r.description||null,sector:r.sector||null,logo:r.logo||null};return this.companies.set(e,o),o}async updateCompany(r,e){let o=this.companies.get(r);if(!o)return;let c={...o,...e};return this.companies.set(r,c),c}async getArea(r){return this.areas.get(r)}async getAreas(){return Array.from(this.areas.values())}async getAreasByCompany(r){return Array.from(this.areas.values()).filter(e=>e.companyId===r)}async createArea(r){let e=this.areaId++,o={...r,id:e,description:r.description||null};return this.areas.set(e,o),o}async updateArea(r,e){let o=this.areas.get(r);if(!o)return;let c={...o,...e};return this.areas.set(r,c),c}async getKpi(r,e){let o=this.kpis.get(r);if(o&&o.companyId===e)return o}async getKpis(r){let e=Array.from(this.kpis.values());return typeof r=="number"?e.filter(o=>o.companyId===r):e}async getKpisByCompany(r){return this.getKpis(r)}async getKpisByArea(r){return Array.from(this.kpis.values()).filter(e=>e.areaId===r)}async getKpisByCompanyAndArea(r,e){return Array.from(this.kpis.values()).filter(o=>o.companyId===r&&o.areaId===e)}async createKpi(r){let e=this.kpiId++,o=r.areaId?this.areas.get(r.areaId):void 0,c=r.goal??r.target??null,l={id:e,companyId:r.companyId,areaId:r.areaId??null,area:o?.name??r.area??null,name:r.name,description:r.description??null,goal:c,target:c,unit:r.unit??null,frequency:r.frequency??null,calculationMethod:r.calculationMethod??null,responsible:r.responsible??null,source:r.source??null,period:r.period??null,createdAt:new Date,invertedMetric:!1};return this.kpis.set(e,l),l}async updateKpi(r,e){let o=this.kpis.get(r);if(!o)return;let c={...o,...e};if(e.goal!==void 0||e.target!==void 0){let l=e.goal??e.target??c.goal;c.goal=l,c.target=l}if(e.areaId!==void 0){let l=this.areas.get(e.areaId);c.areaId=e.areaId,l&&(c.area=l.name)}return e.area!==void 0&&(c.area=e.area),this.kpis.set(r,c),c}async deleteKpi(r,e){let o=this.kpis.get(r);if(!o||o.companyId!==e)return!1;this.kpis.delete(r);for(let[c,l]of this.kpiValues.entries())l.kpiId===r&&this.kpiValues.delete(c);return!0}async getKpiValue(r,e){let o=this.kpiValues.get(r);if(o&&!(typeof e=="number"&&o.companyId!==e))return o}async getKpiValues(r){let e=Array.from(this.kpiValues.values());return typeof r=="number"?e.filter(o=>o.companyId===r):e}async getKpiValuesByKpi(r,e){return this.getKpiValues(e).filter(o=>o.kpiId===r).sort((o,c)=>{let l=o.date?new Date(o.date).getTime():0;return(c.date?new Date(c.date).getTime():0)-l})}async getLatestKpiValues(r,e,o){return this.getKpiValues(o).filter(c=>c.kpiId===r).sort((c,l)=>{let p=c.date?new Date(c.date).getTime():0;return(l.date?new Date(l.date).getTime():0)-p}).slice(0,e)}async createKpiValue(r){let e=this.kpiValueId++,o=r.period;if(!o||o==="monthly"){let l=new Date;o=`${["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][l.getMonth()]} ${l.getFullYear()}`}let c={...r,id:e,date:new Date,period:o,status:r.status||null,compliancePercentage:r.compliancePercentage||null,comments:r.comments||null,updatedBy:r.updatedBy||null};return this.kpiValues.set(e,c),c}async getActionPlan(r){return this.actionPlans.get(r)}async getActionPlansByKpi(r){return Array.from(this.actionPlans.values()).filter(e=>e.kpiId===r)}async createActionPlan(r){let e=this.actionPlanId++,o={...r,id:e,results:r.results||null};return this.actionPlans.set(e,o),o}async updateActionPlan(r,e){let o=this.actionPlans.get(r);if(!o)return;let c={...o,...e};return this.actionPlans.set(r,c),c}async getShipment(r){return this.shipments.get(r)}async getShipmentByTrackingCode(r){for(let e of Array.from(this.shipments.values()))if(e.trackingCode===r)return e}enrichShipmentWithCycleTimes(r){let e=this.shipmentCycleTimes.get(r.id);return e?{...r,cycleTimes:{hoursTotalCycle:e.hoursTotalCycle,hoursPendingToTransit:e.hoursPendingToTransit,hoursTransitToDelivered:e.hoursTransitToDelivered,hoursDeliveredToClosed:e.hoursDeliveredToClosed,hoursToDelivery:e.hoursToDelivery,computedAt:e.computedAt||void 0,updatedAt:e.updatedAt||void 0}}:{...r,cycleTimes:null}}async getShipments(){return Array.from(this.shipments.values()).map(e=>this.enrichShipmentWithCycleTimes(e))}async getShipmentsByCompany(r){return Array.from(this.shipments.values()).filter(o=>o.companyId===r).map(o=>this.enrichShipmentWithCycleTimes(o))}async getShipmentsByStatus(r){return Array.from(this.shipments.values()).filter(e=>e.status===r)}async getShipmentsByCompanyAndStatus(r,e){return Array.from(this.shipments.values()).filter(o=>o.companyId===r&&o.status===e)}async createShipment(r){let e=this.shipmentId++,o=r.trackingCode;if(!o){let h=r.companyId===1?"DUR":"ORS",b=new Date,T=b.getFullYear().toString().slice(2),i=(b.getMonth()+1).toString().padStart(2,"0"),n=e.toString().padStart(4,"0");o=`${h}-${T}${i}-${n}`}let c=new Date,l=new Date,p={id:e,...r,trackingCode:o,status:r.status||"pending",createdAt:c,updatedAt:l,comments:r.comments||null,customerEmail:r.customerEmail||null,customerPhone:r.customerPhone||null,departureDate:r.departureDate||null,estimatedDeliveryDate:r.estimatedDeliveryDate||null,actualDeliveryDate:r.actualDeliveryDate||null,carrier:r.carrier||null,vehicleInfo:r.vehicleInfo||null,vehicleType:r.vehicleType||null,fuelType:r.fuelType||null,distance:r.distance||null,carbonFootprint:r.carbonFootprint||null,driverName:r.driverName||null,driverPhone:r.driverPhone||null};return this.shipments.set(e,p),p}async updateShipment(r,e){let o=this.shipments.get(r);if(!o)return;let c={...o,...e,updatedAt:new Date};return this.shipments.set(r,c),c}async getShipmentUpdate(r){return this.shipmentUpdates.get(r)}async getShipmentUpdatesByShipment(r){return Array.from(this.shipmentUpdates.values()).filter(e=>e.shipmentId===r).sort((e,o)=>{let c=e.timestamp?new Date(e.timestamp).getTime():0;return(o.timestamp?new Date(o.timestamp).getTime():0)-c})}async createShipmentUpdate(r){let e=this.shipmentUpdateId++,o=new Date,c={id:e,...r,timestamp:o,comments:r.comments||null,updatedBy:r.updatedBy||null,location:r.location||null};this.shipmentUpdates.set(e,c);let l=await this.getShipment(r.shipmentId);return l&&await this.updateShipment(l.id,{status:r.status,updatedAt:o}),c}initializeShipmentData(){let r=[{trackingCode:"DUR-2404-0001",companyId:1,customerName:"Distribuidora Qu\xEDmica del Pac\xEDfico",purchaseOrder:"PO-2025-001",destination:"Mazatl\xE1n, Sinaloa",origin:"Monterrey, Nuevo Le\xF3n",product:"Sosa C\xE1ustica",quantity:"5000",unit:"KG",departureDate:new Date("2025-04-19"),estimatedDeliveryDate:new Date("2025-04-22"),status:"in_transit",carrier:"TransQuimicos SA",vehicleInfo:"Cisterna especializada C-3540",vehicleType:"Cisterna",fuelType:"Diesel",distance:"957",carbonFootprint:"2104",driverName:"Juan P\xE9rez",driverPhone:"+52 555 123 4567",customerEmail:"compras@disquimpac.com",customerPhone:"+52 669 987 6543",comments:"Pedido urgente, cliente prioritario"},{trackingCode:"DUR-2404-0002",companyId:1,customerName:"Qu\xEDmica Industrial del Norte",purchaseOrder:"PO-2025-002",destination:"Torre\xF3n, Coahuila",origin:"Monterrey, Nuevo Le\xF3n",product:"\xC1cido Sulf\xFArico",quantity:"3500",unit:"KG",departureDate:new Date("2025-04-22"),estimatedDeliveryDate:new Date("2025-04-25"),status:"pending",carrier:"TransQuimicos SA",vehicleInfo:"Tanque especializado T-8721",vehicleType:"Tanque",fuelType:"Diesel",distance:"435",carbonFootprint:"953",driverName:"Roberto Mart\xEDnez",driverPhone:"+52 555 765 4321",customerEmail:"operaciones@quinor.mx",customerPhone:"+52 871 234 5678",comments:"Carga peligrosa, requiere documentaci\xF3n especial"},{trackingCode:"DUR-2404-0003",companyId:1,customerName:"Agroqu\xEDmicos del Baj\xEDo",purchaseOrder:"PO-2025-003",destination:"Le\xF3n, Guanajuato",origin:"Monterrey, Nuevo Le\xF3n",product:"Formaldeh\xEDdo",quantity:"2800",unit:"KG",departureDate:new Date("2025-04-15"),estimatedDeliveryDate:new Date("2025-04-18"),actualDeliveryDate:new Date("2025-04-18"),status:"delivered",carrier:"LogiChem",vehicleInfo:"Cami\xF3n L-9234",vehicleType:"Cami\xF3n",fuelType:"Diesel",distance:"632",carbonFootprint:"1390",driverName:"Miguel \xC1ngel Soto",driverPhone:"+52 555 987 6543",customerEmail:"compras@agrobajio.com",customerPhone:"+52 477 345 6789",comments:"Entrega completada satisfactoriamente"}],e=[{trackingCode:"ORS-2404-0001",companyId:2,customerName:"Productos Qu\xEDmicos Industriales",purchaseOrder:"PO-ORS-2025-001",destination:"Guadalajara, Jalisco",origin:"Ciudad de M\xE9xico",product:"Acetona",quantity:"250000",unit:"unidades",departureDate:new Date("2025-04-20"),estimatedDeliveryDate:new Date("2025-04-21"),status:"delayed",carrier:"QuimiTransportes",vehicleInfo:"Trailer QT-5623",vehicleType:"Trailer",fuelType:"Diesel",distance:"549",carbonFootprint:"1208",driverName:"Fernando Ruiz",driverPhone:"+52 555 432 1098",customerEmail:"logistica@pqi.com.mx",customerPhone:"+52 333 456 7890",comments:"Retraso por bloqueo carretero en Jalisco"},{trackingCode:"ORS-2404-0002",companyId:2,customerName:"Laboratorios Qu\xEDmicos de Occidente",purchaseOrder:"PO-ORS-2025-002",destination:"Tepic, Nayarit",origin:"Ciudad de M\xE9xico",product:"Per\xF3xido de Hidr\xF3geno",quantity:"180000",unit:"unidades",departureDate:new Date("2025-04-23"),estimatedDeliveryDate:new Date("2025-04-25"),status:"in_transit",carrier:"QuimiTransportes",vehicleInfo:"Cami\xF3n refrigerado QT-3318",vehicleType:"Cami\xF3n refrigerado",fuelType:"Diesel",distance:"832",carbonFootprint:"1984",driverName:"Alberto Mendoza",driverPhone:"+52 555 678 9012",customerEmail:"compras@lqo.mx",customerPhone:"+52 311 234 5678",comments:"Producto requiere cadena de fr\xEDo"},{trackingCode:"ORS-2404-0003",companyId:2,customerName:"Adhesivos Especializados",purchaseOrder:"PO-ORS-2025-003",destination:"Quer\xE9taro, Quer\xE9taro",origin:"Ciudad de M\xE9xico",product:"Metilato de Sodio",quantity:"125000",unit:"unidades",departureDate:new Date("2025-04-18"),estimatedDeliveryDate:new Date("2025-04-19"),actualDeliveryDate:new Date("2025-04-19"),status:"delivered",carrier:"LogiChem",vehicleInfo:"Cami\xF3n L-7891",vehicleType:"Cami\xF3n",fuelType:"Diesel",distance:"218",carbonFootprint:"475",driverName:"Rafael Torres",driverPhone:"+52 555 890 1234",customerEmail:"insumos@adhesivosesp.com",customerPhone:"+52 442 567 8901",comments:"Cliente confirm\xF3 recepci\xF3n completa"}];r.forEach(o=>{let c={id:this.shipmentId++,...o,actualDeliveryDate:o.actualDeliveryDate||null,createdAt:new Date(Date.now()-Math.floor(Math.random()*10)*24*60*60*1e3),updatedAt:new Date};this.shipments.set(c.id,c),this.createInitialShipmentUpdates(c)}),e.forEach(o=>{let c={id:this.shipmentId++,...o,actualDeliveryDate:o.actualDeliveryDate||null,createdAt:new Date(Date.now()-Math.floor(Math.random()*10)*24*60*60*1e3),updatedAt:new Date};this.shipments.set(c.id,c),this.createInitialShipmentUpdates(c)})}createInitialShipmentUpdates(r){let e={id:this.shipmentUpdateId++,shipmentId:r.id,status:"pending",location:r.origin,comments:"Env\xEDo registrado en sistema",updatedBy:1,timestamp:new Date(r.createdAt?r.createdAt.getTime():Date.now())};if(this.shipmentUpdates.set(e.id,e),r.departureDate&&r.departureDate<=new Date){let o={id:this.shipmentUpdateId++,shipmentId:r.id,status:"in_transit",location:r.origin,comments:"Env\xEDo despachado desde almac\xE9n",updatedBy:1,timestamp:new Date(r.departureDate.getTime())};this.shipmentUpdates.set(o.id,o)}if(r.status==="delayed"){let o={id:this.shipmentUpdateId++,shipmentId:r.id,status:"delayed",location:"En ruta",comments:r.comments||"Env\xEDo retrasado",updatedBy:1,timestamp:new Date(Date.now()-864e5)};this.shipmentUpdates.set(o.id,o)}if(r.status==="delivered"&&r.actualDeliveryDate){let o={id:this.shipmentUpdateId++,shipmentId:r.id,status:"delivered",location:r.destination,comments:"Env\xEDo entregado al cliente",updatedBy:1,timestamp:new Date(r.actualDeliveryDate.getTime())};this.shipmentUpdates.set(o.id,o)}}async getLastKpiUpdateByUser(r){let e=Array.from(this.kpiValues.values()).filter(l=>l.updatedBy===r).sort((l,p)=>{let h=l.date?new Date(l.date).getTime():0;return(p.date?new Date(p.date).getTime():0)-h});if(e.length===0)return;let o=e[0],c=this.kpis.get(o.kpiId);if(c)return o.date?{kpiName:c.name,updateDate:o.date}:void 0}async getTeamActivitySummary(){let r=Array.from(this.users.values()),e=[];for(let o of r){let c=await this.getLastKpiUpdateByUser(o.id);e.push({userId:o.id,lastLogin:o.lastLogin,lastKpiUpdate:c||null})}return e}async getShipmentNotification(r){return this.shipmentNotifications.get(r)}async getShipmentNotificationsByShipment(r){return Array.from(this.shipmentNotifications.values()).filter(e=>e.shipmentId===r)}async createShipmentNotification(r){let e={...r,id:this.shipmentNotificationId++,sentAt:new Date,errorMessage:r.errorMessage||null};return this.shipmentNotifications.set(e.id,e),e}async updateShipmentNotificationStatus(r,e,o){let c=this.shipmentNotifications.get(r);if(!c)return;let l={...c,status:e,errorMessage:o||null};return this.shipmentNotifications.set(r,l),l}async deleteUser(r){return this.users.delete(r)}async getNotification(r){return this.notifications.get(r)}async getNotificationsForUser(r){return Array.from(this.notifications.values()).filter(e=>e.toUserId===r||e.toUserId===null)}async createNotification(r){let e=this.notificationId++,o={...r,companyId:r.companyId??null,areaId:r.areaId??null,toUserId:r.toUserId??null,type:r.type??"info",priority:r.priority??"normal",id:e,read:!1,readAt:null,createdAt:new Date};return this.notifications.set(e,o),o}async markNotificationAsRead(r,e){let o=this.notifications.get(r);if(!o||o.toUserId&&o.toUserId!==e)return;let c={...o,read:!0,readAt:new Date};return this.notifications.set(r,c),c}async deleteNotification(r,e){let o=this.notifications.get(r);return!o||o.toUserId&&o.toUserId!==e?!1:this.notifications.delete(r)}async getJobProfile(r){return this.jobProfiles.get(r)}async getJobProfileByUserArea(r,e){return Array.from(this.jobProfiles.values()).find(o=>o.areaId===r&&o.companyId===e)}async getJobProfileWithDetails(r){let e=await this.getUser(r);if(!e||!e.areaId)return;let o=await this.getJobProfileByUserArea(e.areaId,e.companyId||1);if(!o)return;let c=await this.getArea(e.areaId),l=e.companyId?await this.getCompany(e.companyId):null,p=await this.getUserKpis(r);return{id:o.id,companyId:o.companyId,areaId:o.areaId,title:o.title,description:o.description,mainActivities:o.mainActivities,responsibilities:o.responsibilities,kpiInstructions:o.kpiInstructions,tips:o.tips,processes:o.processes,updateFrequency:o.updateFrequency,areaName:c?.name||"",companyName:l?.name||"",userKpis:p.map(h=>({id:h.id,name:h.name,description:h.description||"",target:h.target,frequency:h.frequency,unit:h.unit}))}}async createJobProfile(r){let e=this.jobProfileId++,o={...r,id:e,createdAt:new Date,updatedAt:new Date};return this.jobProfiles.set(e,o),o}async updateJobProfile(r,e){let o=this.jobProfiles.get(r);if(!o)return;let c={...o,...e,updatedAt:new Date};return this.jobProfiles.set(r,c),c}async getUserKpis(r){let e=await this.getUser(r);return!e||!e.areaId?[]:this.getKpisByArea(e.areaId)}async getShipmentCycleTime(r){return this.shipmentCycleTimes.get(r)}async upsertShipmentCycleTime(r){let e=this.cycleTimeId++,c={id:this.shipmentCycleTimes.get(r.shipmentId)?.id||e,...r,pendingAt:r.pendingAt??null,inTransitAt:r.inTransitAt??null,deliveredAt:r.deliveredAt??null,closedAt:r.closedAt??null,hoursPendingToTransit:r.hoursPendingToTransit??null,hoursTransitToDelivered:r.hoursTransitToDelivered??null,hoursDeliveredToClosed:r.hoursDeliveredToClosed??null,hoursTotalCycle:r.hoursTotalCycle??null,hoursToDelivery:r.hoursToDelivery??null,computedAt:new Date,updatedAt:new Date};return this.shipmentCycleTimes.set(r.shipmentId,c),c}async recalculateShipmentCycleTime(r){let e=this.shipments.get(r);if(!e)return;let o=Array.from(this.shipmentUpdates.values()).filter(y=>y.shipmentId===r).sort((y,m)=>y.timestamp.getTime()-m.timestamp.getTime()),c={};for(let y of o)c[y.status]||(c[y.status]=y.timestamp);let l=e.createdAt,p=c.pending||l,h=c.in_transit,b=c.delivered||e.actualDeliveryDate,T=c.cancelled,i=(y,m)=>!y||!m?null:((m.getTime()-y.getTime())/(1e3*60*60)).toFixed(2),n=i(p,h),t=i(h,b),s=i(b,T),d=i(l,T),u=i(l,b),g={shipmentId:r,companyId:e.companyId,createdAt:l,pendingAt:p,inTransitAt:h,deliveredAt:b,closedAt:T,hoursPendingToTransit:n,hoursTransitToDelivered:t,hoursDeliveredToClosed:s,hoursTotalCycle:d,hoursToDelivery:u};return await this.upsertShipmentCycleTime(g)}async getAggregateCycleTimes(r,e,o){let c=Array.from(this.shipmentCycleTimes.values());if(r&&(c=c.filter(t=>t.companyId===r)),e&&o){let t=new Date(e),s=new Date(o);c=c.filter(d=>{let u=new Date(d.createdAt);return u>=t&&u<=s})}if(c.length===0)return[{period:"all",startDate:e||"",endDate:o||"",companyId:r,avgPendingToTransit:null,avgTransitToDelivered:null,avgDeliveredToClosed:null,avgTotalCycle:null,avgToDelivery:null,totalShipments:0,completedShipments:0}];let l=c.filter(t=>t.hoursPendingToTransit).map(t=>parseFloat(t.hoursPendingToTransit)),p=c.filter(t=>t.hoursTransitToDelivered).map(t=>parseFloat(t.hoursTransitToDelivered)),h=c.filter(t=>t.hoursDeliveredToClosed).map(t=>parseFloat(t.hoursDeliveredToClosed)),b=c.filter(t=>t.hoursTotalCycle).map(t=>parseFloat(t.hoursTotalCycle)),T=c.filter(t=>t.hoursToDelivery).map(t=>parseFloat(t.hoursToDelivery)),i=t=>t.length>0?t.reduce((s,d)=>s+d,0)/t.length:null,n=c.filter(t=>t.closedAt).length;return[{period:"all",startDate:e||"",endDate:o||"",companyId:r,avgPendingToTransit:i(l),avgTransitToDelivered:i(p),avgDeliveredToClosed:i(h),avgTotalCycle:i(b),avgToDelivery:i(T),totalShipments:c.length,completedShipments:n}]}},x=new st});var It={};pe(It,{logger:()=>k});var Vt,k,rt=de(()=>{"use strict";Vt=class{constructor(){this.isDevelopment=process.env.NODE_ENV==="development";this.isProduction=process.env.NODE_ENV==="production"}formatMessage(r,e,o){let c=new Date().toISOString(),l=o?` ${JSON.stringify(o)}`:"";return`[${c}] [${r.toUpperCase()}] ${e}${l}`}info(r,e){console.log(this.formatMessage("info",r,e))}warn(r,e){console.warn(this.formatMessage("warn",r,e))}error(r,e,o){let c={...o,error:e instanceof Error?{message:e.message,stack:this.isDevelopment?e.stack:void 0,name:e.name}:e};console.error(this.formatMessage("error",r,c))}debug(r,e){this.isDevelopment&&console.debug(this.formatMessage("debug",r,e))}},k=new Vt});var Kr={};pe(Kr,{emailService:()=>Et});import{Resend as bo}from"resend";var Lt,Et,qt=de(()=>{"use strict";rt();Lt=class{constructor(){this.resend=null;this.isConfigured=!1;this.initialize()}initialize(){let r=process.env.RESEND_API_KEY;if(!r||r==="your-resend-api-key-here"){k.warn("RESEND_API_KEY no est\xE1 configurada. Emails deshabilitados."),this.isConfigured=!1;return}try{this.resend=new bo(r),this.isConfigured=!0,k.info("Email service inicializado con Resend")}catch(e){k.error("Error inicializando email service:",{error:e}),this.isConfigured=!1}}async sendEmail(r,e="treasury"){if(!this.isConfigured||!this.resend)return k.warn("Email service no configurado. Simulando env\xEDo..."),{success:!0,messageId:"simulated-"+Date.now(),error:"Email service no configurado - modo simulaci\xF3n"};let o=process.env.USE_RESEND_TEST_EMAIL==="true",c=process.env.CLIENT_DOMAIN||"grupoorsega.com",l;o||r.from?.includes("resend.dev")?(l=r.from||"onboarding@resend.dev",k.info("Usando email de prueba de Resend:",l)):r.from?(l=r.from,k.info("Usando remitente especificado:",l)):(l=e==="treasury"?`Lolita - Tesorer\xEDa <dolores@${c}>`:`Thalia - Log\xEDstica <thalia@${c}>`,k.info("Intentando usar dominio del cliente:",l),k.info("NOTA: Si el dominio no est\xE1 verificado en Resend, el env\xEDo fallar\xE1. Usa USE_RESEND_TEST_EMAIL=true para pruebas."));try{k.info("Enviando email desde:",l,"a:",r.to);let p=await this.resend.emails.send({from:l,to:r.to,subject:r.subject,html:r.html});return k.info("Email enviado exitosamente",{to:r.to,from:l,messageId:p.data?.id}),{success:!0,messageId:p.data?.id}}catch(p){let h=p?.message||(p instanceof Error?p.message:String(p)),b=p?.response?.body||p?.response?.data||{};return k.error("Error enviando email:",{error:h,details:b,to:r.to,from:l}),h?.toLowerCase().includes("domain")||h?.toLowerCase().includes("verify")||h?.toLowerCase().includes("unauthorized")?{success:!1,error:`Error de dominio: ${h}. Para pruebas, configura USE_RESEND_TEST_EMAIL=true en .env para usar onboarding@resend.dev`}:{success:!1,error:h}}}async sendPaymentReminder(r,e,o,c){let l=`Recordatorio de Pago - ${e}`,p=`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2 style="color: #2563eb;">Recordatorio de Pago</h2>
        <p>Estimado/a ${e},</p>
        <p>Le recordamos que tiene un pago pendiente por procesar:</p>
        <div style="background-color: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;">
          <p><strong>Monto:</strong> $${o.toLocaleString("es-MX")} MXN</p>
          <p><strong>Fecha l\xEDmite:</strong> ${c}</p>
        </div>
        <p>Por favor, proceda con el pago correspondiente.</p>
        <p>Saludos cordiales,<br><strong>Lolita</strong><br>Equipo de Tesorer\xEDa - Econova</p>
      </div>
    `;return this.sendEmail({to:r,subject:l,html:p},"treasury")}async sendComplementRequest(r,e,o){let c=`Solicitud de Complemento de Pago - ${e}`,l=`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2 style="color: #dc2626;">Solicitud de Complemento de Pago</h2>
        <p>Estimado/a ${e},</p>
        <p>Se requiere complemento de pago para el comprobante:</p>
        <div style="background-color: #fef2f2; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #dc2626;">
          <p><strong>ID de Comprobante:</strong> ${o}</p>
          <p><strong>Estado:</strong> Pendiente de complemento</p>
        </div>
        <p>Por favor, proporcione la documentaci\xF3n adicional requerida.</p>
        <p>Saludos cordiales,<br><strong>Lolita</strong><br>Equipo de Tesorer\xEDa - Econova</p>
      </div>
    `;return this.sendEmail({to:r,subject:c,html:l},"treasury")}async sendPaymentConfirmation(r,e,o,c){let l=`Confirmaci\xF3n de Pago - ${e}`,p=`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2 style="color: #059669;">Pago Confirmado</h2>
        <p>Estimado/a ${e},</p>
        <p>Su pago ha sido procesado exitosamente:</p>
        <div style="background-color: #f0fdf4; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #059669;">
          <p><strong>Monto:</strong> $${o.toLocaleString("es-MX")} MXN</p>
          <p><strong>Referencia:</strong> ${c}</p>
          <p><strong>Estado:</strong> Procesado</p>
        </div>
        <p>Gracias por su pago puntual.</p>
        <p>Saludos cordiales,<br>Equipo de Tesorer\xEDa</p>
      </div>
    `;return this.sendEmail({to:r,subject:l,html:p})}async sendShipmentUpdate(r,e,o,c,l){let p=`Actualizaci\xF3n de Env\xEDo - ${e}`,h=`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2 style="color: #059669;">Actualizaci\xF3n de Env\xEDo</h2>
        <p>Estimado/a ${e},</p>
        <p>Le informamos sobre el estado actual de su env\xEDo:</p>
        <div style="background-color: #f0fdf4; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #059669;">
          <p><strong>ID de Env\xEDo:</strong> ${o}</p>
          <p><strong>Estado:</strong> ${c}</p>
          ${l?`<p><strong>N\xFAmero de Rastreo:</strong> ${l}</p>`:""}
        </div>
        <p>Gracias por confiar en nuestros servicios log\xEDsticos.</p>
        <p>Saludos cordiales,<br><strong>Thalia</strong><br>Equipo de Log\xEDstica - Econova</p>
      </div>
    `;return this.sendEmail({to:r,subject:p,html:h},"logistics")}async sendDeliveryNotification(r,e,o,c){let l=`Notificaci\xF3n de Entrega - ${e}`,p=`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2 style="color: #2563eb;">Notificaci\xF3n de Entrega</h2>
        <p>Estimado/a ${e},</p>
        <p>Su paquete est\xE1 programado para entrega:</p>
        <div style="background-color: #eff6ff; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #2563eb;">
          <p><strong>Fecha de Entrega:</strong> ${o}</p>
          <p><strong>Horario:</strong> ${c}</p>
        </div>
        <p>Por favor, aseg\xFArese de que alguien est\xE9 disponible para recibir el paquete.</p>
        <p>Saludos cordiales,<br><strong>Thalia</strong><br>Equipo de Log\xEDstica - Econova</p>
      </div>
    `;return this.sendEmail({to:r,subject:l,html:p},"logistics")}isEmailConfigured(){return this.isConfigured}},Et=new Lt});var tn={};pe(tn,{sendShipmentStatusNotification:()=>Ro,sendTransportRequest:()=>Jt});import Ht from"@sendgrid/mail";async function Jt(a){if(!process.env.SENDGRID_API_KEY){console.log("Email would be sent:",a);return}let r=process.env.NODE_ENV==="production"?"https://your-domain.replit.app":"http://localhost:5000",e=`${r}/api/shipments/${a.shipment.id}/confirm?token=${a.confirmToken}&pickupAt=${encodeURIComponent(a.pickupWindow||"")}`,o=`${r}/api/shipments/${a.shipment.id}/reject?token=${a.rejectToken}`,c=`
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center;">
        <h1 style="margin: 0;">Solicitud de Transporte</h1>
        <p style="margin: 5px 0 0 0;">Sistema Log\xEDstico DIGO</p>
      </div>
      
      <div style="padding: 30px; background: #f8f9fa;">
        <p>Estimado proveedor,</p>
        
        <p>Tenemos una nueva solicitud de transporte que requiere su atenci\xF3n:</p>
        
        <div style="background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h3 style="color: #333; margin-top: 0;">Detalles del Env\xEDo</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px; font-weight: bold; border-bottom: 1px solid #eee;">Referencia:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${a.shipment.reference}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; border-bottom: 1px solid #eee;">Cliente:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${a.shipment.client_name}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; border-bottom: 1px solid #eee;">Origen:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${a.shipment.origin}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; border-bottom: 1px solid #eee;">Destino:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${a.shipment.destination}</td>
            </tr>
            ${a.shipment.incoterm?`
            <tr>
              <td style="padding: 8px; font-weight: bold; border-bottom: 1px solid #eee;">Incoterm:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${a.shipment.incoterm}</td>
            </tr>`:""}
            ${a.pickupWindow?`
            <tr>
              <td style="padding: 8px; font-weight: bold; border-bottom: 1px solid #eee;">Ventana de Recolecci\xF3n:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${a.pickupWindow}</td>
            </tr>`:""}
          </table>
          
          ${a.notes?`
          <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
            <strong>Notas adicionales:</strong><br>
            ${a.notes}
          </div>`:""}
        </div>
        
        <p><strong>\xBFPuede realizar este transporte?</strong></p>
        
        <div style="text-align: center; margin: 30px 0;">
          <a href="${e}" 
             style="display: inline-block; background: #28a745; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin: 0 10px; font-weight: bold;">
            \u2705 CONFIRMAR TRANSPORTE
          </a>
          
          <a href="${o}" 
             style="display: inline-block; background: #dc3545; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin: 0 10px; font-weight: bold;">
            \u274C RECHAZAR
          </a>
        </div>
        
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666;">
          <p>Este correo fue enviado autom\xE1ticamente por el Sistema Log\xEDstico DIGO.</p>
          <p>Si tiene preguntas, responda directamente a este correo.</p>
        </div>
      </div>
    </div>
  `,l={to:a.to,from:"logistics@digo.mx",subject:`Solicitud de Transporte - ${a.shipment.reference}`,html:c};await Ht.send(l),console.log(`Transport request email sent to: ${a.to}`)}async function Ro(a){if(!process.env.SENDGRID_API_KEY)return console.log("[Simulation] Email notification would be sent:",{to:a.to,status:a.status,trackingCode:a.shipment.tracking_code||a.shipment.trackingCode}),{messageId:"simulated",provider:"sendgrid"};let r=Do[a.status],e=a.shipment.tracking_code||a.shipment.trackingCode||"N/A",o=a.shipment.estimated_delivery_date||a.shipment.estimatedDeliveryDate,c=`
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <div style="background: ${r.color}; color: white; padding: 20px; text-align: center;">
        <h1 style="margin: 0;">${r.title}</h1>
        <p style="margin: 5px 0 0 0;">Sistema de Seguimiento Econova</p>
      </div>
      
      <div style="padding: 30px; background: #f8f9fa;">
        <p style="font-size: 16px; color: #333;">Estimado cliente,</p>
        
        <p style="font-size: 16px; color: #333;">${r.message}</p>
        
        <div style="background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h3 style="color: #333; margin-top: 0;">Detalles del Env\xEDo</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px; font-weight: bold; border-bottom: 1px solid #eee;">C\xF3digo de Seguimiento:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee; font-family: monospace;">${e}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; border-bottom: 1px solid #eee;">Origen:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${a.shipment.origin||"N/A"}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; border-bottom: 1px solid #eee;">Destino:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${a.shipment.destination||"N/A"}</td>
            </tr>
            ${a.shipment.product?`
            <tr>
              <td style="padding: 8px; font-weight: bold; border-bottom: 1px solid #eee;">Producto:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${a.shipment.product}</td>
            </tr>`:""}
            ${o?`
            <tr>
              <td style="padding: 8px; font-weight: bold; border-bottom: 1px solid #eee;">Fecha Estimada de Entrega:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${new Date(o).toLocaleDateString("es-MX",{year:"numeric",month:"long",day:"numeric"})}</td>
            </tr>`:""}
            <tr>
              <td style="padding: 8px; font-weight: bold;">Estado Actual:</td>
              <td style="padding: 8px; color: ${r.color}; font-weight: bold;">${r.title.replace(/[]/g,"").trim()}</td>
            </tr>
          </table>
        </div>
        
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666;">
          <p>Este correo fue enviado autom\xE1ticamente por el Sistema de Seguimiento Econova.</p>
          <p>Si tiene preguntas sobre su env\xEDo, por favor cont\xE1ctenos respondiendo a este correo.</p>
        </div>
      </div>
    </div>
  `,l={to:a.to,from:"logistics@digo.mx",subject:`${r.subject} - ${e}`,html:c};try{let p=await Ht.send(l);return console.log(`Shipment status notification sent to: ${a.to} (status: ${a.status})`),{messageId:p[0]?.headers?.["x-message-id"]||"sent",provider:"sendgrid"}}catch(p){throw console.error("[Email Error] Failed to send shipment notification:",p),p}}var Do,Yt=de(()=>{"use strict";process.env.SENDGRID_API_KEY?Ht.setApiKey(process.env.SENDGRID_API_KEY):console.warn("SENDGRID_API_KEY not found - email functionality disabled");Do={pending:{subject:"Env\xEDo Registrado",title:"\u{1F4E6} Env\xEDo Registrado",message:"Su env\xEDo ha sido registrado en nuestro sistema y est\xE1 pendiente de despacho.",color:"#6c757d"},in_transit:{subject:"Env\xEDo en Tr\xE1nsito",title:"\u{1F69A} Su Env\xEDo Est\xE1 en Camino",message:"Su env\xEDo ha sido despachado y est\xE1 en tr\xE1nsito hacia su destino.",color:"#0066cc"},delayed:{subject:"Env\xEDo Retrasado",title:"\u26A0\uFE0F Actualizaci\xF3n de Env\xEDo",message:"Queremos informarle que su env\xEDo ha experimentado un retraso. Estamos trabajando para entregarlo lo antes posible.",color:"#ffc107"},delivered:{subject:"Env\xEDo Entregado",title:"\u2705 Env\xEDo Entregado Exitosamente",message:"\xA1Excelentes noticias! Su env\xEDo ha sido entregado exitosamente.",color:"#28a745"},cancelled:{subject:"Env\xEDo Cancelado",title:"\u274C Env\xEDo Cancelado",message:"Su env\xEDo ha sido cancelado. Si tiene preguntas, por favor cont\xE1ctenos.",color:"#dc3545"}}});var nn={};pe(nn,{seedClients:()=>rn});async function rn(){try{console.log("\u{1F465} Creando clientes de prueba...");let a=await P.select().from(ne);if(console.log(`\u{1F4CA} Clientes existentes: ${a.length}`),a.length>0)return console.log("\u2705 Ya hay clientes en la base de datos"),{success:!0,message:"Clients already exist",count:a.length};let r=[{name:"Distribuidora Qu\xEDmica del Pac\xEDfico",email:"contacto@distribuidoraquimica.com",phone:"+52-667-123-4567",address:"Av. del Mar 123, Mazatl\xE1n, Sinaloa",companyId:1,requires_payment_complement:!0,isActive:!0,clientCode:"DUR-CLI-001",city:"Mazatl\xE1n",state:"Sinaloa"},{name:"Qu\xEDmica Industrial del Norte",email:"ventas@quimicanorte.com",phone:"+52-871-234-5678",address:"Blvd. Independencia 456, Torre\xF3n, Coahuila",companyId:1,requires_payment_complement:!1,isActive:!0,clientCode:"DUR-CLI-002",city:"Torre\xF3n",state:"Coahuila"},{name:"Agroqu\xEDmicos del Baj\xEDo",email:"compras@agroquimicosbajio.com",phone:"+52-477-345-6789",address:"Calle Industrial 789, Le\xF3n, Guanajuato",companyId:1,requires_payment_complement:!0,isActive:!0,clientCode:"DUR-CLI-003",city:"Le\xF3n",state:"Guanajuato"}],e=[{name:"Productos Qu\xEDmicos Industriales",email:"contacto@pqi.com.mx",phone:"+52-33-456-7890",address:"Av. L\xF3pez Mateos 321, Guadalajara, Jalisco",companyId:2,requires_payment_complement:!0,isActive:!0,clientCode:"ORS-CLI-001",city:"Guadalajara",state:"Jalisco"},{name:"Laboratorios Qu\xEDmicos de Occidente",email:"compras@labquimicos.com",phone:"+52-311-567-8901",address:"Calle Tecnol\xF3gica 654, Tepic, Nayarit",companyId:2,requires_payment_complement:!1,isActive:!0,clientCode:"ORS-CLI-002",city:"Tepic",state:"Nayarit"},{name:"Adhesivos Especializados",email:"ventas@adhesivos.com.mx",phone:"+52-442-678-9012",address:"Zona Industrial 987, Quer\xE9taro, Quer\xE9taro",companyId:2,requires_payment_complement:!0,isActive:!0,clientCode:"ORS-CLI-003",city:"Quer\xE9taro",state:"Quer\xE9taro"},{name:"Proveedor de Servicios Qu\xEDmicos",email:"servicios@proveedorquimico.com",phone:"+52-55-789-0123",address:"Av. Insurgentes 147, Ciudad de M\xE9xico",companyId:2,requires_payment_complement:!1,isActive:!0,clientCode:"ORS-CLI-004",city:"Ciudad de M\xE9xico",state:"CDMX"}],o=[...r,...e];return await P.insert(ne).values(o),console.log(`\u2705 ${o.length} clientes creados exitosamente!`),console.log(`\u{1F4CA} Dura International: ${r.length} clientes`),console.log(`\u{1F4CA} Grupo Orsega: ${e.length} clientes`),{success:!0,message:"Clients created successfully",total:o.length,dura:r.length,orsega:e.length}}catch(a){return console.error("\u274C Error creando clientes:",a),{success:!1,message:"Failed to create clients",error:a instanceof Error?a.message:String(a)}}}var on=de(()=>{"use strict";le();ie();import.meta.url===`file://${process.argv[1]}`&&rn().then(a=>{console.log(a),process.exit(a.success?0:1)})});var Zt={};pe(Zt,{TreasuryAutomation:()=>Qt});import{eq as nt}from"drizzle-orm";import Xt from"@sendgrid/mail";var Qt,er=de(()=>{"use strict";le();ie();Xt.setApiKey(process.env.SENDGRID_API_KEY);Qt=class{static async sendPaymentReceiptToSupplier(r,e,o){try{let c=await P.query.paymentVouchers.findFirst({where:nt(W.id,r)});if(!c)return{success:!1,message:"Comprobante no encontrado"};let l=await P.query.clients.findFirst({where:nt(ne.id,e)});if(!l||!l.email)return{success:!1,message:"Cliente sin email configurado"};let p=c.analysis||{},h=p.extractedAmount||"N/A",b=p.extractedCurrency||"MXN",T=p.extractedReference||"N/A",i=p.extractedBank||"N/A",n={to:l.email,from:"noreply@econova.com.mx",subject:`\u2705 Comprobante de Pago - ${l.name}`,html:`
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; text-align: center;">
              <h1 style="color: white; margin: 0; font-size: 24px;">\u{1F3E6} EcoNova - Comprobante de Pago</h1>
            </div>
            
            <div style="padding: 30px; background: #f8f9fa;">
              <h2 style="color: #333; margin-bottom: 20px;">Hola ${l.name},</h2>
              
              <p style="color: #666; line-height: 1.6; margin-bottom: 20px;">
                Te confirmamos que hemos realizado el pago correspondiente. Adjunto encontrar\xE1s el comprobante bancario.
              </p>
              
              <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 20px 0;">
                <h3 style="color: #333; margin-top: 0;">\u{1F4CB} Detalles del Pago</h3>
                <table style="width: 100%; border-collapse: collapse;">
                  <tr>
                    <td style="padding: 8px 0; border-bottom: 1px solid #eee; font-weight: bold; color: #555;">Monto:</td>
                    <td style="padding: 8px 0; border-bottom: 1px solid #eee; color: #333;">${b} $${h?.toLocaleString()}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; border-bottom: 1px solid #eee; font-weight: bold; color: #555;">Referencia:</td>
                    <td style="padding: 8px 0; border-bottom: 1px solid #eee; color: #333;">${T}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; border-bottom: 1px solid #eee; font-weight: bold; color: #555;">Banco:</td>
                    <td style="padding: 8px 0; border-bottom: 1px solid #eee; color: #333;">${i}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; font-weight: bold; color: #555;">Fecha:</td>
                    <td style="padding: 8px 0; color: #333;">${new Date().toLocaleDateString("es-MX")}</td>
                  </tr>
                </table>
              </div>

              ${l.requiresPaymentComplement?`
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin: 20px 0;">
                  <h4 style="color: #856404; margin-top: 0;">\u26A0\uFE0F Complemento de Pago Requerido</h4>
                  <p style="color: #856404; margin-bottom: 0;">
                    Para completar el proceso, necesitamos que nos env\xEDes el complemento de pago correspondiente.
                    Te enviaremos un recordatorio en caso de que no lo recibamos.
                  </p>
                </div>
              `:`
                <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 8px; margin: 20px 0;">
                  <h4 style="color: #155724; margin-top: 0;">\u2705 Pago Completado</h4>
                  <p style="color: #155724; margin-bottom: 0;">
                    Este pago no requiere complemento adicional. El proceso ha sido completado exitosamente.
                  </p>
                </div>
              `}

              <div style="text-align: center; margin-top: 30px;">
                <p style="color: #666; font-size: 14px;">
                  Si tienes alguna pregunta, no dudes en contactarnos.
                </p>
                <p style="color: #999; font-size: 12px; margin-top: 20px;">
                  Este es un mensaje autom\xE1tico del sistema EcoNova.
                </p>
              </div>
            </div>
          </div>
        `};return await Xt.send(n),await P.update(W).set({status:l.requiresPaymentComplement?"pendiente_complemento":"factura_pagada",updatedAt:new Date}).where(nt(W.id,r)),l.requiresPaymentComplement&&await this.scheduleComplementReminder(r,e),{success:!0,message:`Comprobante enviado a ${l.email}. ${l.requiresPaymentComplement?"Recordatorio programado.":"Pago completado."}`}}catch(c){return console.error("[Treasury Automation] Error sending receipt:",c),{success:!1,message:"Error al enviar comprobante"}}}static async scheduleComplementReminder(r,e){try{let o=[3,7,14];for(let c of o){let l=new Date;l.setDate(l.getDate()+c),console.log(`[Treasury Automation] Recordatorio programado para ${l.toISOString()}`)}}catch(o){console.error("[Treasury Automation] Error scheduling reminder:",o)}}static async sendComplementReminder(r,e){try{let o=await P.query.clients.findFirst({where:nt(ne.id,e)});if(!o||!o.email)return{success:!1,message:"Cliente sin email configurado"};let c=await P.query.paymentVouchers.findFirst({where:nt(W.id,r)});if(!c)return{success:!1,message:"Comprobante no encontrado"};if(c.status!=="pendiente_complemento")return{success:!1,message:"El complemento ya fue recibido"};let l={to:o.email,from:"noreply@econova.com.mx",subject:`\u23F0 Recordatorio: Complemento de Pago Pendiente - ${o.name}`,html:`
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); padding: 20px; text-align: center;">
              <h1 style="color: white; margin: 0; font-size: 24px;">\u23F0 Recordatorio - Complemento de Pago</h1>
            </div>
            
            <div style="padding: 30px; background: #f8f9fa;">
              <h2 style="color: #333; margin-bottom: 20px;">Hola ${o.name},</h2>
              
              <p style="color: #666; line-height: 1.6; margin-bottom: 20px;">
                Te recordamos que a\xFAn necesitamos el complemento de pago para completar el proceso.
              </p>
              
              <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h3 style="color: #856404; margin-top: 0;">\u{1F4CB} Acci\xF3n Requerida</h3>
                <p style="color: #856404; margin-bottom: 15px;">
                  Por favor, env\xEDa el complemento de pago correspondiente para que podamos finalizar el proceso.
                </p>
                <p style="color: #856404; margin-bottom: 0; font-weight: bold;">
                  Puedes enviarlo respondiendo a este correo o contact\xE1ndonos directamente.
                </p>
              </div>

              <div style="text-align: center; margin-top: 30px;">
                <p style="color: #666; font-size: 14px;">
                  Gracias por tu colaboraci\xF3n.
                </p>
                <p style="color: #999; font-size: 12px; margin-top: 20px;">
                  Este es un recordatorio autom\xE1tico del sistema EcoNova.
                </p>
              </div>
            </div>
          </div>
        `};return await Xt.send(l),{success:!0,message:`Recordatorio enviado a ${o.email}`}}catch(o){return console.error("[Treasury Automation] Error sending reminder:",o),{success:!1,message:"Error al enviar recordatorio"}}}static async processAutomaticFlow(r,e,o){try{console.log(`\u{1F916} [TreasuryAutomation] Iniciando flujo autom\xE1tico para voucher ${r}, empresa ${o}`);let c=await P.query.clients.findFirst({where:nt(ne.id,e)});if(!c)return{success:!1,message:"Cliente no encontrado",nextStatus:"error"};if(c.companyId!==o)return console.error(`\u274C [TreasuryAutomation] Cliente ${e} no pertenece a empresa ${o}`),{success:!1,message:"Cliente no pertenece a la empresa seleccionada",nextStatus:"error"};let l=await this.sendPaymentReceiptToSupplier(r,e,o);if(!l.success)return{success:!1,message:l.message,nextStatus:"error"};let p=c.requiresPaymentComplement?"pendiente_complemento":"factura_pagada";return console.log(`\u2705 [TreasuryAutomation] Flujo autom\xE1tico completado para voucher ${r}, empresa ${o}`),{success:!0,message:`Comprobante enviado autom\xE1ticamente a ${c.name}. ${c.requiresPaymentComplement?"Recordatorios programados.":"Proceso completado."}`,nextStatus:p}}catch(c){return console.error("[Treasury Automation] Error in automatic flow:",c),{success:!1,message:"Error en el flujo autom\xE1tico",nextStatus:"error"}}}}});var an={};pe(an,{seedProductionData:()=>Oo});async function Oo(){try{console.log("\u{1F331} Iniciando seeding de datos de producci\xF3n...");let a=await P.select().from(ue),r=await P.select().from(J),e=await x.getKpis();if(console.log(`\u{1F4CA} Estado actual: companies=${a.length}, areas=${r.length}, kpis=${e.length}`),a.length>=2&&r.length>=12&&e.length>=5)return console.log("\u2705 Base de datos ya tiene datos completos"),{success:!0,message:"Database already seeded",companies:a.length,areas:r.length,kpis:e.length};let o=a;if(a.length<2){console.log("\u{1F4CA} Insertando companies faltantes...");let h=a.some(i=>i.id===1),b=a.some(i=>i.id===2),T=[];h||T.push({id:1,name:"Dura International",description:"Empresa l\xEDder en la industria qu\xEDmica",sector:"Qu\xEDmica"}),b||T.push({id:2,name:"Grupo Orsega",description:"Empresa especializada en productos qu\xEDmicos",sector:"Qu\xEDmica"}),T.length>0&&await P.insert(ue).values(T),o=await P.select().from(ue)}if(r.length<12){console.log("\u{1F3E2} Insertando areas faltantes...");let h=[{id:1,name:"Ventas",description:"\xC1rea de Ventas para Dura International",companyId:1},{id:2,name:"Log\xEDstica",description:"\xC1rea de Log\xEDstica para Dura International",companyId:1},{id:3,name:"Contabilidad y Finanzas",description:"\xC1rea de Contabilidad y Finanzas para Dura International",companyId:1},{id:4,name:"Ventas",description:"\xC1rea de Ventas para Grupo Orsega",companyId:2},{id:5,name:"Log\xEDstica",description:"\xC1rea de Log\xEDstica para Grupo Orsega",companyId:2},{id:6,name:"Contabilidad y Finanzas",description:"\xC1rea de Contabilidad y Finanzas para Grupo Orsega",companyId:2},{id:7,name:"Compras",description:"\xC1rea de Compras para Dura International",companyId:1},{id:8,name:"Almac\xE9n",description:"\xC1rea de Almac\xE9n para Dura International",companyId:1},{id:9,name:"Tesorer\xEDa",description:"\xC1rea de Tesorer\xEDa para Dura International",companyId:1},{id:10,name:"Compras",description:"\xC1rea de Compras para Grupo Orsega",companyId:2},{id:11,name:"Almac\xE9n",description:"\xC1rea de Almac\xE9n para Grupo Orsega",companyId:2},{id:12,name:"Tesorer\xEDa",description:"\xC1rea de Tesorer\xEDa para Grupo Orsega",companyId:2}],b=r.map(i=>i.id),T=h.filter(i=>!b.includes(i.id));T.length>0&&await P.insert(J).values(T)}if(e.length<5){console.log("\u{1F4C8} Insertando KPIs faltantes de Grupo Orsega...");let h=[{id:2,name:"Precisi\xF3n en estados financieros",description:"Mide la exactitud de los estados financieros generados. Objetivo: cero errores en emisi\xF3n de informaci\xF3n financiera.",areaId:6,companyId:2,unit:"%",target:"100%",frequency:"monthly",calculationMethod:"Conteo de errores y salvedades",responsible:"Mario Reynoso",invertedMetric:!1},{id:4,name:"Velocidad de rotaci\xF3n de cuentas por cobrar",description:"Mide el tiempo promedio para cobrar cuentas pendientes",areaId:6,companyId:2,unit:"d\xEDas",target:"60 d\xEDas",frequency:"monthly",calculationMethod:"Promedio de d\xEDas para cobrar",responsible:"Mario Reynoso",invertedMetric:!0},{id:6,name:"Cumplimiento de obligaciones fiscales",description:"Monitoreo mediante checklist para la presentaci\xF3n de impuestos",areaId:6,companyId:2,unit:"%",target:"100%",frequency:"monthly",calculationMethod:"Checklist de obligaciones fiscales",responsible:"Mario Reynoso",invertedMetric:!1},{id:8,name:"Facturaci\xF3n sin errores",description:"Mide la precisi\xF3n en la generaci\xF3n de facturas",areaId:6,companyId:2,unit:"%",target:"100%",frequency:"weekly",calculationMethod:"(Facturas sin errores / Total de facturas) x 100",responsible:"Mario Reynoso",invertedMetric:!1},{id:10,name:"Volumen de ventas alcanzado",description:"Volumen de ventas en unidades",areaId:4,companyId:2,unit:"unidades",target:"10.300.476 unidades",frequency:"monthly",calculationMethod:"Suma de unidades vendidas en el per\xEDodo",responsible:"Omar Navarro",invertedMetric:!1}],b=e.map(i=>i.id),T=h.filter(i=>!b.includes(i.id));T.length>0&&await P.insert(kpis).values(T)}let c=await P.select().from(ue),l=await P.select().from(J),p=await P.select().from(kpis);return console.log("\u2705 Seeding completado exitosamente!"),{success:!0,message:"Production database seeded successfully",companies:c.length,areas:l.length,kpis:p.length}}catch(a){return console.error("\u274C Error durante el seeding:",a),{success:!1,message:"Seeding failed",error:a instanceof Error?a.message:String(a)}}}var sn=de(()=>{"use strict";le();ie();et()});var St={};pe(St,{analyzePaymentDocument:()=>Fo});import Uo from"openai";async function Ko(){try{let a=await import("pdf-parse");if(typeof a=="function")return a;if(a.default&&typeof a.default=="function")return a.default;if(a.pdfParse&&typeof a.pdfParse=="function")return a.pdfParse;throw new Error(`\u274C pdf-parse no exporta funci\xF3n v\xE1lida. Keys: ${Object.keys(a||{}).join(", ")}`)}catch(a){throw console.error("\u274C [Document Analyzer] Error importando pdf-parse:",a),new Error(`Error al importar pdf-parse: ${a.message}`)}}async function Fo(a,r){let e=process.env.OPENAI_API_KEY;if(!e)throw new Error("\u274C OPENAI_API_KEY no est\xE1 configurado");let o=new Uo({apiKey:e}),c="",l="";console.log(`\u{1F50D} [Document Analyzer] Analizando documento tipo: ${r}`);try{r.includes("pdf")?c=(await(await Ko())(a)).text.trim():l=a.toString("base64");let p=r.includes("png")?"image/png":"image/jpeg",h=l?`data:${p};base64,${l}`:"",b=`
Eres un analista experto en documentos fiscales y financieros mexicanos.
Analiza el documento (texto o imagen) y devuelve **\xFAnicamente** JSON v\xE1lido.

### Campos esperados:
{
  "documentType": "invoice" | "rep" | "voucher" | "cxp" | "unknown",
  "supplierName": "nombre del emisor o proveedor",
  "taxId": "RFC del emisor o proveedor",
  "beneficiaryName": "nombre del receptor o cliente",
  "invoiceNumber": "folio o n\xFAmero de factura",
  "relatedInvoiceUUID": "folio fiscal o UUID relacionado",
  "date": "YYYY-MM-DD",
  "dueDate": "YYYY-MM-DD",
  "currency": "MXN" | "USD",
  "amount": n\xFAmero total (solo n\xFAmero, sin s\xEDmbolos),
  "subtotal": n\xFAmero subtotal (solo n\xFAmero),
  "tax": n\xFAmero de IVA (solo n\xFAmero),
  "paymentMethod": "PUE" | "PPD" | null,
  "bank": "nombre del banco o forma de pago",
  "reference": "n\xFAmero de operaci\xF3n o referencia bancaria",
  "originAccount": "CLABE o cuenta origen",
  "destinationAccount": "CLABE o cuenta destino",
  "trackingKey": "clave de rastreo SPEI",
  "status": "pendiente" | "pagado" | "vencido" | null,
  "notes": "descripci\xF3n o concepto del pago o factura"
}

### Clasificaci\xF3n del documento:
- Usa **"invoice"** si contiene palabras como \u201CCFDI\u201D, \u201CFactura\u201D, \u201CRFC\u201D, \u201CFolio Fiscal\u201D, \u201CVersi\xF3n 4.0\u201D.
- Usa **"rep"** si contiene \u201CComplemento de Pago\u201D, \u201CCFDI de Pago\u201D, \u201CUUID Relacionado\u201D.
- Usa **"voucher"** si contiene \u201CSPEI\u201D, \u201CTransferencia\u201D, \u201CBanco\u201D, \u201CComprobante de pago\u201D.
- Usa **"cxp"** si contiene m\xFAltiples l\xEDneas o registros de Cuentas por Pagar.
- Usa **"unknown"** si no se puede determinar.

### Reglas adicionales:
- Devuelve SIEMPRE JSON v\xE1lido (objeto o array).
- Si hay varios registros (CxP), devuelve un array.
- No agregues texto adicional ni explicaciones.
`,T;r.includes("pdf")?T=await o.chat.completions.create({model:"gpt-4o",messages:[{role:"user",content:`${b}

Texto del documento:
${c.slice(0,15e3)}`}],temperature:.1,max_tokens:2e3}):T=await o.chat.completions.create({model:"gpt-4o",messages:[{role:"user",content:[{type:"text",text:b},{type:"image_url",image_url:{url:h}}]}],temperature:.1,max_tokens:2e3});let i=T.choices[0]?.message?.content?.trim()||"";console.log(`\u{1F9E0} [Document Analyzer] OpenAI output: ${i.slice(0,400)}...`);let n;try{let d=i.match(/\[.*\]|\{.*\}/s);n=JSON.parse(d?d[0]:i)}catch{let d=c.toLowerCase();n={documentType:/rep|complemento de pago/.test(d)?"rep":/factura|cfdi|folio fiscal|versin 4\.0/.test(d)?"invoice":/spei|clabe|banco|transferencia/.test(d)?"voucher":/cuentas por pagar|cxp|proveedor/.test(d)?"cxp":"unknown"}}if(Array.isArray(n)){let d=n.map(u=>({supplierName:u.supplierName||u.proveedor||"",amount:u.amount?parseFloat(String(u.amount)):0,currency:u.currency||"MXN",dueDate:u.dueDate?new Date(u.dueDate):new Date,reference:u.reference||u.folio||u.factura||null,status:u.status||null,notes:u.notes||null}));return console.log(`\u2705 [Document Analyzer] ${d.length} registros CxP detectados`),{documentType:"cxp",extractedAmount:d.reduce((u,g)=>u+(g.amount||0),0),extractedDate:new Date,extractedCurrency:"MXN",extractedReference:`CxP_${d.length}_registros`,extractedBank:null,extractedOriginAccount:null,extractedDestinationAccount:null,extractedTrackingKey:null,ocrConfidence:.95,rawResponse:i,cxpRecords:d}}let t=n.documentType||"unknown",s={documentType:t,extractedSupplierName:n.supplierName||null,extractedTaxId:n.taxId||null,extractedBeneficiaryName:n.beneficiaryName||null,extractedInvoiceNumber:n.invoiceNumber||null,relatedInvoiceUUID:n.relatedInvoiceUUID||null,extractedDate:n.date?new Date(n.date):null,extractedDueDate:n.dueDate?new Date(n.dueDate):null,extractedCurrency:n.currency||"MXN",extractedAmount:n.amount?parseFloat(n.amount):null,extractedSubtotal:n.subtotal?parseFloat(n.subtotal):null,extractedTax:n.tax?parseFloat(n.tax):null,paymentMethod:n.paymentMethod||null,extractedBank:n.bank||null,extractedReference:n.reference||null,extractedOriginAccount:n.originAccount||null,extractedDestinationAccount:n.destinationAccount||null,extractedTrackingKey:n.trackingKey||null,notes:n.notes||null,ocrConfidence:t==="invoice"?ko(n):Vo(n),rawResponse:i};return console.log(`\u2705 [Document Analyzer] Tipo=${t} | Monto=${s.extractedAmount} | Conf=${(s.ocrConfidence*100).toFixed(1)}%`),s}catch(p){throw console.error("\u274C [Document Analyzer] Error durante an\xE1lisis:",p),new Error(`Error al analizar documento: ${p}`)}}function ko(a){let r=["supplierName","taxId","amount","invoiceNumber","relatedInvoiceUUID"],e=["currency","dueDate","paymentMethod","bank"],o=r.filter(l=>!!a[l]).length/r.length,c=e.filter(l=>!!a[l]).length/e.length;return+(.85*o+.15*c).toFixed(2)}function Vo(a){let r=["amount","date","currency","bank","reference"],e=["originAccount","destinationAccount","trackingKey","beneficiaryName","relatedInvoiceUUID"],o=r.filter(l=>!!a[l]).length/r.length,c=e.filter(l=>!!a[l]).length/e.length;return+(.8*o+.2*c).toFixed(2)}var wt=de(()=>{"use strict"});var cn={};pe(cn,{fetchDOFExchangeRate:()=>lt,initializeDOFScheduler:()=>nr});import tr from"node-cron";async function lt(){try{console.log("\u{1F504} [DOF Scheduler] Obteniendo tipo de cambio del DOF...");let a=process.env.BANXICO_TOKEN;a||console.warn("\u26A0\uFE0F  [DOF Scheduler] BANXICO_TOKEN no configurado en variables de entorno");let r=await fetch("https://www.banxico.org.mx/SieAPIRest/service/v1/series/SF43718/datos/oportuno",{headers:{"Bmx-Token":a||""}});if(!r.ok){let b=await r.text();console.warn(`\u26A0\uFE0F  [DOF Scheduler] Error HTTP ${r.status}: ${b}`),console.warn("\u26A0\uFE0F  [DOF Scheduler] No se pudo obtener el tipo de cambio oficial, usando valores estimados");let T=new Date;if(T.setHours(T.getHours()-2),await P.query.exchangeRates.findFirst({where:(d,{and:u,eq:g,gte:y})=>u(g(d.source,"DOF"),y(d.date,T)),orderBy:(d,{desc:u})=>[u(d.date)]})){console.log("\u2139\uFE0F  [DOF Scheduler] Ya existe un registro reciente, no se insertar\xE1 duplicado");return}let n=18.35+(Math.random()*.2-.1),t=Number(n.toFixed(4)),s=Number((n+.04).toFixed(4));await P.insert(Z).values({buyRate:t,sellRate:s,source:"DOF",notes:"Actualizaci\xF3n autom\xE1tica (estimado)",date:new Date,createdBy:rr}),console.log(`\u2705 [DOF Scheduler] Tipo de cambio insertado: Compra ${t}, Venta ${s}`);return}let e=await r.json();if(!e?.bmx?.series?.[0]?.datos?.[0]?.dato)throw console.error("\u274C [DOF Scheduler] Estructura de respuesta de Banxico inesperada:",JSON.stringify(e)),new Error("Estructura de respuesta inv\xE1lida");let o=parseFloat(e.bmx.series[0].datos[0].dato);if(isNaN(o))throw console.error("\u274C [DOF Scheduler] Valor de tipo de cambio inv\xE1lido:",e.bmx.series[0].datos[0].dato),new Error("Valor de tipo de cambio inv\xE1lido");let c=new Date;c.setHours(c.getHours()-2);let l=await P.query.exchangeRates.findFirst({where:(b,{and:T,eq:i,gte:n})=>T(i(b.source,"DOF"),n(b.date,c)),orderBy:(b,{desc:T})=>[T(b.date)]});if(l&&Math.abs(l.buyRate-o)<1e-4){console.log("\u2139\uFE0F  [DOF Scheduler] El tipo de cambio no ha cambiado, no se insertar\xE1 duplicado");return}let p=Number(o.toFixed(4)),h=Number(o.toFixed(4));await P.insert(Z).values({buyRate:p,sellRate:h,source:"DOF",notes:"Actualizaci\xF3n autom\xE1tica desde Banxico",date:new Date,createdBy:rr}),console.log(`\u2705 [DOF Scheduler] Tipo de cambio insertado desde Banxico: Compra ${p}, Venta ${h}`)}catch(a){console.error("\u274C [DOF Scheduler] Error al obtener tipo de cambio:",a);let r=new Date;if(r.setHours(r.getHours()-2),await P.query.exchangeRates.findFirst({where:(p,{and:h,eq:b,gte:T})=>h(b(p.source,"DOF"),T(p.date,r)),orderBy:(p,{desc:h})=>[h(p.date)]})){console.log("\u2139\uFE0F  [DOF Scheduler] Ya existe un registro reciente, no se insertar\xE1 fallback");return}let o=18.35+(Math.random()*.2-.1),c=Number(o.toFixed(4)),l=Number((o+.04).toFixed(4));await P.insert(Z).values({buyRate:c,sellRate:l,source:"DOF",notes:"Actualizaci\xF3n autom\xE1tica (fallback)",date:new Date,createdBy:rr}),console.log(`\u2705 [DOF Scheduler] Tipo de cambio insertado (fallback): Compra ${c}, Venta ${l}`)}}function nr(){console.log("\u{1F680} [DOF Scheduler] Ejecutando actualizaci\xF3n inicial..."),lt().catch(a=>{console.error("\u274C [DOF Scheduler] Error en actualizaci\xF3n inicial:",a)}),tr.schedule("0 9 * * *",async()=>{console.log("\u23F0 [DOF Scheduler] Ejecutando actualizaci\xF3n programada de 9:00 AM (Hora de M\xE9xico)"),await lt()},{timezone:"America/Mexico_City"}),tr.schedule("0 12 * * *",async()=>{console.log("\u23F0 [DOF Scheduler] Ejecutando actualizaci\xF3n programada de 12:00 PM (Hora de M\xE9xico)"),await lt()},{timezone:"America/Mexico_City"}),tr.schedule("0 17 * * *",async()=>{console.log("\u23F0 [DOF Scheduler] Ejecutando actualizaci\xF3n programada de 5:00 PM (Hora de M\xE9xico)"),await lt()},{timezone:"America/Mexico_City"}),console.log("\u{1F4C5} [DOF Scheduler] Programador de tipo de cambio DOF inicializado"),console.log("\u23F0 Actualizaciones autom\xE1ticas programadas:"),console.log("   - 9:00 AM (Hora de M\xE9xico)"),console.log("   - 12:00 PM (Hora de M\xE9xico)"),console.log("   - 5:00 PM (Hora de M\xE9xico)"),console.log("\u2705 El scheduler est\xE1 activo y funcionando. Las actualizaciones se ejecutar\xE1n autom\xE1ticamente.")}var rr,or=de(()=>{"use strict";le();ie();rr=23});var ar={};pe(ar,{importBanxicoHistoricalData:()=>dn,importSeptemberOctober2025:()=>qo});async function dn(a,r){let e=process.env.BANXICO_TOKEN;if(!e)throw new Error("BANXICO_TOKEN no est\xE1 configurado");let o=`${Lo}/series/${ln}/datos/${a}/${r}`;console.log(`\u{1F4E5} [Banxico Import] Importando datos desde ${a} hasta ${r}...`);try{let c=await fetch(o,{headers:{"Bmx-Token":e}});if(!c.ok)throw new Error(`Error en API Banxico: ${c.status} ${c.statusText}`);let p=(await c.json()).bmx.series[0]?.datos||[];console.log(`\u{1F4CA} [Banxico Import] Recibidos ${p.length} registros`);let h=0,b=0;for(let T of p){let[i,n,t]=T.fecha.split("/"),s=`${t}-${n}-${i}`,d=parseFloat(T.dato),u=d.toFixed(4),g=d.toFixed(4);if(await P.query.exchangeRates.findFirst({where:(m,{and:f,eq:I})=>f(I(m.source,"DOF"),I(m.date,new Date(`${s}T09:00:00`)))})){b++;continue}await P.insert(Z).values({buyRate:Number(u),sellRate:Number(g),source:"DOF",notes:`Importado de Banxico (Serie ${ln})`,date:new Date(`${s}T09:00:00`),createdBy:23}),h++}return console.log(`\u2705 [Banxico Import] Importados: ${h}, Omitidos (ya exist\xEDan): ${b}`),{success:!0,imported:h,skipped:b,total:p.length}}catch(c){throw console.error("\u274C [Banxico Import] Error:",c),c}}async function qo(){console.log("\u{1F680} [Banxico Import] Iniciando importaci\xF3n de Sept-Oct 2025...");let a=await dn("2025-09-01","2025-10-31");return console.log("\u{1F389} [Banxico Import] Importaci\xF3n completada:",a),a}var Lo,ln,sr=de(()=>{"use strict";le();ie();Lo="https://www.banxico.org.mx/SieAPIRest/service/v1",ln="SF43718"});var un={};pe(un,{IdrallParser:()=>ir});import*as xt from"xlsx";import{z as ce}from"zod";var Bo,ir,mn=de(()=>{"use strict";Bo=ce.object({fecha:ce.string().optional(),fecha_pago:ce.string().optional(),monto:ce.number().optional(),importe:ce.number().optional(),proveedor:ce.string().optional(),cliente:ce.string().optional(),concepto:ce.string().optional(),descripcion:ce.string().optional(),referencia:ce.string().optional(),banco:ce.string().optional(),cuenta:ce.string().optional(),moneda:ce.string().optional(),factura:ce.string().optional(),folio:ce.string().optional(),vencimiento:ce.string().optional(),status:ce.string().optional()}),ir=class{static async parseExcel(r){try{console.log(`\u{1F4CA} [IdrallParser] Procesando archivo: ${r}`);let e=xt.readFile(r),o=e.SheetNames[0],c=e.Sheets[o],l=xt.utils.sheet_to_json(c,{header:1});if(l.length<2)return{success:!1,payments:[],errors:["El archivo Excel est\xE1 vac\xEDo o no tiene datos"],totalRows:0};let p=l[0];console.log("\u{1F4CB} [IdrallParser] Headers encontrados:",p);let h=this.mapHeaders(p);console.log("\u{1F504} [IdrallParser] Mapeo de headers:",h);let b=[],T=[],i=0;for(let n=1;n<l.length;n++){let t=l[n];if(!(!t||t.length===0))try{let s=this.mapRowData(t,h,p),d=Bo.parse(s);(d.monto||d.importe)&&(b.push(d),i++)}catch(s){let d=`Fila ${n+1}: ${s instanceof Error?s.message:"Error desconocido"}`;T.push(d),console.warn(`\u26A0\uFE0F [IdrallParser] ${d}`)}}return console.log(`\u2705 [IdrallParser] Procesamiento completado: ${i} pagos v\xE1lidos, ${T.length} errores`),{success:i>0,payments:b,errors:T,totalRows:l.length-1}}catch(e){return console.error("\u274C [IdrallParser] Error procesando Excel:",e),{success:!1,payments:[],errors:[`Error procesando archivo: ${e instanceof Error?e.message:"Error desconocido"}`],totalRows:0}}}static mapHeaders(r){let e={};return r.forEach((o,c)=>{if(!o)return;let l=o.toLowerCase().trim();l.includes("fecha")&&l.includes("pago")?e[`col_${c}`]="fecha_pago":l.includes("fecha")?e[`col_${c}`]="fecha":l.includes("monto")||l.includes("importe")?e[`col_${c}`]="monto":l.includes("proveedor")||l.includes("supplier")?e[`col_${c}`]="proveedor":l.includes("cliente")||l.includes("client")?e[`col_${c}`]="cliente":l.includes("concepto")||l.includes("concept")?e[`col_${c}`]="concepto":l.includes("descripcion")||l.includes("description")?e[`col_${c}`]="descripcion":l.includes("referencia")||l.includes("reference")?e[`col_${c}`]="referencia":l.includes("banco")||l.includes("bank")?e[`col_${c}`]="banco":l.includes("cuenta")||l.includes("account")?e[`col_${c}`]="cuenta":l.includes("moneda")||l.includes("currency")?e[`col_${c}`]="moneda":l.includes("factura")||l.includes("invoice")?e[`col_${c}`]="factura":l.includes("folio")?e[`col_${c}`]="folio":l.includes("vencimiento")||l.includes("due")?e[`col_${c}`]="vencimiento":(l.includes("status")||l.includes("estado"))&&(e[`col_${c}`]="status")}),e}static mapRowData(r,e,o){let c={};return r.forEach((l,p)=>{let h=`col_${p}`,b=e[h];if(b&&l!==void 0&&l!==null&&l!=="")if(b==="monto"||b==="importe"){let T=parseFloat(String(l).replace(/[^0-9.-]/g,""));isNaN(T)||(c[b]=T)}else c[b]=String(l).trim()}),c}static async findMatchingClient(r,e){try{let{db:o}=await Promise.resolve().then(()=>(le(),Ke)),{clients:c}=await Promise.resolve().then(()=>(ie(),Ne)),{eq:l,and:p,or:h,ilike:b}=await import("drizzle-orm"),T=[r.proveedor,r.cliente,r.concepto,r.descripcion].filter(Boolean);if(T.length===0)return{found:!1,matchType:"none"};for(let i of T){let n=await o.query.clients.findFirst({where:p(l(c.companyId,e),b(c.name,`%${i}%`))});if(n)return{found:!0,client:n,matchType:"exact"}}for(let i of T){let n=await o.query.clients.findFirst({where:p(l(c.companyId,e),h(b(c.name,`%${i.split(" ")[0]}%`),b(c.email,`%${i}%`)))});if(n)return{found:!0,client:n,matchType:"partial"}}return{found:!1,matchType:"none"}}catch(o){return console.error("\u274C [IdrallParser] Error buscando cliente:",o),{found:!1,matchType:"none"}}}}});var mr={};pe(mr,{log:()=>Yo,serveStatic:()=>Qo,setupVite:()=>Xo});import Go from"express";import Pt from"fs";import mt from"path";import{nanoid as Ho}from"nanoid";async function Jo(){if(!dr||!ur){let a=await import("vite");dr=a.createLogger(),ur=a.createServer}return{viteLogger:dr,createViteServer:ur}}function Yo(a,r="express"){let e=new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0});console.log(`${e} [${r}] ${a}`)}async function Xo(a,r){let{viteLogger:e,createViteServer:o}=await Jo(),c;try{c=(await import("../vite.config.js")).default}catch{console.warn("\u26A0\uFE0F Could not load vite.config, using minimal config"),c={root:mt.resolve(import.meta.dirname,"..","client"),server:{}}}let l={middlewareMode:!0,hmr:{server:r,protocol:"ws",host:"localhost"},allowedHosts:!0},p=await o({...c,configFile:!1,customLogger:{...e,error:(h,b)=>{e.error(h,b),(h.includes("Failed to resolve")||h.includes("Cannot find module"))&&console.error("\u274C Critical Vite error - check your imports")}},server:l,appType:"custom"});a.use((h,b,T)=>{if(h.path.startsWith("/api/"))return T();p.middlewares(h,b,T)}),a.use("*",async(h,b,T)=>{let i=h.originalUrl;if(i.startsWith("/api/"))return T();try{let n=mt.resolve(import.meta.dirname,"..","client","index.html"),t=await Pt.promises.readFile(n,"utf-8");t=t.replace('src="/src/main.tsx"',`src="/src/main.tsx?v=${Ho()}"`);let s=await p.transformIndexHtml(i,t);b.status(200).set({"Content-Type":"text/html"}).end(s)}catch(n){p.ssrFixStacktrace(n),T(n)}})}function Qo(a){let r=mt.resolve(import.meta.dirname,"public"),e=mt.resolve(import.meta.dirname,"..","dist","public"),o=Pt.existsSync(r)?r:e;if(!Pt.existsSync(o)){console.error(`\u26A0\uFE0F WARNING: Could not find build directory at ${r} or ${e}`),console.error("\u26A0\uFE0F Static file serving disabled, but API and /health should still work");return}console.log(`\u2705 Serving static files from: ${o}`),a.use(Go.static(o,{maxAge:"1y",etag:!0,lastModified:!0,setHeaders:(c,l)=>{l.endsWith("index.html")&&(c.setHeader("Cache-Control","no-cache, no-store, must-revalidate"),c.setHeader("Pragma","no-cache"),c.setHeader("Expires","0"))}})),a.use("*",(c,l,p)=>{if(c.path.startsWith("/api/"))return p();let h=mt.resolve(o,"index.html");Pt.existsSync(h)?(l.setHeader("Cache-Control","no-cache, no-store, must-revalidate"),l.setHeader("Pragma","no-cache"),l.setHeader("Expires","0"),l.sendFile(h)):l.status(200).json({message:"Server running but frontend not found",healthcheck:"Use /health endpoint"})})}var dr,ur,pr=de(()=>{"use strict";dr=null,ur=null});import"dotenv/config";import Tt from"express";import{createServer as Zo}from"http";import{fileURLToPath as ea}from"url";import ta from"compression";et();import{hash as dt}from"bcryptjs";import{z as q}from"zod";import cr from"express-rate-limit";et();import $r from"jsonwebtoken";import lo from"bcrypt";if(!process.env.JWT_SECRET)throw new Error("FATAL: JWT_SECRET environment variable must be set. This is a critical security requirement. Application cannot start without it.");var _r=process.env.JWT_SECRET,uo="7d";function mo(a){return $r.sign({id:a.id,name:a.name,email:a.email,role:a.role,companyId:a.companyId},_r,{expiresIn:uo})}function po(a){try{return $r.verify(a,_r)}catch(r){return console.error("[JWT] Error al verificar token:",r),null}}function $(a,r,e){let o=a.headers.authorization,c=o&&o.split(" ")[1];if(console.log("[JWT Auth] ========== AUTENTICACI\xD3N =========="),console.log("[JWT Auth] Path:",a.path),console.log("[JWT Auth] Method:",a.method),console.log("[JWT Auth] Authorization header presente:",!!o),console.log("[JWT Auth] Authorization header completo:",o?`${o.substring(0,20)}...`:"null"),console.log("[JWT Auth] Token extra\xEDdo:",!!c),console.log("[JWT Auth] Todos los headers:",Object.keys(a.headers)),!c)return console.error("[JWT Auth] \u274C Token no encontrado"),console.error("[JWT Auth] Headers disponibles:",Object.keys(a.headers)),r.status(401).json({message:"Unauthorized",details:"No authentication token provided"});let l=po(c);if(!l)return r.status(401).json({message:"Unauthorized",details:"Invalid or expired token"});a.user=l,console.log(`[JWT Auth] Authenticated user: ID=${l.id}, Role=${l.role}`),e()}function tt(a,r,e){let o=a.user;if(!o||o.role!=="admin")return r.status(403).json({message:"Forbidden: Admin access required"});e()}async function go(a,r){try{if(!r||!a)return console.error("[Auth] Password o stored password vac\xEDo"),!1;if(r.startsWith("$2a$")||r.startsWith("$2b$")||r.startsWith("$2y$")){console.log("[Auth] Comparando con bcrypt (hash detectado)");let o=await lo.compare(a,r);return console.log(`[Auth] Resultado bcrypt.compare: ${o}`),o}console.log("[Auth] Comparando texto plano (fallback)");let e=a===r;return console.log(`[Auth] Resultado comparaci\xF3n texto plano: ${e} (supplied="${a}", stored="${r}")`),e}catch(e){return console.error("[Auth] Error comparando contrase\xF1as:",e),!1}}async function Dr(a,r){try{console.log(`[Auth] Intento de login para: ${a}`);let e=await x.getUserByUsername(a);if(!e)return console.log(`[Auth] Usuario no encontrado: ${a}`),null;console.log(`[Auth] Usuario encontrado: ID=${e.id}, Email=${e.email}, Password hash starts with: ${e.password?.substring(0,10)}`);let o=await go(r,e.password);if(console.log(`[Auth] Comparaci\xF3n de contrase\xF1a: ${o?"\u2705 MATCH":"\u274C NO MATCH"}`),!o)return console.log(`[Auth] Contrase\xF1a incorrecta para usuario: ${a}`),console.log(`[Auth] Detalles: Password proporcionada length=${r.length}, Stored password starts with=${e.password?.substring(0,10)}`),null;await x.updateUser(e.id,{lastLogin:new Date});let c=mo({id:e.id,name:e.name,email:e.email,role:e.role,companyId:e.companyId});console.log(`[Auth] Login exitoso para usuario: ${a}`);let{password:l,...p}=e;return{token:c,user:p}}catch(e){return console.error("[Auth] Error en login:",e),null}}ie();le();ie();import{gte as Rr,eq as jr,and as Mr,desc as yo}from"drizzle-orm";async function Or(a,r=30){let e=new Date;e.setDate(e.getDate()-r),e.setHours(0,0,0,0),console.log(`[getSourceSeries] \u{1F50D} DIAGN\xD3STICO - ${a}:`,{days:r,cutoffDateISO:e.toISOString(),cutoffDateLocal:e.toLocaleString("es-MX",{timeZone:"America/Mexico_City"}),fechaActual:new Date().toISOString(),fechaActualLocal:new Date().toLocaleString("es-MX",{timeZone:"America/Mexico_City"})});let o=await P.select({date:Z.date,buy:Z.buyRate,sell:Z.sellRate}).from(Z).where(Mr(jr(Z.source,a),Rr(Z.date,e))).orderBy(yo(Z.date));if(console.log(`[getSourceSeries] ${a}: ${o.length} registros encontrados`),o.length>0){let p=o[0];console.log(`[getSourceSeries] ${a} - M\xE1s reciente (RAW):`,{dateType:typeof p.date,dateValue:p.date,dateString:String(p.date),dateISO:p.date instanceof Date?p.date.toISOString():"NOT A DATE",dateLocal:p.date instanceof Date?p.date.toLocaleString("es-MX",{timeZone:"America/Mexico_City"}):"NOT A DATE",buy:p.buy,sell:p.sell})}let c=o.map(p=>{let h;return p.date instanceof Date?h=p.date:typeof p.date=="string"?h=new Date(p.date):h=new Date(p.date),{date:h.toISOString(),buy:p.buy,sell:p.sell}}),l=null;if(o.length>0){let p=o[0].date;p instanceof Date?l=p.toISOString():l=new Date(p).toISOString()}return{source:a,series:c,last_update:l}}function ho(a,r="sell"){if(a.length<2)return"N/D";let e=a[a.length-1],o=new Date(e.date);o.setDate(o.getDate()-7);let c=null,l=1/0;for(let h of a){let b=Math.abs(h.date.getTime()-o.getTime());b<l&&(l=b,c=h)}if(!c||c===e)return"N/D";let p=(e[r]-c[r])/c[r]*100;return p>=.5?"Alcista":p<=-.5?"Bajista":"Estable"}function fo(a,r="sell"){if(a.length<3)return"N/D";let e=a.slice(-6);if(e.length<3)return"N/D";let o=[];for(let l=1;l<e.length;l++){let p=e[l-1][r],h=e[l][r];if(p!==0){let b=Math.abs((h-p)/p)*100;o.push(b)}}if(o.length<3)return"N/D";let c=o.reduce((l,p)=>l+p,0)/o.length;return c>1?"Alta":c>=.5?"Media":"Baja"}function vo(a){if(a.length<10)return"Datos insuficientes";let e=a.slice(-30).map(b=>b.sell-b.buy),o=e[e.length-1],c=e.reduce((b,T)=>b+T,0)/e.length,p=e.map(b=>Math.pow(b-c,2)).reduce((b,T)=>b+T,0)/e.length,h=Math.sqrt(p);return h===0?"Spread estable":o>c+2*h?"Por encima del promedio 30d":o<c-2*h?"Por debajo del promedio 30d":"Dentro del rango normal"}async function Ur(a=30,r=25e3){let e=new Date;e.setDate(e.getDate()-a);let o=["MONEX","Santander","DOF"],c={};for(let g of o){let y=await P.select({date:Z.date,buy:Z.buyRate,sell:Z.sellRate}).from(Z).where(Mr(jr(Z.source,g),Rr(Z.date,e))).orderBy(Z.date);c[g]=y.map(m=>({date:m.date,buy:m.buy,sell:m.sell}))}let l={},p=null;for(let g of o){let y=c[g];if(y.length>0){let m=y[y.length-1];l[g]={buy:m.buy,sell:m.sell},(!p||m.date>p)&&(p=m.date)}else l[g]=null}let h=Object.entries(l).filter(([g,y])=>y!==null),b={source:"N/D",rate:0},T={source:"N/D",rate:0};if(h.length>0){let g=h.map(([m,f])=>({source:m,rate:f.buy})),y=h.map(([m,f])=>({source:m,rate:f.sell}));b=g.reduce((m,f)=>f.rate<m.rate?f:m),T=y.reduce((m,f)=>f.rate>m.rate?f:m)}let i=l.DOF,n=i?.buy??0,t=i?.sell??0;if(!i&&h.length>0){let g=h.reduce((m,[f,I])=>m+I.buy,0)/h.length,y=h.reduce((m,[f,I])=>m+I.sell,0)/h.length;n=g,t=y}let s=n>0?(n-b.rate)*r:0,d=t>0?(T.rate-t)*r:0,u=o.map(g=>{let y=c[g],m=l[g];if(!m||y.length===0)return{source:g,buy:0,sell:0,spread:0,spread_status:"Sin datos",trend_7d:"N/D",trend_pct:0,volatility_5d:"N/D"};let f=m.sell-m.buy,I=ho(y),E=fo(y),N=vo(y),C=(()=>{if(y.length<2)return 0;let A=y[y.length-1],w=new Date(A.date);w.setDate(w.getDate()-7);let S=null,D=1/0;for(let M of y){let O=Math.abs(M.date.getTime()-w.getTime());O<D&&(D=O,S=M)}return!S||S===A?0:(A.sell-S.sell)/S.sell*100})();return{source:g,buy:m.buy,sell:m.sell,spread:parseFloat(f.toFixed(4)),spread_status:N,trend_7d:I,trend_pct:parseFloat(C.toFixed(2)),volatility_5d:E}});return{as_of:p?p.toISOString():new Date().toISOString(),rates:l,best_buy:b,best_sell:T,baseline:{source:i?"DOF":"Promedio",buy:parseFloat(n.toFixed(4)),sell:parseFloat(t.toFixed(4))},savings_calculator:{if_buy_at_best_vs_baseline:parseFloat(s.toFixed(2)),if_sell_at_best_vs_baseline:parseFloat(d.toFixed(2))},spreads_analysis:u}}qt();rt();et();function Io(){let a=new Date,r=a.getDate(),e=Math.ceil(r/7),c=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][a.getMonth()],l=a.getFullYear(),p=`Semana ${e}`,h=`${p} - ${c} ${l}`;return{weekNumber:e,weekText:p,month:c,year:l,period:h}}async function Fr(a){try{if(!a||!a.value||!a.companyId)throw new Error("Faltan datos obligatorios: value y companyId son requeridos");console.log("[UpdateWeeklySales] Iniciando actualizaci\xF3n con datos:",a);let r;a.adminOverride&&a.weekNumber&&a.month&&a.year?(r={weekNumber:parseInt(a.weekNumber.replace("Semana ","")),weekText:a.weekNumber,month:a.month,year:a.year,period:`${a.weekNumber} - ${a.month} ${a.year}`},console.log("[UpdateWeeklySales] Modo ADMINISTRADOR - Per\xEDodo manual:",r)):(r=Io(),console.log("[UpdateWeeklySales] Modo NORMAL - Per\xEDodo autom\xE1tico:",r));let e=await x.getKpis(),o=a.companyId,c=e.find(w=>w.name.includes("Volumen de ventas")&&w.companyId===o);if(!c)throw new Error(`No se encontr\xF3 el KPI de volumen de ventas para la compa\xF1\xEDa ID: ${o}`);console.log(`[UpdateWeeklySales] Encontrado KPI: ${c.name} (ID: ${c.id})`);let h=!!(await x.getKpiValuesByKpi(c.id,c.companyId??o)).find(w=>w.period===r.period);console.log(`[UpdateWeeklySales] ${h?"Actualizando":"Creando"} registro para: ${r.period}`);let b=parseFloat(c.target.replace(/[^0-9.,]/g,"").replace(",","")),T=Math.round(b/12),i=Math.round(T/4);console.log(`[UpdateWeeklySales] Objetivos - Anual: ${b}, Mensual: ${T}, Semanal: ${i}`);let n=new Intl.NumberFormat("es-MX").format(a.value),t=o===1?"KG":"unidades",s=`${n} ${t}`,d=a.value/i*100,u=d>=95?"complies":d>=85?"alert":"not_compliant",g={companyId:c.companyId??o,kpiId:c.id,userId:a.userId||1,value:s,period:r.period,month:r.month,year:r.year,compliancePercentage:`${d.toFixed(1)}%`,status:u,comments:`${h?"Actualizaci\xF3n":"Registro"} semanal autom\xE1tico`,updatedBy:a.userId||1};console.log("[UpdateWeeklySales] Creando nuevo registro semanal");let y=await x.createKpiValue(g),f=(await x.getKpiValuesByKpi(c.id,c.companyId??o)).filter(w=>w.period.includes(r.month)&&w.period.includes(r.year.toString())&&w.period.includes("Semana")),I=0;f.forEach(w=>{let S=parseFloat(w.value.replace(/[^0-9.,]+/g,"").replace(",","."));isNaN(S)||(I+=S)});let E=new Intl.NumberFormat("es-MX").format(I);console.log(`[UpdateWeeklySales] Total mensual recalculado: ${E} ${t} (${f.length} semanas)`);let N=I/T*100,C=N>=95?"complies":N>=85?"alert":"not_compliant",A=`Total mensual: ${E} ${t} de ${f.length} semanas (${N.toFixed(1)}% del objetivo)`;return console.log(`[UpdateWeeklySales] M\xE9tricas mensuales - Compliance: ${N.toFixed(1)}%, Status: ${C}`),console.log("[UpdateWeeklySales] \u2705 Proceso completado exitosamente"),{success:!0,message:`${h?"Actualizaci\xF3n":"Registro"} semanal completado exitosamente`,weeklyRecord:y,currentPeriod:r,monthlyPreview:{totalValue:I,formattedValue:`${E} ${t}`,compliancePercentage:`${N.toFixed(1)}%`,status:C,weekCount:f.length,comment:A}}}catch(r){return console.error("[UpdateWeeklySales] \u274C Error al procesar actualizaci\xF3n:",r),{success:!1,message:r?.message||"Error desconocido al actualizar ventas semanales"}}}async function Bt(a,r,e){try{let o=new Date,c=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],l=r||(o.getMonth()===0?"Diciembre":c[o.getMonth()-1]),p=e||(o.getMonth()===0?o.getFullYear()-1:o.getFullYear());console.log(`[AutoCloseMonth] Cerrando mes ${l} ${p} para empresa ${a}`);let b=(await x.getKpis()).find(f=>f.name.includes("Volumen de ventas")&&f.companyId===a);if(!b)return console.error(`[AutoCloseMonth] No se encontr\xF3 KPI de volumen de ventas para empresa ${a}`),!1;let i=(await x.getKpiValuesByKpi(b.id,b.companyId??a)).filter(f=>f.period.includes(l)&&f.period.includes(p.toString())&&f.period.includes("Semana"));if(i.length===0)return console.log(`[AutoCloseMonth] No hay registros semanales para ${l} ${p}`),!1;let n=0;i.forEach(f=>{let I=parseFloat(f.value.replace(/[^0-9.,]+/g,"").replace(",","."));isNaN(I)||(n+=I)});let t=parseFloat(b.target.replace(/[^0-9.,]+/g,"").replace(",","")),s=Math.round(t/12),d=n/s*100,u=d>=95?"complies":d>=85?"alert":"not_compliant",g=a===1?"KG":"unidades",y=new Intl.NumberFormat("es-MX").format(n),m={kpiId:b.id,userId:i[i.length-1]?.userId||1,value:`${y} ${g}`,period:`${l} ${p}`,compliancePercentage:`${d.toFixed(1)}%`,status:u,comments:`Cierre autom\xE1tico mensual - suma de ${i.length} semanas`,updatedBy:null};return await x.createKpiValue(m),console.log(`[AutoCloseMonth] \u2705 Mes ${l} ${p} cerrado - Total: ${y} ${g}`),!0}catch(o){return console.error("[AutoCloseMonth] \u274C Error al cerrar mes:",o),!1}}import kr from"@sendgrid/mail";process.env.SENDGRID_API_KEY?kr.setApiKey(process.env.SENDGRID_API_KEY):console.log("\u26A0\uFE0F SENDGRID_API_KEY not set - email functionality disabled");async function zt(a){try{return await kr.send({to:a.to,from:a.from,subject:a.subject,text:a.text,html:a.html}),console.log(`[Email] Correo enviado exitosamente a ${a.to}`),!0}catch(r){return console.error("[Email] Error al enviar correo:",r),!1}}function Vr(a,r,e,o,c,l){let p=l==="urgent"?"#ef4444":l==="high"?"#f59e0b":l==="normal"?"#3b82f6":"#6b7280",h=c==="success"?"\u2705":c==="warning"?"\u26A0\uFE0F":c==="error"?"\u274C":"\u2139\uFE0F",b=`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Mensaje del Equipo - Econova</title>
      <style>
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          line-height: 1.6;
          color: #333;
          max-width: 600px;
          margin: 0 auto;
          padding: 20px;
          background-color: #f8fafc;
        }
        .container {
          background: white;
          border-radius: 12px;
          padding: 30px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          border: 1px solid #e2e8f0;
        }
        .header {
          text-align: center;
          margin-bottom: 30px;
          padding-bottom: 20px;
          border-bottom: 2px solid #273949;
        }
        .logo {
          font-size: 24px;
          font-weight: bold;
          color: #273949;
          margin-bottom: 10px;
        }
        .subtitle {
          color: #64748b;
          font-size: 14px;
        }
        .message-header {
          display: flex;
          align-items: center;
          margin-bottom: 20px;
          padding: 15px;
          background: #f1f5f9;
          border-radius: 8px;
          border-left: 4px solid ${p};
        }
        .message-icon {
          font-size: 24px;
          margin-right: 15px;
        }
        .message-info {
          flex: 1;
        }
        .message-title {
          font-size: 18px;
          font-weight: 600;
          color: #1e293b;
          margin-bottom: 5px;
        }
        .message-meta {
          font-size: 14px;
          color: #64748b;
        }
        .message-content {
          background: #fefefe;
          padding: 25px;
          border-radius: 8px;
          border: 1px solid #e2e8f0;
          margin: 20px 0;
          font-size: 16px;
          line-height: 1.7;
        }
        .sender-info {
          margin-top: 25px;
          padding-top: 20px;
          border-top: 1px solid #e2e8f0;
          text-align: center;
        }
        .sender-name {
          font-weight: 600;
          color: #273949;
          margin-bottom: 5px;
        }
        .company-info {
          color: #64748b;
          font-size: 14px;
        }
        .footer {
          margin-top: 30px;
          padding-top: 20px;
          border-top: 1px solid #e2e8f0;
          text-align: center;
          color: #64748b;
          font-size: 12px;
        }
        .priority-badge {
          display: inline-block;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 500;
          background: ${p};
          color: white;
          margin-left: 10px;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <div class="logo">ECONOVA</div>
          <div class="subtitle">Sistema de Gesti\xF3n de KPIs</div>
        </div>
        
        <div class="message-header">
          <div class="message-icon">${h}</div>
          <div class="message-info">
            <div class="message-title">
              ${e}
              <span class="priority-badge">${l==="urgent"?"Urgente":l==="high"?"Alta":l==="normal"?"Normal":"Baja"}</span>
            </div>
            <div class="message-meta">Mensaje del equipo para ${r}</div>
          </div>
        </div>
        
        <div class="message-content">
          ${o.replace(/\n/g,"<br>")}
        </div>
        
        <div class="sender-info">
          <div class="sender-name">Enviado por: Mario Reynoso (Gerente General)</div>
          <div class="company-info">Econova - Dura International & Grupo Orsega</div>
        </div>
        
        <div class="footer">
          <p>Este mensaje fue enviado desde el sistema de gesti\xF3n de KPIs de Econova.</p>
          <p>Para responder, inicia sesi\xF3n en el sistema o contacta directamente al remitente.</p>
        </div>
      </div>
    </body>
    </html>
  `,T=`
ECONOVA - Sistema de Gesti\xF3n de KPIs

${h} ${e}
Prioridad: ${l==="urgent"?"Urgente":l==="high"?"Alta":l==="normal"?"Normal":"Baja"}

Para: ${r}
De: Mario Reynoso (Gerente General)

Mensaje:
${o}

---
Este mensaje fue enviado desde el sistema de gesti\xF3n de KPIs de Econova.
Para responder, inicia sesi\xF3n en el sistema o contacta directamente al remitente.
  `.trim();return{html:b,text:T}}import{MailService as Eo}from"@sendgrid/mail";process.env.SENDGRID_API_KEY?new Eo().setApiKey(process.env.SENDGRID_API_KEY):console.log("\u26A0\uFE0F SENDGRID_API_KEY not set - SendGrid functionality disabled");async function Lr(a){try{let r={to:a.to,from:a.from,subject:a.subject};return a.text&&(r.text=a.text),a.html&&(r.html=a.html),a.attachments&&(r.attachments=a.attachments),await mailService.send(r),!0}catch(r){return console.error("SendGrid email error:",r),!1}}function qr(a,r){let e=`Comprobantes de Pago - ${a.supplier_name}`,o=r.map(p=>`<li>${p.file_name} (${p.file_type.toUpperCase()})</li>`).join(""),c=`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background: #273949; color: white; padding: 20px; text-align: center; }
        .content { background: #f9f9f9; padding: 20px; }
        .details { background: white; padding: 15px; margin: 15px 0; border-radius: 4px; }
        .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>Comprobantes de Pago</h1>
        </div>
        <div class="content">
          <p>Estimado proveedor,</p>
          <p>Le enviamos los siguientes comprobantes de pago:</p>
          <div class="details">
            <p><strong>Proveedor:</strong> ${a.supplier_name}</p>
            <p><strong>Monto:</strong> ${a.currency} ${a.amount}</p>
            <p><strong>Referencia:</strong> ${a.reference||"N/A"}</p>
          </div>
          <p><strong>Archivos adjuntos:</strong></p>
          <ul>
            ${o}
          </ul>
          <p>Saludos cordiales,<br>Equipo de Tesorer\xEDa ECONOVA</p>
        </div>
        <div class="footer">
          <p>Este es un correo autom\xE1tico. No responder.</p>
        </div>
      </div>
    </body>
    </html>
  `,l=`Comprobantes de Pago

Proveedor: ${a.supplier_name}
Monto: ${a.currency} ${a.amount}
Referencia: ${a.reference||"N/A"}

Archivos adjuntos:
${r.map(p=>`- ${p.file_name}`).join(`
`)}

Saludos,
Equipo de Tesorer\xEDa ECONOVA`;return{subject:e,html:c,text:l}}import{Router as $o}from"express";import{randomUUID as en}from"node:crypto";import{z as _o}from"zod";import{Pool as So}from"pg";var it=process.env.DATABASE_URL;if(!it)throw new Error("DATABASE_URL no est\xE1 definida");var wo=it.includes("sslmode=")?it:it+(it.includes("?")?"&":"?")+"sslmode=require",xo=new So({connectionString:wo,ssl:{rejectUnauthorized:!1},idleTimeoutMillis:3e4,connectionTimeoutMillis:1e4,max:8});async function z(a,r){let e=await xo.connect();try{return await e.query(a,r)}finally{e.release()}}import{z as K}from"zod";var he=()=>K.string().uuid(),Wt=K.coerce.number().int().positive(),Gt=K.string().email().optional().or(K.literal("").transform(()=>{})),Po=K.enum(["pendiente","asignando_transporte","confirmado","en_camino","retenido","entregado","cerrado"]),To=K.enum(["pickup","customs","delay","delivery","note"]),Br=K.object({id:Wt,name:K.string().min(2),rfc:K.string().optional(),email:Gt,billingAddr:K.string().optional(),shippingAddr:K.string().optional(),isActive:K.boolean().default(!0),companyId:Wt.optional()}),zr=Br.omit({id:!0}),Wr=Br.partial().extend({id:Wt}),Gr=K.object({id:he(),name:K.string().min(2),email:Gt,phone:K.string().optional(),contactName:K.string().optional(),notes:K.string().optional(),rating:K.number().min(0).max(5).optional(),isActive:K.boolean().default(!0)}),Ka=Gr.omit({id:!0}),Fa=Gr.partial().extend({id:he()}),Ao=K.object({id:he(),providerId:he(),type:K.enum(["email","api","portal"]),value:K.string().min(3),isDefault:K.boolean().default(!1)}),Hr=Ao.omit({id:!0}),Jr=K.object({id:he(),reference:K.string().min(2),clientId:he(),providerId:he().optional(),origin:K.string().min(2),destination:K.string().min(2),incoterm:K.string().optional(),status:Po.default("pendiente"),etd:K.string().datetime().optional(),eta:K.string().datetime().optional()}),Yr=Jr.omit({id:!0,status:!0}).extend({notifyClient:K.boolean().default(!1),customerEmail:Gt}),Xr=Jr.partial().extend({id:he()}),No=K.object({id:he(),shipmentId:he(),type:To,at:K.string().datetime(),lat:K.number().optional(),lng:K.number().optional(),notes:K.string().optional()}),Qr=No.omit({id:!0}),Co=K.object({id:he(),shipmentId:he(),kind:K.enum(["bl","factura","foto","otro"]),fileUrl:K.string().url(),uploadedAt:K.string().datetime().optional(),uploadedBy:K.string().optional()}),Zr=Co.omit({id:!0});ie();function Me(a,r){let e=a.user;if(!e)throw new Error("Unauthorized: User not authenticated");if(r==null){if(console.warn(`[TenantValidation] Warning: resourceCompanyId is null/undefined for user ${e.id}`),e.role!=="admin")throw new Error("Forbidden: Company access validation failed");return}if(e.role==="admin"){console.log(`[TenantValidation] Admin access granted to company ${r}`);return}if([1,2].includes(r)){console.log(`[TenantValidation] Access granted: User ${e.id} to company ${r} (allowed company)`);return}if(!e.companyId)throw console.error(`[TenantValidation] User ${e.id} has no companyId assigned and attempted to access company ${r} (not in allowed list)`),new Error(`Forbidden: Access denied to company ${r}`);if(e.companyId!==r)throw console.error(`[TenantValidation] Access denied: User ${e.id} (company ${e.companyId}) attempted to access company ${r} resources`),new Error(`Forbidden: Access denied to company ${r}`);console.log(`[TenantValidation] Access granted: User ${e.id} to company ${r}`)}function ct(a="companyId"){return(r,e,o)=>{try{let c=r.user,l=r.body[a],p;if(l==null||l==="")p=void 0;else if(typeof l=="string"){let h=parseInt(l,10);p=isNaN(h)?void 0:h}else typeof l=="number"?p=l:p=void 0;console.log(`[TenantValidation] Validando acceso para usuario ${c?.id} (${c?.name}), role: ${c?.role}, userCompanyId: ${c?.companyId}, resourceCompanyId: ${p} (raw: ${l}, type: ${typeof l})`),Me(r,p),o()}catch(c){console.error("[TenantValidation Middleware] Access denied:",c);let l=r.user;console.error(`[TenantValidation] Detalles del usuario: ID=${l?.id}, Name=${l?.name}, Role=${l?.role}, CompanyId=${l?.companyId}`),e.status(403).json({message:c instanceof Error?c.message:"Forbidden: Access denied",code:"TENANT_ACCESS_DENIED"})}}}var me=$o();me.get("/clients",async(a,r)=>{try{console.log("\u{1F535} [GET /clients] Endpoint llamado");let e=await z(`
      SELECT c.id, c.code, c.name, c.contact, c.email, c.company_id, c.is_active, c.notes, c.created_at, c.updated_at,
             comp.name as company_name
      FROM clients c
      LEFT JOIN companies comp ON c.company_id = comp.id
      WHERE c.is_active = TRUE 
      ORDER BY c.name
    `);console.log(`\u{1F4CA} [GET /clients] Retornando ${e.rows.length} clientes`),e.rows.length>0&&console.log("\u{1F4CB} Primer cliente:",JSON.stringify(e.rows[0],null,2)),r.json(e.rows)}catch(e){console.error("\u274C Error fetching clients:",e),r.status(500).json({error:"Failed to fetch clients"})}});me.post("/clients",ct("companyId"),async(a,r)=>{try{console.log("\u{1F535} [POST /clients] Creando nuevo cliente"),console.log("\u{1F4E5} Request body:",JSON.stringify(a.body,null,2));let o=a.user;if(!o)return r.status(401).json({error:"No autenticado"});console.log(`\u{1F464} Usuario: ${o.name} (ID: ${o.id}), Role: ${o.role}, CompanyId: ${o.companyId}`);let{phone:c,...l}=a.body,p=zr.parse(l);console.log("\u2705 Validated data:",JSON.stringify(p,null,2));let h=p.billingAddr||p.shippingAddr||null,b=a.body.companyId;if(!b)return r.status(400).json({error:"companyId es requerido"});let T=parseInt(b),i=o.role==="admin"||!o.companyId?T:o.companyId||T,n=await z(`
      INSERT INTO clients (name, email, is_active, company_id)
      VALUES ($1, $2, $3, $4)
      RETURNING *
    `,[p.name,p.email||null,p.isActive??!0,i]);console.log(`\u2705 [POST /clients] Cliente creado: ${n.rows[0].name}`),r.status(201).json(n.rows[0])}catch(e){if(console.error("\u274C Error creating client:",e),console.error("\u274C Error details:",e instanceof Error?e.message:String(e)),e?.code&&(console.error("\u274C Database error code:",e.code),console.error("\u274C Database error detail:",e.detail)),e instanceof _o.ZodError)return console.error("\u274C Validation errors:",JSON.stringify(e.errors,null,2)),r.status(400).json({error:"Validation failed",details:e.errors});r.status(400).json({error:"Failed to create client",message:e instanceof Error?e.message:String(e),details:e?.detail||void 0})}});me.patch("/clients/:id",async(a,r)=>{try{console.log(`\u{1F535} [PATCH /clients/${a.params.id}] Actualizando cliente`);let{phone:e,billingAddr:o,shippingAddr:c,...l}=a.body,p={...l,id:parseInt(a.params.id)};if(p.companyId!==void 0){p.companyId=parseInt(p.companyId);let d=a;d.user&&Me(d,p.companyId)}let h=Wr.parse(p),b=o||c||void 0,T=[],i=[],n=1,t={name:"name",email:"email",isActive:"is_active",companyId:"company_id",contactPerson:"contact_person",paymentTerms:"payment_terms",requiresReceipt:"requires_receipt",reminderFrequency:"reminder_frequency",clientCode:"client_code",secondaryEmail:"secondary_email",postalCode:"postal_code",emailNotifications:"email_notifications",customerType:"customer_type",requiresPaymentComplement:"requires_payment_complement",notes:"notes"};if(Object.entries(h).forEach(([d,u])=>{if(d!=="id"&&u!==void 0){let g=t[d];if(!g)return;T.push(`${g} = $${n}`),i.push(u),n++}}),T.length===0)return r.status(400).json({error:"No fields to update"});i.push(parseInt(a.params.id));let s=await z(`
      UPDATE clients SET ${T.join(", ")}, updated_at = NOW()
      WHERE id = $${n}
      RETURNING *
    `,i);if(s.rows.length===0)return r.status(404).json({error:"Client not found"});console.log(`\u2705 [PATCH /clients/${a.params.id}] Cliente actualizado: ${s.rows[0].name}`),r.json(s.rows[0])}catch(e){console.error("\u274C Error updating client:",e),r.status(400).json({error:"Failed to update client",message:e instanceof Error?e.message:String(e),details:e?.detail||void 0})}});me.delete("/clients/:id",async(a,r)=>{try{console.log(`\u{1F535} [DELETE /clients/${a.params.id}] Eliminando cliente`);let e=await z(`
      UPDATE clients SET is_active = FALSE, updated_at = NOW()
      WHERE id = $1
      RETURNING *
    `,[a.params.id]);if(e.rows.length===0)return r.status(404).json({error:"Client not found"});console.log(`\u2705 [DELETE /clients/${a.params.id}] Cliente eliminado: ${e.rows[0].name}`),r.json({message:"Client deleted successfully",client:e.rows[0]})}catch(e){console.error("\u274C Error deleting client:",e),r.status(500).json({error:"Failed to delete client"})}});me.get("/providers",async(a,r)=>{try{console.log("\u{1F535} [GET /providers] Endpoint llamado");let e=await z(`
      SELECT * FROM provider 
      WHERE is_active = TRUE
      ORDER BY name
    `);console.log(`\u{1F4CA} [GET /providers] Retornando ${e.rows.length} proveedores`),e.rows.length>0&&console.log("\u{1F4CB} Primer proveedor:",JSON.stringify(e.rows[0],null,2)),r.json(e.rows)}catch(e){console.error("\u274C Error fetching providers:",e),r.status(500).json({error:"Failed to fetch providers"})}});me.post("/providers",async(a,r)=>{try{let{name:e,email:o,phone:c,contactName:l,notes:p,rating:h,isActive:b,shortName:T,companyId:i,location:n,requiresRep:t,repFrequency:s,reminderEmail:d}=a.body,u=en(),g=await z(`
      INSERT INTO provider (id, name, email, phone, contact_name, notes, rating, is_active, short_name, company_id, location, requires_rep, rep_frequency, reminder_email)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14)
      RETURNING *
    `,[u,e,o,c||null,l||null,p||null,h||null,b??!0,T||null,i||null,n||null,t??!0,s||7,d||null]);r.status(201).json(g.rows[0])}catch(e){console.error("Error creating provider:",e),r.status(400).json({error:"Failed to create provider"})}});me.patch("/providers/:id",async(a,r)=>{try{let{name:e,email:o,phone:c,contactName:l,notes:p,rating:h,isActive:b,shortName:T,companyId:i,location:n,requiresRep:t,repFrequency:s,reminderEmail:d}=a.body,u=[],g=[],y=1,m={name:"name",email:"email",phone:"phone",contactName:"contact_name",shortName:"short_name",companyId:"company_id",location:"location",requiresRep:"requires_rep",repFrequency:"rep_frequency",reminderEmail:"reminder_email",notes:"notes",rating:"rating",isActive:"is_active"};if(Object.entries({name:e,email:o,phone:c,contactName:l,shortName:T,companyId:i,location:n,requiresRep:t,repFrequency:s,reminderEmail:d,notes:p,rating:h,isActive:b}).forEach(([I,E])=>{if(E!==void 0){let N=m[I]||I;u.push(`${N} = $${y}`),g.push(E),y++}}),u.length===0)return r.status(400).json({error:"No fields to update"});g.push(a.params.id);let f=await z(`
      UPDATE provider SET ${u.join(", ")}, updated_at = NOW()
      WHERE id = $${y}
      RETURNING *
    `,g);if(f.rows.length===0)return r.status(404).json({error:"Provider not found"});r.json(f.rows[0])}catch(e){console.error("Error updating provider:",e),r.status(400).json({error:"Failed to update provider"})}});me.delete("/providers/:id",async(a,r)=>{try{let e=await z(`
      UPDATE provider SET is_active = FALSE, updated_at = NOW()
      WHERE id = $1
      RETURNING *
    `,[a.params.id]);if(e.rows.length===0)return r.status(404).json({error:"Provider not found"});r.json({message:"Provider deleted successfully",provider:e.rows[0]})}catch(e){console.error("Error deleting provider:",e),r.status(500).json({error:"Failed to delete provider"})}});me.post("/providers/:id/channels",async(a,r)=>{try{let e=Hr.parse({...a.body,providerId:a.params.id}),o=en(),c=await z(`
      INSERT INTO provider_channel (id, provider_id, type, value, is_default)
      VALUES ($1, $2, $3, $4, $5)
      RETURNING *
    `,[o,e.providerId,e.type,e.value,e.isDefault]);r.status(201).json(c.rows[0])}catch(e){console.error("Error creating provider channel:",e),r.status(400).json({error:"Failed to create provider channel"})}});me.get("/suppliers",async(a,r)=>{try{console.log("\u{1F535} [GET /suppliers] Endpoint llamado");let e=await z(`
      SELECT s.*, c.name as company_name
      FROM suppliers s
      LEFT JOIN companies c ON s.company_id = c.id
      ORDER BY s.company_id, s.name
    `);console.log(`\u{1F4CA} [GET /suppliers] Retornando ${e.rows.length} proveedores de tesorer\xEDa`),r.json(e.rows)}catch(e){console.error("\u274C Error fetching suppliers:",e),r.status(500).json({error:"Failed to fetch suppliers"})}});me.post("/suppliers",ct("companyId"),async(a,r)=>{try{console.log("\u{1F535} [POST /suppliers] Creando nuevo proveedor de tesorer\xEDa");let e=bt.parse(a.body),o=await z(`
      INSERT INTO suppliers (
        name, short_name, email, location, requires_rep, 
        rep_frequency, company_id, is_active, notes
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
      RETURNING *
    `,[e.name,e.shortName,e.email,e.location,e.requiresRep,e.repFrequency,e.companyId,e.isActive,e.notes]);console.log(`\u2705 [POST /suppliers] Proveedor creado: ${o.rows[0].name}`),r.status(201).json(o.rows[0])}catch(e){console.error("\u274C Error creating supplier:",e),r.status(400).json({error:"Failed to create supplier"})}});me.patch("/suppliers/:id",async(a,r)=>{try{let{id:e}=a.params;console.log(`\u{1F535} [PATCH /suppliers/${e}] Actualizando proveedor`);let o=bt.partial().parse(a.body);if(o.companyId!==void 0){let l=a;l.user&&Me(l,o.companyId)}let c=await z(`
      UPDATE suppliers 
      SET 
        name = COALESCE($1, name),
        short_name = COALESCE($2, short_name),
        email = COALESCE($3, email),
        location = COALESCE($4, location),
        requires_rep = COALESCE($5, requires_rep),
        rep_frequency = COALESCE($6, rep_frequency),
        company_id = COALESCE($7, company_id),
        is_active = COALESCE($8, is_active),
        notes = COALESCE($9, notes),
        updated_at = NOW()
      WHERE id = $10
      RETURNING *
    `,[o.name,o.shortName,o.email,o.location,o.requiresRep,o.repFrequency,o.companyId,o.isActive,o.notes,e]);if(c.rows.length===0)return r.status(404).json({error:"Supplier not found"});console.log(`\u2705 [PATCH /suppliers/${e}] Proveedor actualizado: ${c.rows[0].name}`),r.json(c.rows[0])}catch(e){console.error("\u274C Error updating supplier:",e),r.status(400).json({error:"Failed to update supplier"})}});me.delete("/suppliers/:id",async(a,r)=>{try{let{id:e}=a.params;console.log(`\u{1F535} [DELETE /suppliers/${e}] Eliminando proveedor`);let o=await z(`
      DELETE FROM suppliers 
      WHERE id = $1
      RETURNING name
    `,[e]);if(o.rows.length===0)return r.status(404).json({error:"Supplier not found"});console.log(`\u2705 [DELETE /suppliers/${e}] Proveedor eliminado: ${o.rows[0].name}`),r.json({message:"Supplier deleted successfully"})}catch(e){console.error("\u274C Error deleting supplier:",e),r.status(500).json({error:"Failed to delete supplier"})}});import{Router as jo}from"express";import{randomUUID as Fe}from"node:crypto";import{z as Mo}from"zod";Yt();var xe=jo();xe.get("/shipments",async(a,r)=>{try{let{status:e,q:o,clientId:c,providerId:l,page:p="1",limit:h="20"}=a.query,b="1=1",T=[],i=1;e&&(b+=` AND s.status = $${i}`,T.push(e),i++),c&&(b+=` AND s.client_id = $${i}`,T.push(c),i++),l&&(b+=` AND s.provider_id = $${i}`,T.push(l),i++),o&&(b+=` AND (s.reference ILIKE $${i} OR s.origin ILIKE $${i} OR s.destination ILIKE $${i})`,T.push(`%${o}%`),i++);let n=(parseInt(p)-1)*parseInt(h);T.push(parseInt(h),n);let t=await z(`
      SELECT s.*,
        c.name as client_name,
        c.email as client_email,
        p.name as provider_name,
        p.email as provider_email
      FROM shipment s
      LEFT JOIN client c ON s.client_id = c.id
      LEFT JOIN provider p ON s.provider_id = p.id
      WHERE ${b}
      ORDER BY s.created_at DESC
      LIMIT $${i} OFFSET $${i+1}
    `,T);r.json(t.rows)}catch(e){console.error("Error fetching shipments:",e),r.status(500).json({error:"Failed to fetch shipments"})}});xe.get("/shipments/:id",async(a,r)=>{try{let e=await z(`
      SELECT s.*,
        c.name as client_name, c.email as client_email,
        p.name as provider_name, p.email as provider_email
      FROM shipment s
      LEFT JOIN client c ON s.client_id = c.id
      LEFT JOIN provider p ON s.provider_id = p.id
      WHERE s.id = $1
    `,[a.params.id]);if(e.rows.length===0)return r.status(404).json({error:"Shipment not found"});let o=await z(`
      SELECT * FROM shipment_event 
      WHERE shipment_id = $1 
      ORDER BY at DESC
    `,[a.params.id]),c=await z(`
      SELECT * FROM shipment_doc 
      WHERE shipment_id = $1 
      ORDER BY uploaded_at DESC
    `,[a.params.id]),l=e.rows[0];l.events=o.rows,l.documents=c.rows,r.json(l)}catch(e){console.error("Error fetching shipment:",e),r.status(500).json({error:"Failed to fetch shipment"})}});xe.post("/shipments",async(a,r)=>{try{console.log("[POST /api/shipments (logistics)] Datos recibidos:",JSON.stringify(a.body,null,2));let e=Yr.parse(a.body);console.log("[POST /api/shipments (logistics)] Datos validados:",JSON.stringify(e,null,2));let o=Fe(),c=await z(`
      INSERT INTO shipment (id, reference, client_id, provider_id, origin, destination, incoterm, etd, eta)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
      RETURNING *
    `,[o,e.reference,e.clientId,e.providerId,e.origin,e.destination,e.incoterm,e.etd,e.eta]);console.log("[POST /api/shipments (logistics)] Env\xEDo creado exitosamente"),r.status(201).json(c.rows[0])}catch(e){if(console.error("[POST /api/shipments (logistics)] Error completo:",e),e instanceof Mo.ZodError)return console.error("[POST /api/shipments (logistics)] Errores de validaci\xF3n:",JSON.stringify(e.errors,null,2)),r.status(400).json({error:"Failed to create shipment",message:"Validation error",details:e.errors});console.error("[POST /api/shipments (logistics)] Error desconocido:",e),r.status(400).json({error:"Failed to create shipment",details:e.message})}});xe.patch("/shipments/:id",async(a,r)=>{try{let e=Xr.parse({...a.body,id:a.params.id}),o=[],c=[],l=1;if(Object.entries(e).forEach(([h,b])=>{if(h!=="id"&&b!==void 0){let T=h==="clientId"?"client_id":h==="providerId"?"provider_id":h;o.push(`${T} = $${l}`),c.push(b),l++}}),o.length===0)return r.status(400).json({error:"No fields to update"});c.push(a.params.id);let p=await z(`
      UPDATE shipment SET ${o.join(", ")}, updated_at = NOW()
      WHERE id = $${l}
      RETURNING *
    `,c);if(p.rows.length===0)return r.status(404).json({error:"Shipment not found"});r.json(p.rows[0])}catch(e){console.error("Error updating shipment:",e),r.status(400).json({error:"Failed to update shipment"})}});xe.post("/shipments/:id/events",async(a,r)=>{try{let e=Qr.parse({...a.body,shipmentId:a.params.id}),o=Fe(),c=await z(`
      INSERT INTO shipment_event (id, shipment_id, type, at, lat, lng, notes, created_by)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
      RETURNING *
    `,[o,e.shipmentId,e.type,e.at,e.lat,e.lng,e.notes,"system"]);r.status(201).json(c.rows[0])}catch(e){console.error("Error creating shipment event:",e),r.status(400).json({error:"Failed to create shipment event"})}});xe.post("/shipments/:id/docs",async(a,r)=>{try{let e=Zr.parse({...a.body,shipmentId:a.params.id}),o=Fe(),c=await z(`
      INSERT INTO shipment_doc (id, shipment_id, kind, file_url, uploaded_by)
      VALUES ($1, $2, $3, $4, $5)
      RETURNING *
    `,[o,e.shipmentId,e.kind,e.fileUrl,e.uploadedBy]);r.status(201).json(c.rows[0])}catch(e){console.error("Error creating shipment document:",e),r.status(400).json({error:"Failed to create shipment document"})}});xe.post("/shipments/:id/request-transport",async(a,r)=>{try{let{providerId:e,pickupWindow:o,notes:c}=a.body,l=a.params.id;await z(`
      UPDATE shipment 
      SET status = 'asignando_transporte', provider_id = $1, updated_at = NOW()
      WHERE id = $2
    `,[e,l]);let p=await z(`
      SELECT s.*, c.name as client_name, p.name as provider_name, p.email as provider_email
      FROM shipment s
      JOIN client c ON s.client_id = c.id
      JOIN provider p ON s.provider_id = p.id
      WHERE s.id = $1
    `,[l]);if(p.rows.length===0)return r.status(404).json({error:"Shipment not found"});let h=p.rows[0],b=Fe(),T=Fe();try{await Jt({to:h.provider_email,shipment:h,confirmToken:b,rejectToken:T,pickupWindow:o,notes:c}),await z(`
        INSERT INTO shipment_event (id, shipment_id, type, at, notes, created_by)
        VALUES ($1, $2, 'note', NOW(), $3, 'system')
      `,[Fe(),l,`Solicitud de transporte enviada a ${h.provider_name}`]),r.json({success:!0,message:"Transport request sent successfully"})}catch(i){console.error("Error sending email:",i),r.status(500).json({error:"Failed to send transport request"})}}catch(e){console.error("Error requesting transport:",e),r.status(500).json({error:"Failed to request transport"})}});xe.post("/shipments/:id/confirm",async(a,r)=>{try{let{token:e,pickupAt:o}=a.query,c=a.params.id;if(!e)return r.status(400).json({error:"Invalid token"});await z(`
      UPDATE shipment 
      SET status = 'confirmado', updated_at = NOW()
      WHERE id = $1
    `,[c]),await z(`
      INSERT INTO shipment_event (id, shipment_id, type, at, notes, created_by)
      VALUES ($1, $2, 'pickup', $3, 'Transporte confirmado por proveedor', 'provider')
    `,[Fe(),c,o||new Date().toISOString()]),r.json({success:!0,message:"Transport confirmed successfully"})}catch(e){console.error("Error confirming transport:",e),r.status(500).json({error:"Failed to confirm transport"})}});xe.post("/shipments/:id/reject",async(a,r)=>{try{let{token:e,reason:o}=a.query,c=a.params.id;if(!e)return r.status(400).json({error:"Invalid token"});await z(`
      UPDATE shipment 
      SET status = 'pendiente', provider_id = NULL, updated_at = NOW()
      WHERE id = $1
    `,[c]),await z(`
      INSERT INTO shipment_event (id, shipment_id, type, at, notes, created_by)
      VALUES ($1, $2, 'note', NOW(), $3, 'provider')
    `,[Fe(),c,`Transporte rechazado: ${o||"Sin raz\xF3n especificada"}`]),r.json({success:!0,message:"Transport rejected"})}catch(e){console.error("Error rejecting transport:",e),r.status(500).json({error:"Failed to reject transport"})}});import Oe from"path";import fe from"fs";import{neon as gn}from"@neondatabase/serverless";import ke from"multer";function V(a){if(!a.user)throw new Error("Unauthorized");return a.user}var Ws=gn(process.env.DATABASE_URL);function We(a){if(!a)return a;let{password:r,...e}=a;return e}function zo(a){return a.map(We)}function Ge(a){if(!a||typeof a!="object")return a;let r=["password","token","authorization","apiKey","secret","jwt"],e=Array.isArray(a)?[]:{};for(let[o,c]of Object.entries(a))r.some(l=>o.toLowerCase().includes(l))?e[o]="[REDACTED]":typeof c=="object"&&c!==null?e[o]=Ge(c):e[o]=c;return e}function lr(a){if(typeof a=="number")return a;if(typeof a!="string")return NaN;let r=a.replace(/[^0-9.-]/g,"");return parseFloat(r)}function pn(a){let r=["rotaci\xF3n de cuentas por cobrar","velocidad de rotaci\xF3n","tiempo de","d\xEDas de","plazo de","demora"],e=a.toLowerCase();return r.some(o=>e.includes(o)&&!e.includes("entrega"))}async function Wo(a,r,e,o,c){try{if([{from:"complies",to:"not_compliant"},{from:"alert",to:"not_compliant"},{from:"not_compliant",to:"complies"}].some(h=>h.from===e&&h.to===o)){let h={complies:"En cumplimiento",alert:"En alerta",not_compliant:"No cumple"},b={fromUserId:r.id,toUserId:r.id,title:`Cambio de estado en KPI: ${a.name}`,message:`El KPI "${a.name}" ha cambiado de "${h[e]}" a "${h[o]}"`,type:o==="complies"?"success":"warning",companyId:a.companyId??null,areaId:a.areaId??null};await c.createNotification(b),k.info(`[KPI Notification] Notificaci\xF3n creada para cambio de estado: ${a.name}`,{kpiId:a.id,userId:r.id})}}catch(l){k.error("Error creating KPI status change notification",l)}}function yn(a){let r=a.listen,e=cr({windowMs:15*60*1e3,max:5,message:"Demasiados intentos de login. Por favor, intenta de nuevo en 15 minutos.",standardHeaders:!0,legacyHeaders:!1}),o=cr({windowMs:60*60*1e3,max:3,message:"Demasiados intentos de registro. Por favor, intenta m\xE1s tarde.",standardHeaders:!0,legacyHeaders:!1}),c=cr({windowMs:60*60*1e3,max:20,message:"L\xEDmite de uploads alcanzado. Por favor, intenta en 1 hora.",standardHeaders:!0,legacyHeaders:!1});a.post("/api/login",e,async(i,n)=>{try{let{username:t,password:s}=i.body;if(!t||!s)return n.status(400).json({message:"Username and password are required"});let d=await Dr(t,s);if(!d)return n.status(401).json({message:"Invalid username or password"});n.json(d)}catch(t){k.error("[POST /api/login] Error en login",t),n.status(500).json({message:"Internal server error"})}}),a.use("/api",$,me),a.use("/api/logistics-legacy",xe),a.get("/env-check",$,tt,(i,n)=>{let t=process.env.NODE_ENV||"undefined",s=a.get("env"),d={cwd:process.cwd(),script_dir:import.meta.dirname,dist_index:Oe.resolve(import.meta.dirname,"index.js"),dist_public:Oe.resolve(import.meta.dirname,"public"),dist_public_index:Oe.resolve(import.meta.dirname,"public","index.html")},u={dist_index_exists:!1,dist_public_exists:!1,dist_public_index_exists:!1};try{u.dist_index_exists=fe.existsSync(d.dist_index),u.dist_public_exists=fe.existsSync(d.dist_public),u.dist_public_index_exists=fe.existsSync(d.dist_public_index)}catch{}let g=["DATABASE_URL","JWT_SECRET","SENDGRID_API_KEY","REPL_ID","REPL_SLUG"],y={};g.forEach(f=>{let I=!!process.env[f],E=process.env[f]?.length||0;y[f]={exists:I,length:I?E:0,status:I?"SET":"MISSING"}});let m={timestamp:new Date().toISOString(),environment:{NODE_ENV:t,express_env:s,is_production:s==="production"},paths:d,file_checks:u,env_variables:y,critical_issues:[]};y.JWT_SECRET?.exists||m.critical_issues.push("JWT_SECRET missing - auth will fail"),s==="production"&&!u.dist_public_index_exists&&m.critical_issues.push("dist/public/index.html missing in production"),n.json(m)}),a.get("/api/healthz",$,tt,(i,n)=>{n.json({status:"ok",environment:process.env.NODE_ENV,timestamp:new Date().toISOString()})}),a.post("/api/admin/seed-clients",$,tt,async(i,n)=>{try{let{seedClients:t}=await Promise.resolve().then(()=>(on(),nn)),s=await t();n.json(s)}catch(t){console.error("[Admin] Error seeding clients:",t),n.status(500).json({success:!1,message:"Error seeding clients",error:t instanceof Error?t.message:String(t)})}}),a.post("/api/treasury/send-reminder",$,async(i,n)=>{try{let{voucherId:t,clientId:s}=i.body;if(!t||!s)return n.status(400).json({error:"voucherId y clientId son requeridos"});let{TreasuryAutomation:d}=await Promise.resolve().then(()=>(er(),Zt)),u=await d.sendComplementReminder(t,s);u.success?n.json({success:!0,message:u.message}):n.status(400).json({error:u.message})}catch(t){console.error("[Treasury] Error sending reminder:",t),n.status(500).json({error:"Error interno del servidor"})}}),a.post("/api/treasury/resend-receipt",$,async(i,n)=>{try{let{voucherId:t,clientId:s,companyId:d}=i.body;if(!t||!s||!d)return n.status(400).json({error:"voucherId, clientId y companyId son requeridos"});let{TreasuryAutomation:u}=await Promise.resolve().then(()=>(er(),Zt)),g=await u.sendPaymentReceiptToSupplier(t,s,d);g.success?n.json({success:!0,message:g.message}):n.status(400).json({error:g.message})}catch(t){console.error("[Treasury] Error resending receipt:",t),n.status(500).json({error:"Error interno del servidor"})}}),a.get("/api/spa-check",$,tt,(i,n)=>{let t=Oe.resolve(import.meta.dirname,"public","index.html"),s=fe.existsSync(t);n.json({spaFallback:s?"OK":"FAIL",indexPath:t,exists:s})}),a.get("/api/user",$,async(i,n)=>{try{let t=V(i);n.json(t)}catch(t){console.error("Error getting user:",t),n.status(500).json({error:"Error interno del servidor"})}}),a.post("/api/admin/reset-user-password",$,tt,async(i,n)=>{try{let{email:t,password:s}=i.body||{};if(!t||!s)return n.status(400).json({message:"email y password son requeridos"});let d=await x.getUserByEmail(t);if(!d)return n.status(404).json({message:"Usuario no encontrado"});let u=await dt(s,10);if(!await x.updateUser(d.id,{password:u}))return n.status(500).json({message:"No fue posible actualizar la contrase\xF1a"});n.json({success:!0,userId:d.id})}catch(t){console.error("[POST /api/admin/reset-user-password] Error:",t),n.status(500).json({message:"Internal server error"})}}),a.post("/api/register",o,async(i,n)=>{try{console.log("[POST /api/register] Datos recibidos:",JSON.stringify(Ge(i.body),null,2));let{area:t,...s}=i.body,d=s.companyId!=null?Number(s.companyId):void 0,u=null;t&&d&&(u={Sales:{1:1,2:4},Logistics:{1:2,2:5},Purchasing:{1:7,2:10},Accounting:{1:3,2:6}}[t]?.[d]||null,console.log(`[POST /api/register] \xC1rea mapeada: ${t} + Company ${d} = areaId ${u}`));let g=Xe.safeParse({...s,companyId:d,areaId:u,email:s.email?.toLowerCase()});if(!g.success)return console.log("[POST /api/register] Error de validaci\xF3n:",g.error.issues),n.status(400).json({message:"Error de validaci\xF3n",code:"VALIDATION_ERROR",errors:g.error.issues});let y=g.data;console.log("[POST /api/register] Datos validados:",JSON.stringify(Ge(y),null,2));try{if(await x.getUserByUsername(y.email))return n.status(409).json({message:"El email ya est\xE1 registrado"})}catch{console.log("[POST /api/register] Email disponible")}if(!y.password)return n.status(400).json({message:"La contrase\xF1a es obligatoria"});y.password=await dt(y.password,10),y.role||(y.role="collaborator"),console.log("[POST /api/register] Datos despu\xE9s del hash:",JSON.stringify({...y,password:"[HASHED]"},null,2));let m=await x.createUser(y);console.log("[POST /api/register] Usuario registrado exitosamente:",We(m)),n.status(201).json({message:"Usuario registrado exitosamente",user:We(m)})}catch(t){if(console.error("[POST /api/register] Error completo:",t),t instanceof Error&&(console.error("[POST /api/register] Stack trace:",t.stack),t.message.includes("duplicate key")||t.message.includes("unique constraint")))return n.status(409).json({message:"El email ya est\xE1 registrado",code:"EMAIL_EXISTS"});if(t instanceof q.ZodError)return console.error("[POST /api/register] Errores de validaci\xF3n:",t.errors),n.status(400).json({message:"Error de validaci\xF3n",code:"VALIDATION_ERROR",errors:t.errors});n.status(500).json({message:"Error interno del servidor",code:"INTERNAL_ERROR",details:t instanceof Error?t.message:"Unknown error"})}}),a.get("/api/user",$,async(i,n)=>{try{let t=i.user,s=await x.getUser(t.id);if(!s)return n.status(404).json({message:"User not found"});let{password:d,...u}=s;n.json(u)}catch{n.status(500).json({message:"Internal server error"})}}),a.get("/api/users",$,async(i,n)=>{try{let t=await x.getUsers();n.json(zo(t))}catch{n.status(500).json({message:"Internal server error"})}}),a.post("/api/users",$,async(i,n)=>{try{console.log("[POST /api/users] Datos recibidos:",JSON.stringify(Ge(i.body),null,2));let t=Xe.parse(i.body);console.log("[POST /api/users] Datos validados:",JSON.stringify(Ge(t),null,2)),t.password&&(t.password=await dt(t.password,10)),console.log("[POST /api/users] Datos despu\xE9s del hash:",JSON.stringify({...t,password:"[HASHED]"},null,2));let s=await x.createUser(t);console.log("[POST /api/users] Usuario creado:",s),n.status(201).json(We(s))}catch(t){if(console.error("[POST /api/users] Error completo:",t),t instanceof Error&&console.error("[POST /api/users] Stack trace:",t.stack),t instanceof q.ZodError)return console.error("[POST /api/users] Errores de validaci\xF3n:",t.errors),n.status(400).json({message:"Validation error",errors:t.errors});n.status(500).json({message:"Internal server error",details:t instanceof Error?t.message:"Unknown error"})}}),a.put("/api/users/:id",$,async(i,n)=>{try{let t=parseInt(i.params.id);console.log("[PUT /api/users/:id] Datos recibidos:",Ge(i.body));let s=Xe.partial().parse(i.body);s.password&&(s.password=await dt(s.password,10)),console.log("[PUT /api/users/:id] Datos validados:",Ge(s));let d=await x.updateUser(t,s);if(!d)return n.status(404).json({message:"User not found"});console.log("[PUT /api/users/:id] Usuario actualizado:",d),n.json(We(d))}catch(t){if(console.error("[PUT /api/users/:id] Error:",t),t instanceof q.ZodError)return n.status(400).json({message:"Validation error",errors:t.errors});n.status(500).json({message:"Internal server error"})}}),a.delete("/api/users/:id",$,async(i,n)=>{try{let t=parseInt(i.params.id);if(!await x.deleteUser(t))return n.status(404).json({message:"User not found"});n.json({message:"User deleted successfully"})}catch{n.status(500).json({message:"Internal server error"})}}),a.get("/api/companies",$,async(i,n)=>{try{let t=await x.getCompanies();n.json(t)}catch{n.status(500).json({message:"Internal server error"})}}),a.get("/api/companies/:id",$,async(i,n)=>{try{let t=parseInt(i.params.id),s=await x.getCompany(t);if(!s)return n.status(404).json({message:"Company not found"});console.log(`[GET /api/companies/:id] Buscando empresa con ID: ${t}`),console.log(`[GET /api/companies/:id] Empresa encontrada: ${s?"S\xED":"No"}`),console.log(`[GET /api/companies/:id] Enviando empresa: { id: ${s.id}, name: '${s.name}' }`),n.json(s)}catch{n.status(500).json({message:"Internal server error"})}}),a.post("/api/companies",$,async(i,n)=>{try{let t=_t.parse(i.body),s=await x.createCompany(t);n.status(201).json(s)}catch(t){if(t instanceof q.ZodError)return n.status(400).json({message:t.errors});n.status(500).json({message:"Internal server error"})}}),a.get("/api/areas",$,async(i,n)=>{try{if(i.query.companyId&&i.query.companyId!=="undefined"&&i.query.companyId!=="null"){let t=parseInt(i.query.companyId);if(!isNaN(t)&&t>0){let s=await x.getAreasByCompany(t);n.json(s)}else{console.warn(`Invalid companyId received: ${i.query.companyId}`);let s=await x.getAreas();n.json(s)}}else{let t=await x.getAreas();n.json(t)}}catch(t){console.error("Error getting areas:",t),n.status(500).json({message:"Internal server error"})}}),a.get("/api/areas/:id",$,async(i,n)=>{try{let t=parseInt(i.params.id),s=await x.getArea(t);if(!s)return n.status(404).json({message:"Area not found"});n.json(s)}catch{n.status(500).json({message:"Internal server error"})}}),a.post("/api/areas",$,async(i,n)=>{try{let t=Dt.parse(i.body),s=await x.createArea(t);n.status(201).json(s)}catch(t){if(t instanceof q.ZodError)return n.status(400).json({message:t.errors});n.status(500).json({message:"Internal server error"})}}),a.get("/api/kpis",$,async(i,n)=>{try{let t=V(i),s=i.query.companyId?parseInt(i.query.companyId,10):void 0;if(console.log("\u{1F535} [GET /api/kpis] Endpoint llamado"),console.log(`\u{1F4CA} Usuario: ${t.name}, Company ID: ${s??"ALL"}`),s!==void 0){if(s!==1&&s!==2)return n.status(400).json({error:"Invalid company ID. Use 1 for Dura or 2 for Orsega."});let u=await x.getKpis(s);return n.json(u)}let d=await x.getKpis();n.json(d)}catch(t){console.error("\u274C Error fetching KPIs:",t),n.status(500).json({message:"Internal server error",error:t.message})}}),a.post("/api/admin/fix-dura-kpi-goal",$,async(i,n)=>{try{if(V(i).role!=="admin")return n.status(403).json({message:"Solo administradores"});let{neon:s}=await import("@neondatabase/serverless"),d=s(process.env.DATABASE_URL),u=53480,g="KG",y=u.toString(),f=(await d`
        UPDATE kpis_dura
        SET goal = ${y}, unit = ${g}
        WHERE id = 39
        RETURNING id, kpi_name, goal, unit
      `).length;return f===0&&(f=(await d`
          UPDATE kpis_dura
          SET goal = ${y}, unit = ${g}
          WHERE lower(kpi_name) LIKE '%ventas%'
          RETURNING id, kpi_name, goal, unit
        `).length),n.json({ok:!0,updated:f})}catch(t){return console.error("[POST /api/admin/fix-dura-kpi-goal] Error:",t),n.status(500).json({ok:!1,error:"Error interno"})}}),a.get("/api/kpis/:id",$,async(i,n)=>{try{let t=parseInt(i.params.id,10),s=i.query.companyId?parseInt(i.query.companyId,10):void 0;if(!s||s!==1&&s!==2){let y=(await x.getKpis()).find(m=>m.id===t);if(!y)return n.status(400).json({message:"companyId query param es requerido (1=Dura, 2=Orsega)"});s=y.companyId??void 0}let d=s?await x.getKpi(t,s):void 0;if(!s||!d)return n.status(404).json({message:"KPI not found"});let u=pn(d.name||"");console.log(`[GET KPI/${t}] Calculando para "${d.name}". \xBFEs invertido?: ${u}`),n.json({...d,isLowerBetter:u})}catch(t){console.error(`[GET /api/kpis/${i.params.id}] Error:`,t),n.status(500).json({message:"Internal server error"})}}),a.post("/api/kpis",$,async(i,n)=>{try{let t=i;if(t.user?.role!=="admin"&&t.user?.role!=="manager")return n.status(403).json({message:"No tienes permisos para crear KPIs"});let s=Rt.parse(i.body);s.companyId&&Me(i,s.companyId);let d=await x.createKpi(s);n.status(201).json(d)}catch(t){if(t instanceof q.ZodError)return n.status(400).json({message:t.errors});n.status(500).json({message:"Internal server error"})}}),a.put("/api/kpis/:id",$,async(i,n)=>{try{let t=i;if(t.user?.role!=="admin"&&t.user?.role!=="manager")return n.status(403).json({message:"No tienes permisos para actualizar KPIs"});let s=parseInt(i.params.id,10),d=i.body?.companyId,u=i.query.companyId?parseInt(i.query.companyId,10):void 0,g=d??u;if(g!==1&&g!==2)return n.status(400).json({message:"companyId debe ser 1 (Dura) o 2 (Orsega)"});let y=jt.parse({...i.body,companyId:g});console.log(`[PUT /api/kpis/${s}] Datos validados:`,y),g&&Me(i,g);let m=await x.updateKpi(s,y);console.log(`[PUT /api/kpis/${s}] KPI actualizado:`,m),n.json(m)}catch(t){if(t instanceof q.ZodError)return console.error("[PUT /api/kpis] Error de validaci\xF3n:",t.errors),n.status(400).json({message:t.errors});console.error("[PUT /api/kpis] Error interno:",t),n.status(500).json({message:"Internal server error"})}}),a.delete("/api/kpis/:id",$,async(i,n)=>{try{let t=i;if(t.user?.role!=="admin"&&t.user?.role!=="manager")return n.status(403).json({message:"No tienes permisos para eliminar KPIs"});let s=parseInt(i.params.id,10),d=i.query.companyId?parseInt(i.query.companyId,10):void 0;if(!d||d!==1&&d!==2){let y=(await x.getKpis()).find(m=>m.id===s);if(!y)return n.status(404).json({message:"KPI not found"});d=y.companyId??void 0}if(d&&Me(i,d),!(d?await x.deleteKpi(s,d):!1))return n.status(404).json({message:"KPI not found"});n.json({message:"KPI eliminado exitosamente"})}catch{n.status(500).json({message:"Internal server error"})}}),a.get("/api/kpis-by-user/:userId",$,async(i,n)=>{try{let t=parseInt(i.params.userId,10);console.log(`\u{1F535} [GET /api/kpis-by-user/${t}] Endpoint llamado`);let s=await x.getUser(t);if(!s)return n.status(404).json({error:"User not found"});let d=await x.getUserKpis(t),u=[];if(u.push(...d),u.length===0){let y=s.companyId?[s.companyId]:[1,2],m=(s.name?.split(" ")[0]||"").toLowerCase();for(let f of y){if(f!==1&&f!==2)continue;let E=(await x.getKpis(f)).filter(N=>(N.responsible??"").toLowerCase().includes(m));u.push(...E)}}let g=Array.from(new Map(u.map(y=>[y.id,y])).values());console.log(`\u{1F4CA} [GET /api/kpis-by-user/${t}] Retornando ${g.length} KPIs para ${s.name}`),n.json(g)}catch(t){console.error("\u274C Error fetching KPIs by user:",t),n.status(500).json({error:"Failed to fetch KPIs by user"})}}),a.delete("/api/user-kpis/:kpiId",$,async(i,n)=>{try{let t=V(i),s=parseInt(i.params.kpiId,10),u=(i.query.companyId?parseInt(i.query.companyId,10):void 0)??t.companyId??null;if(!u||u!==1&&u!==2)return n.status(400).json({message:"companyId query param es requerido (1=Dura, 2=Orsega)"});let g=await x.getKpi(s,u);n.json({message:"Los KPIs se gestionan a nivel de compa\xF1\xEDa; no existen valores espec\xEDficos por usuario que eliminar en este esquema."})}catch(t){console.error("Error eliminating user-specific KPI:",t),n.status(500).json({message:"Internal server error"})}}),a.get("/api/top-performers",$,async(i,n)=>{try{let{companyId:t}=i.query,s=t?parseInt(t,10):NaN;if(s!==1&&s!==2)return n.status(400).json({message:"companyId es requerido (1=Dura, 2=Orsega)"});let[d,u,g]=await Promise.all([x.getAreasByCompany(s),x.getKpis(s),x.getKpiValues(s)]),y=new Map(d.map(E=>[E.id,E])),m=new Map,f=new Map;for(let E of g)f.has(E.kpiId)||f.set(E.kpiId,[]),f.get(E.kpiId).push(E);for(let E of f.values())E.sort((N,C)=>{let A=N.date?new Date(N.date).getTime():0;return(C.date?new Date(C.date).getTime():0)-A});for(let E of u){if(!E.areaId)continue;let N=y.get(E.areaId);if(!N)continue;m.has(N.id)||m.set(N.id,{areaId:N.id,areaName:N.name,total:0,compliant:0});let C=m.get(N.id);C.total+=1,f.get(E.id)?.[0]?.status==="complies"&&(C.compliant+=1)}let I=Array.from(m.values()).map(E=>{let N=E.total===0?0:E.compliant*100/E.total;return{area_name:E.areaName,area_id:E.areaId,total_kpis:E.total,compliant_kpis:E.compliant,compliance_percentage:Number(N.toFixed(2))}}).sort((E,N)=>N.compliance_percentage===E.compliance_percentage?N.total_kpis-E.total_kpis:N.compliance_percentage-E.compliance_percentage).slice(0,5);n.json(I)}catch(t){console.error("Error fetching top performers:",t),n.status(500).json({message:"Error interno del servidor"})}}),a.get("/api/kpi-values",$,async(i,n)=>{try{let t=i.query.companyId?parseInt(i.query.companyId,10):void 0;if(t!==void 0&&t!==1&&t!==2)return n.status(400).json({error:"companyId query param inv\xE1lido (1=Dura, 2=Orsega)"});if(i.query.kpiId){let d=parseInt(i.query.kpiId,10);if(t!==void 0){if(!await x.getKpi(d,t))return n.status(404).json({message:"KPI not found for this company"});let f=await x.getKpiValuesByKpi(d,t);return n.json(f)}let g=(await x.getKpis()).find(m=>m.id===d);if(!g?.companyId)return n.status(404).json({message:"KPI not found"});let y=await x.getKpiValuesByKpi(d,g.companyId);return n.json(y)}let s=await x.getKpiValues(t);console.log(`[GET /api/kpi-values] Retornando ${s.length} valores para companyId=${t??"ALL"}`),n.json(s)}catch(t){console.error("[GET /api/kpi-values] Error:",t),n.status(500).json({message:"Internal server error"})}}),a.post("/api/kpi-values",$,async(i,n)=>{try{let t=V(i),s=vt.parse(i.body),d=s.companyId;if(d||(d=(await x.getKpis()).find(A=>A.id===s.kpiId)?.companyId??void 0),!d)return n.status(400).json({message:"Debe especificarse companyId (1=Dura, 2=Orsega)"});let u=await x.getKpi(s.kpiId,d);if(!u)return console.error(`[POST /api/kpi-values] KPI ${s.kpiId} no encontrado para companyId=${d}`),n.status(404).json({message:"KPI not found"});let[g]=await x.getLatestKpiValues(s.kpiId,1,d),y=s.status??null,m=s.compliancePercentage??null,f=u.target??u.goal;if(f){let N=lr(s.value),C=lr(f);if(!isNaN(N)&&!isNaN(C)){let A=pn(u.name||""),w;A?(w=Math.min(C/N*100,100),N<=C?y="complies":N<=C*1.1?y="alert":y="not_compliant"):(w=Math.min(N/C*100,100),N>=C?y="complies":N>=C*.9?y="alert":y="not_compliant"),m=`${w.toFixed(1)}%`}}let I={...s,companyId:d,status:y,compliancePercentage:m,updatedBy:t.id},E=await x.createKpiValue(I);g?.status&&E.status&&g.status!==E.status&&await Wo(u,t,g.status,E.status,x),n.status(201).json(E)}catch(t){if(t instanceof q.ZodError)return console.error("[POST /api/kpi-values] Validation error:",t.errors),n.status(400).json({message:t.errors});console.error("Error creating KPI value:",t),n.status(500).json({message:"Internal server error"})}}),a.post("/api/sales/weekly-update",$,async(i,n)=>{try{console.log("[POST /api/sales/weekly-update] SIMPLIFICADO - Recibida solicitud:",i.body);let{value:t,companyId:s,weekNumber:d,month:u,year:g,adminOverride:y}=i.body,m=V(i);if(!t||!s)return n.status(400).json({message:"Datos insuficientes. Se requiere value y companyId"});let f={value:parseFloat(t),companyId:parseInt(s||"1"),userId:m.id};m.role==="admin"&&y&&d&&u&&g?(f.adminOverride=!0,f.weekNumber=d,f.month=u,f.year=parseInt(g),console.log(`[POST /api/sales/weekly-update] ADMIN OVERRIDE - Per\xEDodo manual: ${d} - ${u} ${g}`)):console.log("[POST /api/sales/weekly-update] Modo normal - detecci\xF3n autom\xE1tica");let I,E;if(f.adminOverride&&f.month&&f.year)I=f.month,E=f.year;else{let A=new Date;I=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][A.getMonth()],E=A.getFullYear()}if(!(m.role==="admin"&&f.adminOverride)){let w=(await x.getKpis()).find(S=>S.name.includes("Volumen de ventas")&&S.companyId===f.companyId);if(w){let D=(await x.getKpiValuesByKpi(w.id,w.companyId??f.companyId)).find(M=>M.period===`${I} ${E}`&&!M.period.includes("Semana"));if(D)return console.log(`[POST /api/sales/weekly-update] \u274C ACCESO DENEGADO - Mes ${I} ${E} ya est\xE1 cerrado`),n.status(409).json({success:!1,message:`El mes ${I} ${E} ya est\xE1 cerrado y no se pueden hacer m\xE1s actualizaciones.`,monthStatus:{closed:!0,period:`${I} ${E}`,closedValue:D.value,closedDate:D.date},suggestion:"Contacta a un administrador si necesitas actualizar este per\xEDodo."})}}else console.log(`[POST /api/sales/weekly-update] \u{1F513} ADMIN OVERRIDE - Permitiendo actualizaci\xF3n en per\xEDodo ${I} ${E}`);let C=await Fr(f);C.success?(console.log("[POST /api/sales/weekly-update] \u2705 Actualizaci\xF3n exitosa:",{period:C.currentPeriod?.period,monthlyPreview:C.monthlyPreview?.formattedValue}),n.status(200).json({success:!0,message:C.message||"Ventas actualizadas exitosamente",weeklyRecord:C.weeklyRecord,currentPeriod:C.currentPeriod,monthlyPreview:C.monthlyPreview})):(console.error("[POST /api/sales/weekly-update] \u274C Error:",C.message),n.status(400).json({success:!1,message:C.message||"Error al actualizar datos de ventas"}))}catch(t){console.error("[POST /api/sales/weekly-update] \u274C Error cr\xEDtico:",t),n.status(500).json({success:!1,message:"Error interno del servidor"})}}),a.post("/api/sales/update-month",$,async(i,n)=>{try{console.log("[POST /api/sales/update-month] Recibida solicitud:",i.body);let{value:t,companyId:s,month:d,year:u,period:g}=i.body,y=V(i),m=Number(s),f=Number(u);if(!t||isNaN(m)||!d||isNaN(f))return n.status(400).json({success:!1,message:"Faltan datos requeridos: valor, compa\xF1\xEDa, mes y a\xF1o"});if(m!==1&&m!==2)return n.status(400).json({success:!1,message:"companyId debe ser 1 (Dura) o 2 (Orsega)"});let E=(await x.getKpis(m)).find(M=>{let O=(M.name||M.kpiName||"").toLowerCase();return O.includes("volumen")&&O.includes("ventas")||O.includes("ventas")||O.includes("sales")});if(!E)return console.error(`[POST /api/sales/update-month] \u274C KPI de ventas no encontrado para companyId ${m}`),n.status(404).json({success:!1,message:`KPI de ventas no encontrado. Por favor, verifica que el KPI de ventas est\xE9 configurado para ${m===1?"Dura International":"Grupo Orsega"}.`});let N=E.id,C=g||`${d} ${f}`;console.log(`[POST /api/sales/update-month] KPI encontrado: ID ${N}, nombre "${E.name}" para companyId ${m}`),console.log(`[POST /api/sales/update-month] Actualizando para per\xEDodo: ${C}`);let A=await x.createKpiValue({companyId:m,kpiId:N,value:t.toString(),period:C,month:d,year:f,updatedBy:y.id}),w=m===1?55620:858373,S=lr(t),D=isNaN(S)?null:Math.round(S/w*100);n.status(200).json({success:!0,message:`Ventas de ${C} actualizadas correctamente`,data:{period:C,value:t,monthlyTarget:w,compliance:D,record:A,kpiId:N,companyId:m}})}catch(t){console.error("[POST /api/sales/update-month] \u274C Error:",t),n.status(500).json({success:!1,message:t.message||"Error al actualizar ventas mensuales"})}}),a.post("/api/sales/auto-close-month",$,async(i,n)=>{try{console.log("[POST /api/sales/auto-close-month] Iniciando auto-cierre mensual:",i.body);let{companyId:t,month:s,year:d}=i.body;if(V(i).role!=="admin")return n.status(403).json({success:!1,message:"Solo los administradores pueden ejecutar el auto-cierre mensual"});let g=t?[parseInt(t)]:[1,2];console.log("[POST /api/sales/auto-close-month] Procesando empresas:",g);let y=[];for(let I of g)try{console.log(`[POST /api/sales/auto-close-month] Procesando empresa ${I}...`);let E=await Bt(I,s,d);y.push({companyId:I,success:E,message:E?"Mes cerrado exitosamente":"No hay datos para cerrar o ya est\xE1 cerrado"})}catch(E){console.error(`[POST /api/sales/auto-close-month] Error para empresa ${I}:`,E),y.push({companyId:I,success:!1,message:E.message||"Error al cerrar mes"})}let m=y.every(I=>I.success),f=y.filter(I=>I.success).length;console.log(`[POST /api/sales/auto-close-month] \u2705 Completado - ${f}/${y.length} empresas procesadas`),n.status(200).json({success:m,message:`Auto-cierre completado: ${f}/${y.length} empresas procesadas`,results:y,timestamp:new Date().toISOString()})}catch(t){console.error("[POST /api/sales/auto-close-month] \u274C Error cr\xEDtico:",t),n.status(500).json({success:!1,message:"Error interno del servidor durante el auto-cierre"})}}),a.post("/api/sales/monthly-close",$,async(i,n)=>{try{console.log("[POST /api/sales/monthly-close] CIERRE MANUAL iniciado:",i.body);let{companyId:t,month:s,year:d,override:u=!1}=i.body,g=V(i);if(g.role!=="admin")return n.status(403).json({success:!1,message:"Solo los administradores pueden cerrar meses manualmente"});if(!t||!s||!d)return n.status(400).json({success:!1,message:"Par\xE1metros requeridos: companyId, month, year"});let y=`${s} ${d}`,f=(await x.getKpis()).find(C=>C.name.includes("Volumen de ventas")&&C.companyId===parseInt(t));if(!f)return n.status(404).json({success:!1,message:`No se encontr\xF3 KPI de volumen de ventas para la compa\xF1\xEDa ${t}`});let E=(await x.getKpiValuesByKpi(f.id,f.companyId??parseInt(t))).find(C=>C.period===y&&!C.period.includes("Semana"));if(E&&!u)return n.status(409).json({success:!1,message:`El mes ${s} ${d} ya est\xE1 cerrado. Usa override=true para volver a cerrar.`,existingRecord:{id:E.id,value:E.value,date:E.date,period:E.period}});if(console.log(`[POST /api/sales/monthly-close] Ejecutando cierre para empresa ${t}, per\xEDodo: ${y}`),await Bt(parseInt(t),s,parseInt(d))){console.log(`[POST /api/sales/monthly-close] \u2705 Cierre manual exitoso para compa\xF1\xEDa ${t}`);let C=E&&u?"actualizado":"cerrado";n.status(200).json({success:!0,message:`Mes ${s} ${d} ${C} exitosamente`,companyId:parseInt(t),period:y,wasOverride:!!(E&&u),closedBy:g.name||g.id})}else console.error(`[POST /api/sales/monthly-close] \u274C Error en cierre manual para compa\xF1\xEDa ${t}`),n.status(500).json({success:!1,message:`Error al cerrar el mes ${s} ${d} - posiblemente no hay datos semanales suficientes`})}catch(t){console.error("[POST /api/sales/monthly-close] \u274C Error cr\xEDtico:",t),n.status(500).json({success:!1,message:"Error interno del servidor durante cierre manual",error:t.message})}}),a.get("/api/sales/monthly-status",$,async(i,n)=>{try{let{companyId:t,month:s,year:d}=i.query;if(!t||!s||!d)return n.status(400).json({success:!1,message:"Par\xE1metros requeridos: companyId, month, year"});let u=`${s} ${d}`,y=(await x.getKpis()).find(E=>E.name.includes("Volumen de ventas")&&E.companyId===parseInt(t));if(!y)return n.status(404).json({success:!1,message:`No se encontr\xF3 KPI de volumen de ventas para la compa\xF1\xEDa ${t}`});let m=await x.getKpiValuesByKpi(y.id,y.companyId??parseInt(t)),f=m.find(E=>E.period===u&&!E.period.includes("Semana")),I=m.filter(E=>E.period.includes(s)&&E.period.includes(d)&&E.period.includes("Semana"));n.status(200).json({success:!0,closed:!!f,period:u,monthlyRecord:f||null,weeklyRecordsCount:I.length,weeklyRecords:I.map(E=>({period:E.period,value:E.value,date:E.date}))})}catch(t){console.error("[GET /api/sales/monthly-status] Error:",t),n.status(500).json({success:!1,message:"Error al consultar estado del mes"})}}),a.get("/api/shipments",$,async(i,n)=>{try{let{companyId:t,status:s,limit:d="50",page:u="1",since:g}=i.query,y=parseInt(d),m=parseInt(u),f=(m-1)*y,I;if(g){let A=g;if(A.endsWith("d")){let w=parseInt(A.replace("d",""));I=new Date,I.setDate(I.getDate()-w)}else I=new Date(A)}let E;if(t){let A=parseInt(t);E=await x.getShipmentsByCompany(A)}else E=await x.getShipments();s&&(E=E.filter(A=>A.status===s)),I&&(E=E.filter(A=>new Date(A.actualDeliveryDate||A.updatedAt||A.createdAt)>=I)),E.sort((A,w)=>{let S=new Date(A.actualDeliveryDate||A.updatedAt||A.createdAt);return new Date(w.actualDeliveryDate||w.updatedAt||w.createdAt).getTime()-S.getTime()});let N=E.length,C=E.slice(f,f+y);n.json({shipments:C,pagination:{page:m,limit:y,total:N,totalPages:Math.ceil(N/y),hasMore:f+y<N}})}catch(t){console.error("[GET /api/shipments] Error:",t),n.status(500).json({message:"Internal server error"})}}),a.get("/api/shipments/products",$,async(i,n)=>{try{let t=V(i),{companyId:s}=i.query;console.log("[GET /api/shipments/products] Usuario:",t.name,"Empresa filtro:",s);let d=["product IS NOT NULL AND product != ''"],u=[],g=0,m=`
        SELECT DISTINCT product 
        FROM shipments 
        ${`WHERE ${d.join(" AND ")}`}
        ORDER BY product ASC
      `,I=(await l(m,u)).map(E=>E.product);console.log(`[GET /api/shipments/products] Encontrados ${I.length} productos \xFAnicos`),n.json(I)}catch(t){console.error("[GET /api/shipments/products] Error:",t),n.status(500).json({message:"Internal server error"})}}),a.get("/api/shipments/:id",$,async(i,n)=>{try{let t=parseInt(i.params.id),s=await x.getShipment(t);if(!s)return n.status(404).json({message:"Shipment not found"});let d=await x.getShipmentItems(t);n.json({...s,items:d})}catch{n.status(500).json({message:"Internal server error"})}}),a.get("/api/shipments/tracking/:trackingCode",$,async(i,n)=>{try{let t=i.params.trackingCode,s=await x.getShipmentByTrackingCode(t);if(!s)return n.status(404).json({message:"Shipment not found"});n.json(s)}catch{n.status(500).json({message:"Internal server error"})}}),a.post("/api/shipments",$,async(i,n)=>{try{console.log("[POST /api/shipments] Datos recibidos:",JSON.stringify(i.body,null,2));let{items:t,...s}=i.body,d={...s,estimatedDeliveryDate:s.estimatedDeliveryDate?new Date(s.estimatedDeliveryDate):null,departureDate:s.departureDate?new Date(s.departureDate):null,actualDeliveryDate:s.actualDeliveryDate?new Date(s.actualDeliveryDate):null};console.log("[POST /api/shipments] Datos transformados:",JSON.stringify(d,null,2));let u=Mt.parse(d);console.log("[POST /api/shipments] Datos validados:",JSON.stringify(u,null,2)),u.companyId&&Me(i,u.companyId);let g=await x.createShipment(u);if(console.log("[POST /api/shipments] Env\xEDo creado:",g),t&&Array.isArray(t)&&t.length>0){let m=t.map(f=>({shipmentId:g.id,product:f.product,quantity:f.quantity,unit:f.unit,description:f.description||null}));await x.createShipmentItems(m),console.log("[POST /api/shipments] Items creados:",m.length)}let y=await x.getShipmentItems(g.id);n.status(201).json({...g,items:y})}catch(t){if(console.error("[POST /api/shipments] Error completo:",t),console.error("[POST /api/shipments] Stack trace:",t?.stack),t instanceof q.ZodError)return console.error("[POST /api/shipments] \u274C Errores de validaci\xF3n:"),t.errors.forEach(s=>{console.error(`  - Campo: ${s.path.join(".")}, Error: ${s.message}`)}),n.status(400).json({error:"Validation error",message:"Los datos enviados no son v\xE1lidos",errors:t.errors,details:t.errors.map(s=>({field:s.path.join("."),message:s.message}))});t?.code&&console.error("[POST /api/shipments] \u274C Error de base de datos:",t.code,t.detail),n.status(500).json({error:"Internal server error",message:t.message||"Error al crear el embarque. Por favor, verifica los datos e intenta nuevamente."})}}),a.patch("/api/shipments/:id",$,async(i,n)=>{try{let t=parseInt(i.params.id);if(!await x.getShipment(t))return n.status(404).json({message:"Shipment not found"});let u={...i.body||{}};typeof u.estimatedDeliveryDate=="string"&&(u.estimatedDeliveryDate=u.estimatedDeliveryDate?new Date(u.estimatedDeliveryDate):null),typeof u.departureDate=="string"&&(u.departureDate=u.departureDate?new Date(u.departureDate):null),typeof u.actualDeliveryDate=="string"&&(u.actualDeliveryDate=u.actualDeliveryDate?new Date(u.actualDeliveryDate):null);let g=await x.updateShipment(t,u);if(!g)return n.status(500).json({message:"Failed to update shipment"});n.json(g)}catch(t){console.error("[PATCH /api/shipments/:id] Error:",t),n.status(500).json({message:"Internal server error"})}}),a.get("/api/shipments/:id/items",$,async(i,n)=>{try{let t=parseInt(i.params.id),s=await x.getShipmentItems(t);n.json(s)}catch{n.status(500).json({message:"Internal server error"})}}),a.post("/api/shipments/:id/items",$,async(i,n)=>{try{let t=parseInt(i.params.id);if(!await x.getShipment(t))return n.status(404).json({message:"Shipment not found"});let{product:d,quantity:u,unit:g,description:y}=i.body||{};if(!d||!u||!g)return n.status(400).json({message:"product, quantity y unit son requeridos"});let m=await x.createShipmentItem({shipmentId:t,product:d,quantity:u,unit:g,description:y||null});n.status(201).json(m)}catch(t){console.error("[POST /api/shipments/:id/items] Error:",t),n.status(500).json({message:"Internal server error"})}}),a.delete("/api/shipments/:id/items/:itemId",$,async(i,n)=>{try{let t=parseInt(i.params.id),s=parseInt(i.params.itemId);if(!await x.getShipment(t))return n.status(404).json({message:"Shipment not found"});if(!await x.deleteShipmentItem(s))return n.status(404).json({message:"Item not found"});n.json({success:!0})}catch(t){console.error("[DELETE /api/shipments/:id/items/:itemId] Error:",t),n.status(500).json({message:"Internal server error"})}}),a.post("/api/shipments/:id/items",$,async(i,n)=>{try{let t=V(i),s=parseInt(i.params.id);if(console.log(`[POST /api/shipments/${s}/items] Agregando item por ${t.name}:`,i.body),!i.body.product||!i.body.quantity||!i.body.unit)return n.status(400).json({message:"Product, quantity, and unit are required",error:"Missing required fields"});let d={shipmentId:s,product:i.body.product,quantity:i.body.quantity,unit:i.body.unit,description:i.body.description||null},u=await x.createShipmentItem(d);if(!u)return n.status(500).json({message:"Error creating item"});console.log(`[POST /api/shipments/${s}/items] Item creado exitosamente:`,u.id),n.status(201).json(u)}catch(t){console.error("[POST /api/shipments/:id/items] Error:",t),n.status(500).json({message:t?.message||"Internal server error",error:String(t)})}}),a.patch("/api/shipments/:id/items/:itemId",$,async(i,n)=>{try{let t=V(i),s=parseInt(i.params.itemId);console.log(`[PATCH /api/shipments/:id/items/${s}] Actualizando item por ${t.name}:`,i.body);let d=parseInt(i.params.id);if(!(await x.getShipmentItems(d)).find(m=>m.id===s))return console.error(`[PATCH /api/shipments/:id/items/${s}] Item no encontrado en env\xEDo ${d}`),n.status(404).json({message:"Item not found in this shipment"});let y=await x.updateShipmentItem(s,i.body);if(!y)return console.error(`[PATCH /api/shipments/:id/items/${s}] Error al actualizar item`),n.status(500).json({message:"Error updating item"});console.log(`[PATCH /api/shipments/:id/items/${s}] Item actualizado exitosamente`),n.json(y)}catch(t){console.error("[PATCH /api/shipments/:id/items/:itemId] Error:",t),n.status(500).json({message:t?.message||"Internal server error",error:String(t)})}}),a.delete("/api/shipments/:id/items/:itemId",$,async(i,n)=>{try{let t=parseInt(i.params.itemId);if(!await x.deleteShipmentItem(t))return n.status(404).json({message:"Item not found"});n.json({success:!0})}catch(t){console.error("[DELETE /api/shipments/:id/items/:itemId] Error:",t),n.status(500).json({message:"Internal server error"})}}),a.get("/api/shipments/:id/updates",$,async(i,n)=>{try{let t=parseInt(i.params.id),s=await x.getShipmentUpdates(t);n.json(s)}catch{n.status(500).json({message:"Internal server error"})}}),a.get("/api/action-plans",$,async(i,n)=>{try{if(i.query.kpiId){let t=parseInt(i.query.kpiId),s=await x.getActionPlansByKpi(t);n.json(s)}else n.json([])}catch{n.status(500).json({message:"Internal server error"})}}),a.get("/api/action-plans/:id",$,async(i,n)=>{try{let t=parseInt(i.params.id),s=await x.getActionPlan(t);if(!s)return n.status(404).json({message:"Action plan not found"});n.json(s)}catch{n.status(500).json({message:"Internal server error"})}}),a.get("/api/notifications",$,async(i,n)=>{try{let t=V(i),s=await x.getNotificationsForUser(t.id);n.json(s)}catch{n.status(500).json({message:"Internal server error"})}}),a.post("/api/notifications",$,async(i,n)=>{try{let t=V(i),s={...i.body,fromUserId:t.id};console.log("[POST /api/notifications] Creando notificaci\xF3n:",s);let d=await x.createNotification(s),u=await x.getUser(s.toUserId);if(u&&u.email){console.log("[POST /api/notifications] Enviando correo a:",u.email);let{html:g,text:y}=Vr(t.name,u.name,s.title,s.message,s.type||"info",s.priority||"normal");await zt({to:u.email,from:"Mario Reynoso <marioreynoso@grupoorsega.com>",subject:`[Econova] ${s.title}`,html:g,text:y})?console.log("[POST /api/notifications] Correo enviado exitosamente"):console.error("[POST /api/notifications] Error al enviar correo")}else console.warn("[POST /api/notifications] Destinatario no encontrado o sin email");n.status(201).json(d)}catch(t){console.error("[POST /api/notifications] Error:",t),n.status(500).json({message:"Internal server error"})}}),a.put("/api/notifications/:id/read",$,async(i,n)=>{try{let t=parseInt(i.params.id),s=V(i),d=await x.markNotificationAsRead(t,s.id);if(!d)return n.status(404).json({message:"Notification not found"});n.json(d)}catch{n.status(500).json({message:"Internal server error"})}}),a.delete("/api/notifications/:id",$,async(i,n)=>{try{let t=parseInt(i.params.id),s=V(i);if(!await x.deleteNotification(t,s.id))return n.status(404).json({message:"Notification not found"});n.json({message:"Notification deleted successfully"})}catch{n.status(500).json({message:"Internal server error"})}}),a.get("/api/team-activity",$,async(i,n)=>{try{console.log("[GET /api/team-activity] Obteniendo resumen de actividad del equipo");let t=await x.getTeamActivitySummary();console.log("[GET /api/team-activity] Resumen obtenido:",t),n.json(t)}catch(t){console.error("Error getting team activity:",t),n.status(500).json({message:"Internal server error"})}}),a.get("/api/users/:id/last-kpi-update",$,async(i,n)=>{try{let t=parseInt(i.params.id),s=await x.getLastKpiUpdateByUser(t);n.json(s)}catch(t){console.error("Error getting last KPI update:",t),n.status(500).json({message:"Internal server error"})}}),a.patch("/api/shipments/:id/status",$,async(i,n)=>{try{let t=parseInt(i.params.id),s=V(i),d=Ot.parse(i.body);console.log("[PATCH /api/shipments/:id/status] Actualizando estado del env\xEDo:",{shipmentId:t,data:d});let u=await x.getShipment(t);if(!u)return n.status(404).json({message:"Env\xEDo no encontrado"});if(d.status==="in_transit"&&!(d.invoiceNumber||u.invoiceNumber))return n.status(400).json({message:"N\xFAmero de factura requerido",error:"Para mover un env\xEDo a 'En Tr\xE1nsito' es necesario proporcionar el n\xFAmero de factura.",requiresInvoiceNumber:!0});let g=u.status!==d.status,y={status:d.status,updatedAt:new Date};d.invoiceNumber&&(y.invoiceNumber=d.invoiceNumber);let m=await x.updateShipment(t,y);if(!m)return n.status(404).json({message:"Error al actualizar el env\xEDo"});let f=await x.createShipmentUpdate({shipmentId:t,status:d.status,location:d.location||null,comments:d.comments||null,updatedBy:s.id});try{await x.recalculateShipmentCycleTime(t),console.log(`[Cycle Times] Recalculated for shipment ${t}`)}catch(N){console.error(`[Cycle Times] Error recalculating for shipment ${t}:`,N)}let I=!1,E=null;if(g&&d.sendNotification!==!1)try{let N=null,C=!0,A=null;if(m.customerId){let w=await l("SELECT id, email, email_notifications FROM clients WHERE id = $1 LIMIT 1",[m.customerId]);if(w.length>0){let S=w[0];N=S.email,C=S.email_notifications!==!1,A=S.id,console.log(`[Notification] Cliente encontrado: ${N}, notificaciones: ${C}`)}}if(!N&&m.customerEmail&&(N=m.customerEmail,C=!0,console.log(`[Notification] Usando customerEmail legacy: ${N}`)),N&&C)if((await l(`SELECT id FROM shipment_notifications 
               WHERE shipment_id = $1 AND shipment_status = $2 AND status = 'sent' LIMIT 1`,[t,d.status])).length>0)console.log(`[Notification] Ya existe notificaci\xF3n enviada para estado ${d.status}, omitiendo duplicado`),E="Notificaci\xF3n ya enviada previamente para este estado";else{let{sendShipmentStatusNotification:S}=await Promise.resolve().then(()=>(Yt(),tn)),D=await S({to:N,shipment:m,status:d.status});await x.createShipmentNotification({shipmentId:t,emailTo:N,subject:`Actualizaci\xF3n de Env\xEDo - ${d.status}`,status:"sent",sentBy:s.id,shipmentStatus:d.status,errorMessage:null}),I=!0,console.log(`[Notification] Email enviado exitosamente a ${N} (${D.provider})`)}else N?C||(E="Cliente tiene notificaciones deshabilitadas",console.log(`[Notification] Cliente ${N} tiene notificaciones deshabilitadas`)):(E="No hay email de cliente configurado",console.log("[Notification] Sin email de cliente para enviar notificaci\xF3n"))}catch(N){if(console.error("[Notification] Error al enviar notificaci\xF3n:",N),E=N instanceof Error?N.message:"Error desconocido",m.customerEmail)try{await x.createShipmentNotification({shipmentId:t,emailTo:m.customerEmail,subject:`Actualizaci\xF3n de Env\xEDo - ${d.status}`,status:"failed",sentBy:s.id,shipmentStatus:d.status,errorMessage:E})}catch(C){console.error("[Notification] Error al registrar fallo:",C)}}n.json({shipment:m,update:f,emailNotificationSent:I,emailWarning:E})}catch(t){if(console.error("[PUT /api/shipments/:id/status] Error:",t),t instanceof q.ZodError)return n.status(400).json({message:"Datos inv\xE1lidos",errors:t.errors});n.status(500).json({message:"Error interno del servidor"})}}),a.get("/api/shipments/:id/notifications",$,async(i,n)=>{try{let t=parseInt(i.params.id),s=await x.getShipmentNotificationsByShipment(t);n.json(s)}catch(t){console.error("[GET /api/shipments/:id/notifications] Error:",t),n.status(500).json({message:"Error interno del servidor"})}}),a.get("/api/shipments/:id/cycle-times",$,async(i,n)=>{try{let t=parseInt(i.params.id),s=await x.recalculateShipmentCycleTime(t);if(!s)return n.status(404).json({message:"Env\xEDo no encontrado"});n.json(s)}catch(t){console.error("[GET /api/shipments/:id/cycle-times] Error:",t),n.status(500).json({message:"Error interno del servidor"})}}),a.get("/api/metrics/cycle-times",$,async(i,n)=>{try{let t=i.query.companyId?parseInt(i.query.companyId):void 0,s=i.query.startDate,d=i.query.endDate,u=await x.getAggregateCycleTimes(t,s,d);n.json(u)}catch(t){console.error("[GET /api/metrics/cycle-times] Error:",t),n.status(500).json({message:"Error interno del servidor"})}}),a.get("/api/job-profiles/:userId",$,async(i,n)=>{try{let t=parseInt(i.params.userId),s=await x.getJobProfileWithDetails(t);if(!s)return n.status(404).json({message:"Perfil de trabajo no encontrado"});n.json(s)}catch(t){console.error("[GET /api/job-profiles/:userId] Error:",t),n.status(500).json({message:"Error interno del servidor"})}}),a.get("/api/user-kpis/:userId",$,async(i,n)=>{try{let t=parseInt(i.params.userId),s=await x.getUserKpis(t);n.json(s)}catch(t){console.error("[GET /api/user-kpis/:userId] Error:",t),n.status(500).json({message:"Error interno del servidor"})}}),a.get("/api/kpi-overview",$,async(i,n)=>{try{let t=await x.getKPIOverview();n.json(t)}catch(t){console.error("[GET /api/kpi-overview] Error:",t),n.status(500).json({message:"Error interno del servidor"})}}),a.get("/api/kpi-history/:kpiId",$,async(i,n)=>{try{let t=parseInt(i.params.kpiId),s=parseInt(i.query.months)||12,d=i.query.companyId?parseInt(i.query.companyId,10):void 0,u=await x.getKPIHistory(t,s,d);n.json(u)}catch(t){console.error("[GET /api/kpi-history/:kpiId] Error:",t),n.status(500).json({message:"Error interno del servidor"})}}),a.get("/api/user-kpi-history/:userId",async(i,n)=>{try{let t=parseInt(i.params.userId),s=parseInt(i.query.months)||6;console.log(`[GET /api/user-kpi-history/:userId] Requested userId: ${t}, months: ${s}`);let d=await x.getUserKPIHistory(t,s);console.log(`[GET /api/user-kpi-history/:userId] Returning ${d?.length||0} records for user ${t}`),n.json(d)}catch(t){console.error("[GET /api/user-kpi-history/:userId] Error:",t),n.status(500).json({message:"Error interno del servidor"})}}),a.get("/api/kpi-history-by-users/:kpiId",$,async(i,n)=>{try{let t=parseInt(i.params.kpiId),s=parseInt(i.query.months)||6,d=await x.getKPIHistoryByUsers(t,s);if(!d)return n.status(404).json({message:"KPI no encontrado"});n.json(d)}catch(t){console.error("[GET /api/kpi-history-by-users/:kpiId] Error:",t),n.status(500).json({message:"Error interno del servidor"})}});let l=gn(process.env.DATABASE_URL);a.get("/api/clients-db",$,async(i,n)=>{try{let{companyId:t,search:s}=i.query,d="WHERE is_active = true",u=[],g=1;s&&(d+=` AND (name ILIKE $${g} OR email ILIKE $${g} OR client_code ILIKE $${g})`,u.push(`%${s}%`),g++);let y=await l(`
        SELECT 
          id, name, email, phone, contact_person, company, address,
          company_id as "companyId", client_code as "clientCode", city, state, postal_code, country,
          requires_receipt as "requiresReceipt", email_notifications as "emailNotifications", customer_type as "customerType",
          payment_terms as "paymentTerms", is_active as "isActive", created_at as "createdAt"
        FROM clients 
        ${d}
        ORDER BY name
      `,u);n.json(y)}catch(t){console.error("Error fetching clients from database:",t),n.status(500).json({error:"Failed to fetch clients"})}}),a.get("/api/clients-db/:id",$,async(i,n)=>{try{let t=parseInt(i.params.id),s=await l(`
        SELECT 
          id, name, email, phone, contact_person, company, address,
          company_id as "companyId", client_code as "clientCode", city, state, postal_code, country,
          requires_receipt as "requiresReceipt", email_notifications as "emailNotifications", customer_type as "customerType",
          payment_terms as "paymentTerms", is_active as "isActive", notes, created_at as "createdAt", updated_at as "updatedAt"
        FROM clients 
        WHERE id = $1 AND is_active = true
      `,[t]);if(s.length===0)return n.status(404).json({error:"Client not found"});n.json(s[0])}catch(t){console.error("Error fetching client:",t),n.status(500).json({error:"Failed to fetch client"})}}),a.get("/api/clients",$,async(i,n)=>{try{let t=await l(`
        SELECT 
          id, name, email, phone, contact_person as contact_name,
          address as billing_addr, address as shipping_addr,
          client_code as rfc, is_active, company_id,
          email_notifications
        FROM clients 
        WHERE is_active = true
        ORDER BY name
      `);n.json(t)}catch(t){console.error("Error fetching clients for logistics:",t),n.status(500).json({error:"Failed to fetch clients"})}}),a.get("/api/products",$,async(i,n)=>{try{let{companyId:t}=i.query;console.log("\u{1F535} [GET /api/products] companyId recibido:",t);let s="WHERE is_active = true",d=[];if(t){let g=parseInt(t);s+=" AND company_id = $1",d.push(g),console.log(`\u{1F535} [GET /api/products] Filtrando por company_id = ${g}`)}else console.log("\u26A0\uFE0F  [GET /api/products] No se recibi\xF3 companyId, retornando todos los productos activos");let u=await l(`
        SELECT id, name, company_id, is_active
        FROM products 
        ${s}
        ORDER BY name
      `,d);console.log(`\u{1F4CA} [GET /api/products] Retornando ${u.length} productos`),n.json(u)}catch(t){console.error("Error fetching products:",t),n.status(500).json({error:"Failed to fetch products"})}}),a.post("/api/products",$,async(i,n)=>{try{let t=V(i),{name:s,companyId:d}=i.body;if(!s||!s.trim())return n.status(400).json({error:"El nombre del producto es requerido"});if((await l(`
        SELECT id FROM products 
        WHERE LOWER(name) = LOWER($1) AND company_id = $2 AND is_active = true
      `,[s.trim(),d||null])).length>0)return n.status(409).json({error:"Ya existe un producto con ese nombre"});let g=await l(`
        INSERT INTO products (name, company_id, is_active, created_at, updated_at)
        VALUES ($1, $2, true, NOW(), NOW())
        RETURNING id, name, company_id, is_active
      `,[s.trim(),d||null]);console.log(`\u2705 [POST /api/products] Producto creado por ${t.name}:`,g[0]),n.status(201).json(g[0])}catch(t){console.error("[POST /api/products] Error:",t),n.status(500).json({error:"Failed to create product"})}}),a.put("/api/products/:id",$,async(i,n)=>{try{let t=V(i),s=parseInt(i.params.id),{name:d,is_active:u,companyId:g}=i.body;if(!d||!d.trim())return n.status(400).json({error:"El nombre del producto es requerido"});if((await l(`
        SELECT id FROM products 
        WHERE LOWER(name) = LOWER($1) AND company_id = $2 AND id != $3 AND is_active = true
      `,[d.trim(),g||null,s])).length>0)return n.status(409).json({error:"Ya existe otro producto con ese nombre"});let m=[],f=[],I=1;d&&(m.push(`name = $${I++}`),f.push(d.trim())),u!==void 0&&(m.push(`is_active = $${I++}`),f.push(u)),g!==void 0&&(m.push(`company_id = $${I++}`),f.push(g===""||g===null?null:g)),m.push("updated_at = NOW()"),f.push(s);let E=await l(`
        UPDATE products 
        SET ${m.join(", ")}
        WHERE id = $${I}
        RETURNING id, name, company_id, is_active
      `,f);if(E.length===0)return n.status(404).json({error:"Producto no encontrado"});console.log(`\u2705 [PUT /api/products/${s}] Producto actualizado por ${t.name}`),n.json(E[0])}catch(t){console.error("[PUT /api/products/:id] Error:",t),n.status(500).json({error:"Failed to update product"})}}),a.delete("/api/products/:id",$,async(i,n)=>{try{let t=V(i),s=parseInt(i.params.id),d=await l(`
        UPDATE products 
        SET is_active = false, updated_at = NOW()
        WHERE id = $1
        RETURNING id, name
      `,[s]);if(d.length===0)return n.status(404).json({error:"Producto no encontrado"});console.log(`\u2705 [DELETE /api/products/${s}] Producto desactivado por ${t.name}:`,d[0].name),n.json({success:!0,message:"Producto eliminado exitosamente"})}catch(t){console.error("[DELETE /api/products/:id] Error:",t),n.status(500).json({error:"Failed to delete product"})}}),a.post("/api/clients",$,ct("companyId"),async(i,n)=>{try{let t=Ut.parse(i.body),s=await l(`
        INSERT INTO clients (
          name, email, phone, contact_person, company, address,
          payment_terms, requires_receipt, reminder_frequency, is_active,
          notes, company_id, client_code, secondary_email, city, state,
          postal_code, country, email_notifications, customer_type
        ) VALUES (
          $1, $2, $3, $4, $5, $6, $7, $8, $9, $10,
          $11, $12, $13, $14, $15, $16, $17, $18, $19, $20
        )
        RETURNING *
      `,[t.name,t.email||null,t.phone||null,t.contactPerson||null,t.company||null,t.address||null,t.paymentTerms||null,t.requiresReceipt??!0,t.reminderFrequency||null,t.isActive??!0,t.notes||null,t.companyId||null,t.clientCode||null,t.secondaryEmail||null,t.city||null,t.state||null,t.postalCode||null,t.country||"M\xE9xico",t.emailNotifications??!0,t.customerType||null]);n.status(201).json(s[0])}catch(t){if(console.error("Error creating client:",t),t instanceof q.ZodError)return n.status(400).json({error:"Validaci\xF3n fallida",details:t.errors});n.status(500).json({error:"Failed to create client"})}}),a.post("/api/admin/send-activation-emails",$,async(i,n)=>{try{if(V(i).role!=="admin")return n.status(403).json({message:"Solo administradores pueden enviar emails de activaci\xF3n masiva"});let s=await x.getUsers(),d=0,u=0;for(let g of s)try{let y=await x.createActivationToken(g.email),f=`${process.env.NODE_ENV==="production"?`https://${process.env.REPL_SLUG}.${process.env.REPL_OWNER||"user"}.replit.app`:"http://localhost:5000"}/activate/${y.token}`;await zt({to:g.email,from:"daniel@econova.com.mx",subject:"\u{1F510} Activa tu cuenta en ECONOVA KPI Dashboard",html:`
              <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #f8f9fa;">
                <div style="background: linear-gradient(135deg, #273949 0%, #b5e951 100%); color: white; padding: 30px; text-align: center; border-radius: 10px;">
                  <h1 style="margin: 0; font-size: 28px;">\xA1Bienvenido a ECONOVA!</h1>
                  <p style="margin: 10px 0 0 0; font-size: 16px;">KPI Dashboard - Sistema de Gesti\xF3n</p>
                </div>
                
                <div style="background: white; padding: 30px; border-radius: 10px; margin: 20px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                  <h2 style="color: #273949; margin-top: 0;">Hola ${g.name},</h2>
                  
                  <p>Tu cuenta ha sido creada en el Sistema ECONOVA KPI Dashboard. Para completar la configuraci\xF3n y acceder al sistema, necesitas establecer tu contrase\xF1a personal.</p>
                  
                  <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; margin: 20px 0;">
                    <h3 style="margin: 0 0 10px 0; color: #1976d2;">\u{1F4E7} Tu informaci\xF3n de acceso:</h3>
                    <p style="margin: 0;"><strong>Email:</strong> ${g.email}</p>
                    <p style="margin: 5px 0 0 0;"><strong>Rol:</strong> ${g.role}</p>
                  </div>
                  
                  <div style="text-align: center; margin: 30px 0;">
                    <a href="${f}" style="background: linear-gradient(135deg, #273949 0%, #b5e951 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-size: 16px; font-weight: bold; display: inline-block;">
                      \u{1F510} Activar mi cuenta
                    </a>
                  </div>
                  
                  <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 20px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #856404;">\u26A0\uFE0F Informaci\xF3n importante:</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #856404;">
                      <li>Este enlace es v\xE1lido por <strong>24 horas</strong></li>
                      <li>Solo puedes usarlo <strong>una vez</strong></li>
                      <li>Elige una contrase\xF1a segura (m\xEDnimo 8 caracteres)</li>
                      <li>Nunca compartas tus credenciales de acceso</li>
                    </ul>
                  </div>
                  
                  <p style="color: #666; font-size: 14px;">Si no puedes hacer clic en el bot\xF3n, copia y pega este enlace en tu navegador:</p>
                  <p style="word-break: break-all; background: #f5f5f5; padding: 10px; border-radius: 5px; font-size: 12px; color: #666;">${f}</p>
                </div>
                
                <div style="text-align: center; color: #666; font-size: 12px;">
                  <p>\xA9 2025 ECONOVA - KPI Dashboard</p>
                  <p>Sistema de Gesti\xF3n de Indicadores de Rendimiento</p>
                </div>
              </div>
            `})?d++:u++}catch(y){console.error(`Error sending activation email to ${g.email}:`,y),u++}await x.deleteExpiredTokens(),n.json({message:"Emails de activaci\xF3n enviados",totalUsers:s.length,successful:d,failed:u})}catch(t){console.error("[POST /api/admin/send-activation-emails] Error:",t),n.status(500).json({message:"Error interno del servidor"})}}),a.get("/api/activate/:token",async(i,n)=>{try{let{token:t}=i.params,s=await x.getActivationToken(t);if(!s)return n.status(404).json({error:"Token no v\xE1lido",message:"El enlace de activaci\xF3n no es v\xE1lido o ha expirado"});if(new Date>s.expiresAt)return n.status(400).json({error:"Token expirado",message:"El enlace de activaci\xF3n ha expirado. Solicita uno nuevo al administrador"});if(s.used)return n.status(400).json({error:"Token ya utilizado",message:"Este enlace de activaci\xF3n ya fue utilizado"});let d=await x.getUserByEmail(s.email);if(!d)return n.status(404).json({error:"Usuario no encontrado",message:"No se encontr\xF3 un usuario asociado a este token"});n.json({valid:!0,email:s.email,user:We(d),expiresAt:s.expiresAt})}catch(t){console.error("[GET /api/activate/:token] Error:",t),n.status(500).json({error:"Error interno",message:"Error interno del servidor"})}}),a.post("/api/activate/:token",async(i,n)=>{try{let{token:t}=i.params,{password:s}=i.body;if(!s||s.length<8)return n.status(400).json({message:"La contrase\xF1a debe tener al menos 8 caracteres"});let d=await x.getActivationToken(t);if(!d)return n.status(404).json({message:"Token no v\xE1lido o expirado"});if(new Date>d.expiresAt)return n.status(400).json({message:"El enlace de activaci\xF3n ha expirado"});if(d.used)return n.status(400).json({message:"Este enlace de activaci\xF3n ya fue utilizado"});let u=await x.getUserByEmail(d.email);if(!u)return n.status(404).json({message:"Usuario no encontrado"});let g=await dt(s,10);await x.updateUser(u.id,{password:g}),await x.markTokenAsUsed(t),await x.deleteExpiredTokens(),n.json({message:"\xA1Contrase\xF1a establecida exitosamente! Ya puedes iniciar sesi\xF3n",user:We(u)})}catch(t){console.error("[POST /api/activate/:token] Error:",t),n.status(500).json({message:"Error interno del servidor"})}}),a.post("/api/seed-production",async(i,n)=>{try{let{seedProductionData:t}=await Promise.resolve().then(()=>(sn(),an)),s=await t();n.json(s)}catch(t){n.status(500).json({success:!1,message:"Seeding failed",error:t instanceof Error?t.message:String(t)})}}),a.get("/api/debug-database",async(i,n)=>{try{let t=await x.getCompanies(),s=await x.getAreas(),d=await x.getKpis();n.json({companies:t,areas:s,kpis:d,totalCompanies:t.length,totalAreas:s.length,totalKpis:d.length})}catch(t){n.status(500).json({error:t instanceof Error?t.message:String(t)})}}),a.get("/api/treasury/payments",$,async(i,n)=>{try{let{companyId:t,status:s}=i.query,d="WHERE 1=1",u=[],g=1;t&&(d+=` AND company_id = $${g}`,u.push(parseInt(t)),g++),s&&(d+=` AND status = $${g}`,u.push(s),g++);let y=await l(`
        SELECT * FROM scheduled_payments
        ${d}
        ORDER BY due_date ASC
      `,u);n.json(y)}catch(t){console.error("Error fetching payments:",t),n.status(500).json({error:"Failed to fetch payments"})}}),a.post("/api/treasury/payments",$,async(i,n)=>{try{let t=V(i),s={...i.body,createdBy:t.id},d=await l(`
        INSERT INTO scheduled_payments (
          company_id, supplier_name, amount, currency, due_date,
          status, reference, notes, created_by
        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
        RETURNING *
      `,[s.companyId,s.supplierName,s.amount,s.currency||"MXN",s.dueDate,s.status||"pending",s.reference||null,s.notes||null,s.createdBy]);n.status(201).json(d[0])}catch(t){console.error("Error creating payment:",t),n.status(500).json({error:"Failed to create payment"})}}),a.put("/api/treasury/payments/:id/pay",$,async(i,n)=>{try{let t=V(i),s=parseInt(i.params.id),d=await l(`
        UPDATE scheduled_payments
        SET status = 'paid', paid_at = NOW(), paid_by = $1, updated_at = NOW()
        WHERE id = $2
        RETURNING *
      `,[t.id,s]);if(d.length===0)return n.status(404).json({error:"Payment not found"});n.json(d[0])}catch(t){console.error("Error marking payment as paid:",t),n.status(500).json({error:"Failed to mark payment as paid"})}}),a.get("/api/scheduled-payments/:id/documents",$,async(i,n)=>{try{let t=parseInt(i.params.id),{db:s}=await Promise.resolve().then(()=>(le(),Ke)),{scheduledPayments:d,paymentVouchers:u}=await Promise.resolve().then(()=>(ie(),Ne)),{eq:g}=await import("drizzle-orm"),[y]=await s.select().from(d).where(g(d.id,t));if(!y)return n.status(404).json({error:"Cuenta por pagar no encontrada"});let m=[];if(y.hydralFileUrl&&y.hydralFileName&&m.push({type:"invoice",name:y.hydralFileName,url:y.hydralFileUrl,uploadedAt:y.createdAt}),y.voucherId){let[f]=await s.select().from(u).where(g(u.id,y.voucherId));f&&(m.push({type:"voucher",name:f.voucherFileName,url:f.voucherFileUrl,uploadedAt:f.createdAt,extractedAmount:f.extractedAmount,extractedDate:f.extractedDate,extractedBank:f.extractedBank,extractedReference:f.extractedReference}),f.complementFileUrl&&f.complementFileName&&m.push({type:"rep",name:f.complementFileName,url:f.complementFileUrl,uploadedAt:f.updatedAt}))}n.json({scheduledPaymentId:t,documents:m})}catch(t){console.error("Error fetching documents:",t),n.status(500).json({error:"Error al obtener documentos"})}}),a.put("/api/scheduled-payments/:id/status",$,async(i,n)=>{try{let t=parseInt(i.params.id),d=q.object({status:q.enum(["idrall_imported","pending_approval","approved","payment_scheduled","payment_pending","payment_completed","voucher_uploaded","closed"])}).parse(i.body),{db:u}=await Promise.resolve().then(()=>(le(),Ke)),{scheduledPayments:g}=await Promise.resolve().then(()=>(ie(),Ne)),{eq:y}=await import("drizzle-orm"),[m]=await u.update(g).set({status:d.status,updatedAt:new Date}).where(y(g.id,t)).returning();if(!m)return n.status(404).json({error:"Cuenta por pagar no encontrada"});n.json(m)}catch(t){if(console.error("Error updating scheduled payment status:",t),t instanceof q.ZodError)return n.status(400).json({error:"Validaci\xF3n fallida",details:t.errors});n.status(500).json({error:"Error al actualizar estado"})}});let p=ke({storage:ke.diskStorage({destination:(i,n,t)=>{let s=Oe.join(process.cwd(),"uploads","idrall");fe.existsSync(s)||fe.mkdirSync(s,{recursive:!0}),t(null,s)},filename:(i,n,t)=>{let s=Date.now()+"-"+Math.round(Math.random()*1e9);t(null,`idrall-${s}-${n.originalname}`)}}),fileFilter:(i,n,t)=>{["application/pdf","application/zip","application/x-zip-compressed"].includes(n.mimetype)||n.originalname.toLowerCase().endsWith(".pdf")||n.originalname.toLowerCase().endsWith(".zip")?t(null,!0):t(new Error("Solo se permiten archivos PDF o ZIP"))},limits:{fileSize:50*1024*1024}});console.log("\u2705 [Routes] Registrando endpoint POST /api/treasury/idrall/upload"),a.post("/api/treasury/idrall/upload",$,c,(i,n,t)=>{p.array("files",10)(i,n,s=>{if(s)return console.error("\u274C Multer error (Idrall):",s.message),n.status(400).json({error:s.message});t()})},async(i,n)=>{try{let t=V(i),s=i.files,{companyId:d}=i.body;if(!s||s.length===0)return n.status(400).json({error:"No se subieron archivos"});if(!d)return n.status(400).json({error:"companyId es requerido"});console.log(`\u{1F4E6} [Idrall Upload] Procesando ${s.length} archivo(s) para empresa ${d}`);let{analyzePaymentDocument:u}=await Promise.resolve().then(()=>(wt(),St)),g=await import("fs"),y=[],m=[],f=0;for(let N of s)try{let C=await g.promises.readFile(N.path),A=N.mimetype||Oe.extname(N.originalname).toLowerCase(),w=await u(C,A);w.documentType==="cxp"&&w.cxpRecords?(y.push(...w.cxpRecords),f++):w.documentType==="cxp"?w.extractedSupplierName&&w.extractedAmount&&(y.push({supplierName:w.extractedSupplierName,amount:w.extractedAmount,currency:w.extractedCurrency||"MXN",dueDate:w.extractedDueDate||w.extractedDate||new Date,reference:w.extractedReference,status:null,notes:w.notes}),f++):m.push(`Archivo ${N.originalname} no es un documento CxP v\xE1lido`)}catch(C){console.error(`\u274C [Idrall Upload] Error procesando ${N.originalname}:`,C),m.push(`Error procesando ${N.originalname}: ${C.message}`)}let I=[],E=[];for(let N of y)try{let C=await l(`
            SELECT id FROM suppliers 
            WHERE LOWER(name) LIKE LOWER($1) 
            AND company_id = $2 
            AND is_active = true
            LIMIT 1
          `,[`%${N.supplierName}%`,parseInt(d)]),A=C.length>0?C[0].id:null,w=await l(`
            INSERT INTO scheduled_payments (
              company_id, supplier_id, supplier_name, amount, currency, due_date,
              status, reference, notes, source_type, hydral_file_url, hydral_file_name, created_by
            ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13)
            RETURNING *
          `,[parseInt(d),A,N.supplierName,N.amount,N.currency||"MXN",N.dueDate,"idrall_imported",N.reference,N.notes,"idrall",s[0].path,s[0].originalname,t.id]);I.push(w[0])}catch(C){console.error("\u274C [Idrall Upload] Error creando registro:",C),E.push(`Error creando CxP para ${N.supplierName}: ${C.message}`)}console.log(`\u2705 [Idrall Upload] Procesamiento completado: ${I.length} CxP creados, ${E.length} errores`),n.status(201).json({success:!0,created:I.length,payments:I,processing:{totalRecords:y.length,processedFiles:f,errors:[...m,...E]}})}catch(t){console.error("\u274C [Idrall Upload] Error procesando archivos Idrall:",t),n.status(500).json({error:t.message||"Failed to process Idrall files"})}}),a.get("/api/treasury/exchange-rates",$,async(i,n)=>{try{let{limit:t=100}=i.query,d=(await l(`
        SELECT 
          er.id,
          er.buy_rate,
          er.sell_rate,
          er.source,
          er.date::text as date,
          er.notes,
          u.name as created_by_name,
          u.email as created_by_email
        FROM exchange_rates er
        LEFT JOIN users u ON er.created_by = u.id
        ORDER BY er.date DESC
        LIMIT $1
      `,[parseInt(t)])).map(u=>({...u,date:new Date(u.date).toISOString()}));n.json(d)}catch(t){k.error("Error fetching exchange rates",t),n.status(500).json({error:"Failed to fetch exchange rates"})}}),a.get("/api/treasury/exchange-rates/daily",$,async(i,n)=>{try{let t=i.query.rateType||"buy",s=i.query.days?parseInt(i.query.days):void 0,d=s&&s>0&&s<=7?s:1,u=i.query.sources,g=new Date;g.setHours(g.getHours()-d*24),g.setMinutes(0,0,0);let y=null;if(u){y=Array.isArray(u)?u.map(S=>S.toLowerCase().trim()):[u].map(S=>S.toLowerCase().trim());let A=["monex","santander","dof"],w=y.filter(S=>!A.includes(S));if(w.length>0)return n.status(400).json({error:`Fuentes inv\xE1lidas: ${w.join(", ")}. Fuentes v\xE1lidas: ${A.join(", ")}`})}k.debug(`[Daily Exchange Rates] Request - rateType: ${t}, days: ${d}`,{rateType:t,days:d,sources:y,since:g.toISOString()});let m=`
        SELECT 
          er.buy_rate,
          er.sell_rate,
          er.source,
          er.date::text as date
        FROM exchange_rates er
        WHERE er.date >= $1
      `,f=[g.toISOString()];y&&y.length>0&&(m+=` AND LOWER(TRIM(er.source)) IN (${y.map((A,w)=>`$${w+2}`).join(", ")})`,f.push(...y)),m+=" ORDER BY er.date ASC";let I=await l(m,f);k.debug(`[Daily Exchange Rates] Resultados de BD: ${I.length} registros`,{count:I.length});let E=new Map,N=new Map;I.forEach(A=>{let w=new Date(A.date),S=String(w.getHours()).padStart(2,"0"),D=String(w.getMinutes()).padStart(2,"0"),M=`${S}:${D}`,O=(A.source||"").toLowerCase().trim(),Y=`${M}_${O}`,G=parseFloat(t==="buy"?A.buy_rate:A.sell_rate);(!N.has(Y)||w>N.get(Y).timestamp)&&N.set(Y,{timestamp:w,rate:G})}),N.forEach((A,w)=>{let[S,D]=w.split("_");E.has(S)||E.set(S,{hour:S,timestamp:A.timestamp.toISOString(),santander:void 0,monex:void 0,dof:void 0});let M=E.get(S);new Date(A.timestamp)>new Date(M.timestamp)&&(M.timestamp=A.timestamp.toISOString()),D==="santander"?M.santander=A.rate:D==="monex"?M.monex=A.rate:D==="dof"&&(M.dof=A.rate)});let C=Array.from(E.values()).sort((A,w)=>new Date(A.timestamp).getTime()-new Date(w.timestamp).getTime());k.debug(`[Daily Exchange Rates] Resultado formateado: ${C.length} puntos de datos`,{count:C.length,firstPoint:C[0]||null,lastPoint:C[C.length-1]||null}),n.json(C)}catch(t){k.error("\u274C [Daily Exchange Rates] Error",t),n.status(500).json({error:"Failed to fetch daily exchange rates"})}}),a.get("/api/treasury/exchange-rates/monthly",$,async(i,n)=>{try{let t=parseInt(i.query.year)||new Date().getFullYear(),s=parseInt(i.query.month)||new Date().getMonth()+1,d=i.query.rateType||"buy",u=i.query.months?parseInt(i.query.months):void 0,g=u&&u>0&&u<=12?u:1,y=i.query.sources,m=new Date(t,s-1,1);m.setHours(0,0,0,0);let f=new Date(t,s-1+g,0,23,59,59),I=null;if(y){I=Array.isArray(y)?y.map(M=>M.toLowerCase().trim()):[y].map(M=>M.toLowerCase().trim());let S=["monex","santander","dof"],D=I.filter(M=>!S.includes(M));if(D.length>0)return n.status(400).json({error:`Fuentes inv\xE1lidas: ${D.join(", ")}. Fuentes v\xE1lidas: ${S.join(", ")}`})}k.debug("[Monthly Exchange Rates] Request",{year:t,month:s,months:g,rateType:d,sources:I,startDate:m.toISOString(),endDate:f.toISOString()});let E=`
        SELECT 
          er.buy_rate,
          er.sell_rate,
          er.source,
          er.date::text as date
        FROM exchange_rates er
        WHERE er.date >= $1 AND er.date <= $2
      `,N=[m.toISOString(),f.toISOString()];I&&I.length>0&&(E+=` AND LOWER(TRIM(er.source)) IN (${I.map((S,D)=>`$${D+3}`).join(", ")})`,N.push(...I)),E+=" ORDER BY er.date ASC";let C=await l(E,N);k.debug(`[Monthly Exchange Rates] Resultados de BD: ${C.length} registros`,{count:C.length});let A=new Map;C.forEach(S=>{let D=new Date(S.date),M=D.getDate(),O=D.toISOString().split("T")[0],Y=parseFloat(d==="buy"?S.buy_rate:S.sell_rate),G=(S.source||"").toLowerCase().trim();A.has(M)||A.set(M,{day:M,date:O,santander:void 0,monex:void 0,dof:void 0});let ae=A.get(M);G==="santander"?(ae.santander||(ae.santander={sum:0,count:0}),ae.santander.sum+=parseFloat(Y),ae.santander.count+=1):G==="monex"?(ae.monex||(ae.monex={sum:0,count:0}),ae.monex.sum+=parseFloat(Y),ae.monex.count+=1):G==="dof"&&(ae.dof||(ae.dof={sum:0,count:0}),ae.dof.sum+=parseFloat(Y),ae.dof.count+=1)});let w=Array.from(A.values()).map(S=>({day:S.day,date:S.date,santander:S.santander?S.santander.sum/S.santander.count:void 0,monex:S.monex?S.monex.sum/S.monex.count:void 0,dof:S.dof?S.dof.sum/S.dof.count:void 0})).sort((S,D)=>S.day-D.day);k.debug(`[Monthly Exchange Rates] Resultado formateado: ${w.length} d\xEDas con datos`,{count:w.length,firstDay:w[0]||null,lastDay:w[w.length-1]||null}),n.json(w)}catch(t){k.error("\u274C [Monthly Exchange Rates] Error",t),n.status(500).json({error:"Failed to fetch monthly exchange rates"})}}),a.get("/api/treasury/exchange-rates/range",$,async(i,n)=>{try{let t=i.query.startDate,s=i.query.endDate,d=i.query.rateType||"buy",u=i.query.sources,g=i.query.interval||"day";if(!t||!s)return n.status(400).json({error:"startDate y endDate son requeridos",example:"/api/treasury/exchange-rates/range?startDate=2025-01-01&endDate=2025-01-07"});let y=new Date(t),m=new Date(s);if(isNaN(y.getTime())||isNaN(m.getTime()))return n.status(400).json({error:"Fechas inv\xE1lidas. Use formato ISO 8601 (YYYY-MM-DD)"});let f=Math.ceil((m.getTime()-y.getTime())/(1e3*60*60*24));if(f>365)return n.status(400).json({error:"El rango m\xE1ximo es de 365 d\xEDas (1 a\xF1o)"});if(m<y)return n.status(400).json({error:"endDate debe ser posterior a startDate"});let I=null;if(u){I=Array.isArray(u)?u.map(D=>D.toLowerCase().trim()):[u].map(D=>D.toLowerCase().trim());let w=["monex","santander","dof"],S=I.filter(D=>!w.includes(D));if(S.length>0)return n.status(400).json({error:`Fuentes inv\xE1lidas: ${S.join(", ")}. Fuentes v\xE1lidas: ${w.join(", ")}`})}k.debug("[Range Exchange Rates] Request",{startDate:t,endDate:s,rateType:d,sources:I,interval:g,daysDiff:f}),y.setHours(0,0,0,0),m.setHours(23,59,59,999);let E=`
        SELECT 
          er.buy_rate,
          er.sell_rate,
          er.source,
          er.date::text as date
        FROM exchange_rates er
        WHERE er.date >= $1 AND er.date <= $2
      `,N=[y.toISOString(),m.toISOString()];I&&I.length>0&&(E+=` AND LOWER(TRIM(er.source)) IN (${I.map((w,S)=>`$${S+3}`).join(", ")})`,N.push(...I)),E+=" ORDER BY er.date ASC";let C=await l(E,N);k.debug(`[Range Exchange Rates] Resultados de BD: ${C.length} registros`,{count:C.length});let A=[];if(g==="hour"){let w=new Map;C.forEach(S=>{let D=new Date(S.date),M=`${D.toISOString().split("T")[0]}T${String(D.getHours()).padStart(2,"0")}:00:00Z`;w.has(M)||w.set(M,{date:D.toISOString().split("T")[0],hour:`${String(D.getHours()).padStart(2,"0")}:00`,timestamp:M,santander:void 0,monex:void 0,dof:void 0});let O=w.get(M),Y=parseFloat(d==="buy"?S.buy_rate:S.sell_rate),G=(S.source||"").toLowerCase().trim();G==="santander"?O.santander=Y:G==="monex"?O.monex=Y:G==="dof"&&(O.dof=Y)}),A=Array.from(w.values()).sort((S,D)=>new Date(S.timestamp).getTime()-new Date(D.timestamp).getTime())}else if(g==="day"){let w=new Map;C.forEach(S=>{let M=new Date(S.date).toISOString().split("T")[0];w.has(M)||w.set(M,{date:M,santander:void 0,monex:void 0,dof:void 0});let O=w.get(M),Y=parseFloat(d==="buy"?S.buy_rate:S.sell_rate),G=(S.source||"").toLowerCase().trim();G==="santander"?(O.santander||(O.santander={sum:0,count:0}),O.santander.sum+=Y,O.santander.count+=1):G==="monex"?(O.monex||(O.monex={sum:0,count:0}),O.monex.sum+=Y,O.monex.count+=1):G==="dof"&&(O.dof||(O.dof={sum:0,count:0}),O.dof.sum+=Y,O.dof.count+=1)}),A=Array.from(w.values()).map(S=>({date:S.date,santander:S.santander?S.santander.sum/S.santander.count:void 0,monex:S.monex?S.monex.sum/S.monex.count:void 0,dof:S.dof?S.dof.sum/S.dof.count:void 0})).sort((S,D)=>new Date(S.date).getTime()-new Date(D.date).getTime())}else if(g==="month"){let w=new Map;C.forEach(S=>{let D=new Date(S.date),M=`${D.getFullYear()}-${String(D.getMonth()+1).padStart(2,"0")}`;w.has(M)||w.set(M,{year:D.getFullYear(),month:D.getMonth()+1,date:`${D.getFullYear()}-${String(D.getMonth()+1).padStart(2,"0")}-01`,santander:void 0,monex:void 0,dof:void 0});let O=w.get(M),Y=parseFloat(d==="buy"?S.buy_rate:S.sell_rate),G=(S.source||"").toLowerCase().trim();G==="santander"?(O.santander||(O.santander={sum:0,count:0}),O.santander.sum+=Y,O.santander.count+=1):G==="monex"?(O.monex||(O.monex={sum:0,count:0}),O.monex.sum+=Y,O.monex.count+=1):G==="dof"&&(O.dof||(O.dof={sum:0,count:0}),O.dof.sum+=Y,O.dof.count+=1)}),A=Array.from(w.values()).map(S=>({year:S.year,month:S.month,date:S.date,santander:S.santander?S.santander.sum/S.santander.count:void 0,monex:S.monex?S.monex.sum/S.monex.count:void 0,dof:S.dof?S.dof.sum/S.dof.count:void 0})).sort((S,D)=>S.year!==D.year?S.year-D.year:S.month-D.month)}k.debug(`[Range Exchange Rates] Resultado formateado: ${A.length} puntos`,{count:A.length,interval:g,firstPoint:A[0]||null,lastPoint:A[A.length-1]||null}),n.json(A)}catch(t){k.error("\u274C [Range Exchange Rates] Error",t),n.status(500).json({error:"Failed to fetch exchange rates for range"})}}),a.get("/api/treasury/exchange-rates/stats",$,async(i,n)=>{try{let t=i.query.startDate,s=i.query.endDate,d=i.query.rateType||"buy",u=i.query.sources;if(!t||!s)return n.status(400).json({error:"startDate y endDate son requeridos",example:"/api/treasury/exchange-rates/stats?startDate=2025-01-01&endDate=2025-01-31"});let g=new Date(t),y=new Date(s);if(isNaN(g.getTime())||isNaN(y.getTime()))return n.status(400).json({error:"Fechas inv\xE1lidas. Use formato ISO 8601 (YYYY-MM-DD)"});if(Math.ceil((y.getTime()-g.getTime())/(1e3*60*60*24))>365)return n.status(400).json({error:"El rango m\xE1ximo es de 365 d\xEDas (1 a\xF1o)"});if(y<g)return n.status(400).json({error:"endDate debe ser posterior a startDate"});let f=null;if(u){f=Array.isArray(u)?u.map(D=>D.toLowerCase().trim()):[u].map(D=>D.toLowerCase().trim());let w=["monex","santander","dof"],S=f.filter(D=>!w.includes(D));if(S.length>0)return n.status(400).json({error:`Fuentes inv\xE1lidas: ${S.join(", ")}. Fuentes v\xE1lidas: ${w.join(", ")}`})}k.debug("[Stats Exchange Rates] Request",{startDate:t,endDate:s,rateType:d,sources:f}),g.setHours(0,0,0,0),y.setHours(23,59,59,999);let I=`
        SELECT 
          er.buy_rate,
          er.sell_rate,
          er.source,
          er.date::text as date
        FROM exchange_rates er
        WHERE er.date >= $1 AND er.date <= $2
      `,E=[g.toISOString(),y.toISOString()];f&&f.length>0&&(I+=` AND LOWER(TRIM(er.source)) IN (${f.map((w,S)=>`$${S+3}`).join(", ")})`,E.push(...f)),I+=" ORDER BY er.date ASC";let N=await l(I,E);k.debug(`[Stats Exchange Rates] Resultados de BD: ${N.length} registros`,{count:N.length});let C=new Map;N.forEach(w=>{let S=parseFloat(d==="buy"?w.buy_rate:w.sell_rate),D=(w.source||"").toLowerCase().trim();C.has(D)||C.set(D,[]),C.get(D).push(S)});let A=Array.from(C.entries()).map(([w,S])=>{if(S.length===0)return null;let D=[...S].sort((Pe,_e)=>Pe-_e),M=D[0],O=D[D.length-1],G=S.reduce((Pe,_e)=>Pe+_e,0)/S.length,ae=S.reduce((Pe,_e)=>Pe+Math.pow(_e-G,2),0)/S.length,$e=Math.sqrt(ae),He=S[0],be=S[S.length-1],Ie=G*.001,oe="stable";return be>He+Ie?oe="up":be<He-Ie&&(oe="down"),{source:w.charAt(0).toUpperCase()+w.slice(1),average:Math.round(G*1e4)/1e4,max:Math.round(O*1e4)/1e4,min:Math.round(M*1e4)/1e4,volatility:Math.round($e*1e4)/1e4,trend:oe,count:S.length}}).filter(w=>w!==null);A.sort((w,S)=>{let D=["Monex","Santander","Dof"],M=D.indexOf(w.source),O=D.indexOf(S.source);return M!==-1&&O!==-1?M-O:M!==-1?-1:O!==-1?1:w.source.localeCompare(S.source)}),k.debug(`[Stats Exchange Rates] Estad\xEDsticas calculadas: ${A.length} fuentes`,{count:A.length,sources:A.map(w=>w.source)}),n.json(A)}catch(t){k.error("\u274C [Stats Exchange Rates] Error",t),n.status(500).json({error:"Failed to calculate exchange rate statistics"})}}),a.post("/api/treasury/exchange-rates/refresh-dof",$,async(i,n)=>{try{let t=V(i);console.log(`\u{1F504} [Manual DOF Refresh] Solicitado por usuario ${t.id} (${t.email})`);let{fetchDOFExchangeRate:s}=await Promise.resolve().then(()=>(or(),cn));await s(),n.json({success:!0,message:"Actualizaci\xF3n del DOF ejecutada correctamente",timestamp:new Date().toISOString()})}catch(t){console.error("Error al actualizar DOF manualmente:",t),n.status(500).json({error:"Failed to refresh DOF exchange rate"})}}),a.post("/api/treasury/exchange-rates",$,async(i,n)=>{try{let t=V(i),{buyRate:s,sellRate:d,source:u,notes:g}=i.body,m=(await l(`
        INSERT INTO exchange_rates (buy_rate, sell_rate, source, notes, created_by, date)
        VALUES ($1, $2, $3, $4, $5, NOW() AT TIME ZONE 'America/Mexico_City')
        RETURNING id, buy_rate, sell_rate, source, date::text as date, notes, created_by
      `,[s,d,u||null,g||null,t.id]))[0],f=new Date(m.date),I={...m,date:f.toISOString()};console.log("[Exchange Rate POST] Registro creado:",{id:m.id,source:u,buyRate:s,sellRate:d,rawDate:m.date,isoDate:I.date,timestamp:new Date().toISOString()}),n.status(201).json(I)}catch(t){console.error("Error creating exchange rate:",t),n.status(500).json({error:"Failed to create exchange rate"})}}),a.post("/api/treasury/request-purchase",$,async(i,n)=>{try{let t=V(i),{source:s,amountUsd:d,amountMxn:u,rate:g,notes:y}=i.body;if(!s||!d||!u||!g)return n.status(400).json({error:"Missing required fields"});let m="dolores@grupoorsega.com",f=`\u{1F4B0} Solicitud de Compra de D\xF3lares - ${s}`,I=`
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
          <h2 style="color: #2563eb; border-bottom: 3px solid #2563eb; padding-bottom: 10px;">
            \u{1F4B0} Solicitud de Compra de D\xF3lares
          </h2>
          
          <div style="background-color: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <p style="margin: 0; font-size: 16px;"><strong>Hola Lolita,</strong></p>
            <p style="margin: 10px 0; font-size: 14px;">
              Por favor compra <strong style="color: #2563eb; font-size: 18px;">${parseFloat(d).toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2})} USD</strong> 
              a precio de <strong style="color: #2563eb;">$${parseFloat(g).toFixed(4)} MXN</strong> (${s}).
            </p>
            <p style="margin: 10px 0; font-size: 14px;">
              <strong>Total a pagar:</strong> <span style="color: #16a34a; font-size: 18px;">$${parseFloat(u).toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2})} MXN</span>
            </p>
            ${y?`<p style="margin: 10px 0; font-size: 14px;"><strong>Nota:</strong> ${y}</p>`:""}
          </div>
          
          <div style="background-color: #eff6ff; padding: 15px; border-radius: 8px; border-left: 4px solid #2563eb;">
            <p style="margin: 0; font-size: 12px; color: #1e40af;">
              \u{1F4E7} Esta solicitud fue enviada desde el sistema por ${t.name||t.email}
            </p>
          </div>
          
          <p style="margin-top: 20px; font-size: 14px;">
            Gracias,<br>
            <strong>${t.name||"Emilio"}</strong>
          </p>
        </div>
      `,E=await Et.sendEmail({to:m,subject:f,html:I},"treasury");E.success||console.error("Error sending email:",E.error),n.status(200).json({success:!0,message:"Solicitud enviada exitosamente a Lolita",emailSent:E.success,requestId:Date.now()})}catch(t){console.error("Error processing purchase request:",t),n.status(500).json({error:"Failed to process purchase request"})}});let h=ke({storage:ke.diskStorage({destination:(i,n,t)=>{let s=Oe.join(process.cwd(),"uploads","receipts");fe.existsSync(s)||fe.mkdirSync(s,{recursive:!0}),t(null,s)},filename:(i,n,t)=>{let s=Date.now()+"-"+Math.round(Math.random()*1e9);t(null,s+"-"+n.originalname)}}),fileFilter:(i,n,t)=>{["application/pdf","application/xml","text/xml"].includes(n.mimetype)||n.originalname.endsWith(".xml")?t(null,!0):t(new Error("Solo se permiten archivos PDF y XML"))},limits:{fileSize:10*1024*1024}});a.post("/api/treasury/payments/:id/receipts",$,h.single("file"),async(i,n)=>{try{let t=V(i),s=parseInt(i.params.id),d=i.file;if(!d)return n.status(400).json({error:"No file uploaded"});let u=`/uploads/receipts/${d.filename}`,g=d.mimetype.includes("pdf")?"pdf":"xml",y=await l(`
        INSERT INTO payment_receipts (payment_id, file_name, file_url, file_type, uploaded_by)
        VALUES ($1, $2, $3, $4, $5)
        RETURNING *
      `,[s,d.originalname,u,g,t.id]);n.status(201).json(y[0])}catch(t){console.error("Error uploading receipt:",t),n.status(500).json({error:"Failed to upload receipt"})}}),a.get("/api/treasury/payments/:id/receipts",$,async(i,n)=>{try{let t=parseInt(i.params.id),s=await l(`
        SELECT * FROM payment_receipts
        WHERE payment_id = $1
        ORDER BY uploaded_at DESC
      `,[t]);n.json(s)}catch(t){console.error("Error fetching receipts:",t),n.status(500).json({error:"Failed to fetch receipts"})}}),a.post("/api/treasury/receipts/send",$,async(i,n)=>{try{let{receiptIds:t,emails:s}=i.body;if(!t||!s||s.length===0)return n.status(400).json({error:"receiptIds and emails are required"});let d=await l(`
        SELECT pr.*, sp.supplier_name, sp.amount, sp.currency, sp.reference
        FROM payment_receipts pr
        JOIN scheduled_payments sp ON pr.payment_id = sp.id
        WHERE pr.id = ANY($1)
      `,[t]);if(d.length===0)return n.status(404).json({error:"No receipts found"});let u=[];for(let m of d){let f=Oe.join(process.cwd(),m.file_url);if(fe.existsSync(f)){let E=fe.readFileSync(f).toString("base64");u.push({content:E,filename:m.file_name,type:m.file_type==="pdf"?"application/pdf":"application/xml",disposition:"attachment"})}}let g=d[0],y=qr(g,d);for(let m of s)await Lr({to:m,from:"marioreynoso@grupoorsega.com",subject:y.subject,html:y.html,text:y.text,attachments:u});await l(`
        UPDATE payment_receipts
        SET sent_to = $1, sent_at = NOW()
        WHERE id = ANY($2)
      `,[s,t]),n.json({success:!0,message:`Comprobantes enviados a ${s.join(", ")}`})}catch(t){console.error("Error sending receipts:",t),n.status(500).json({error:"Failed to send receipts"})}}),a.get("/api/treasury/complements",$,async(i,n)=>{try{let{companyId:t,status:s}=i.query,d="WHERE 1=1",u=[],g=1;t&&(d+=` AND company_id = $${g}`,u.push(parseInt(t)),g++),s&&(d+=` AND status = $${g}`,u.push(s),g++);let y=await l(`
        SELECT * FROM payment_complements
        ${d}
        ORDER BY created_at DESC
      `,u);n.json(y)}catch(t){console.error("Error fetching complements:",t),n.status(500).json({error:"Failed to fetch complements"})}}),a.post("/api/treasury/complements",$,async(i,n)=>{try{let t=V(i),{companyId:s,clientName:d,invoiceReference:u,amount:g,currency:y}=i.body,m=await l(`
        INSERT INTO payment_complements (
          company_id, client_name, invoice_reference, amount, currency, created_by
        ) VALUES ($1, $2, $3, $4, $5, $6)
        RETURNING *
      `,[s,d,u,g,y||"MXN",t.id]);n.status(201).json(m[0])}catch(t){console.error("Error creating complement:",t),n.status(500).json({error:"Failed to create complement"})}}),a.put("/api/treasury/complements/:id/generate",$,async(i,n)=>{try{let t=parseInt(i.params.id),s=`/uploads/complements/complement-${t}.pdf`,d=await l(`
        UPDATE payment_complements
        SET status = 'generated', generated_at = NOW(), complement_url = $1
        WHERE id = $2
        RETURNING *
      `,[s,t]);if(d.length===0)return n.status(404).json({error:"Complement not found"});n.json(d[0])}catch(t){console.error("Error generating complement:",t),n.status(500).json({error:"Failed to generate complement"})}}),a.get("/api/payment-vouchers",$,async(i,n)=>{try{let{companyId:t,status:s}=i.query,d;s&&t?d=await x.getPaymentVouchersByStatus(s,parseInt(t)):t?d=await x.getPaymentVouchersByCompany(parseInt(t)):s?d=await x.getPaymentVouchersByStatus(s):d=await x.getPaymentVouchers(),n.json(d)}catch(t){console.error("Error fetching payment vouchers:",t),n.status(500).json({error:"Failed to fetch payment vouchers"})}});let b=ke({storage:ke.diskStorage({destination:(i,n,t)=>{let s=Oe.join(process.cwd(),"uploads","payment-vouchers");fe.existsSync(s)||fe.mkdirSync(s,{recursive:!0}),t(null,s)},filename:(i,n,t)=>{let s=Date.now()+"-"+Math.round(Math.random()*1e9);t(null,`voucher-${s}-${n.originalname}`)}}),fileFilter:(i,n,t)=>{let s=["application/pdf","image/png","image/jpeg","image/jpg","application/xml","text/xml","application/xhtml+xml"],d=[".pdf",".png",".jpg",".jpeg",".xml"],u=n.originalname.toLowerCase().substring(n.originalname.lastIndexOf("."));s.includes(n.mimetype)||d.includes(u)?t(null,!0):t(new Error("Solo se permiten archivos PDF, XML, PNG, JPG, JPEG"))},limits:{fileSize:10*1024*1024}});a.post("/api/scheduled-payments/:id/upload-voucher",$,c,(i,n,t)=>{b.single("file")(i,n,s=>{if(s)return console.error("\u274C Multer error:",s.message),n.status(400).json({error:s.message});t()})},async(i,n)=>{try{let t=V(i),s=parseInt(i.params.id),d=i.file;if(!d)return n.status(400).json({error:"No se subi\xF3 ning\xFAn archivo"});let{db:u}=await Promise.resolve().then(()=>(le(),Ke)),{scheduledPayments:g}=await Promise.resolve().then(()=>(ie(),Ne)),{eq:y}=await import("drizzle-orm"),[m]=await u.select().from(g).where(y(g.id,s));if(!m)return n.status(404).json({error:"Cuenta por pagar no encontrada"});let{analyzePaymentDocument:f}=await Promise.resolve().then(()=>(wt(),St)),I=await import("fs"),E=await import("path"),N=I.readFileSync(d.path),C=await f(N,d.mimetype);if(C.documentType!=="voucher"&&C.documentType!=="rep")return n.status(400).json({error:"Documento inv\xE1lido",details:"Solo se pueden subir comprobantes de pago o REPs. Las facturas deben subirse primero."});let A=null;m.supplierId&&(A=await x.getClient(m.supplierId)),!A&&m.supplierName&&(A={id:m.supplierId||0,name:m.supplierName,companyId:m.companyId,email:null,requiresPaymentComplement:!1});let w=new Date,S=w.getFullYear(),D=String(w.getMonth()+1).padStart(2,"0"),M=E.join(process.cwd(),"uploads","comprobantes",String(S),D);I.existsSync(M)||I.mkdirSync(M,{recursive:!0});let O=`${Date.now()}-${d.originalname}`,Y=E.join(M,O);I.renameSync(d.path,Y);let ae=["extractedAmount","extractedDate","extractedBank","extractedReference","extractedCurrency"].every(F=>{let re=C[F];return re!=null}),$e;ae&&C.ocrConfidence>=.7?$e="validado":$e="pendiente_validacion";let He=Math.abs((m.amount-(C.extractedAmount||0))/m.amount),be=$e;He<=.01?be="cerrado":C.extractedAmount&&C.extractedAmount<m.amount&&(be="pendiente_complemento");let Ie={companyId:m.companyId,payerCompanyId:m.companyId,clientId:A?.id||m.supplierId||0,clientName:A?.name||m.supplierName||"Cliente",scheduledPaymentId:s,status:be,voucherFileUrl:Y,voucherFileName:d.originalname,voucherFileType:d.mimetype,extractedAmount:C.extractedAmount,extractedDate:C.extractedDate,extractedBank:C.extractedBank,extractedReference:C.extractedReference,extractedCurrency:C.extractedCurrency,extractedOriginAccount:C.extractedOriginAccount,extractedDestinationAccount:C.extractedDestinationAccount,extractedTrackingKey:C.extractedTrackingKey,extractedBeneficiaryName:C.extractedBeneficiaryName,ocrConfidence:C.ocrConfidence,uploadedBy:t.id},oe=await x.createPaymentVoucher(Ie),Pe=be==="cerrado"?"payment_completed":m.status;await u.update(g).set({voucherId:oe.id,status:Pe,paidAt:be==="cerrado"?new Date:m.paidAt,paidBy:be==="cerrado"?t.id:m.paidBy,updatedAt:new Date}).where(y(g.id,s)),console.log(`\u2705 [Upload Voucher] Comprobante vinculado a cuenta por pagar ${s}, voucher ID: ${oe.id}`);let[_e]=await u.select().from(g).where(y(g.id,s));n.status(201).json({voucher:oe,scheduledPayment:_e,analysis:C,documentType:C.documentType,message:"Comprobante subido y vinculado exitosamente"})}catch(t){if(console.error("Error uploading voucher to scheduled payment:",t),t instanceof q.ZodError)return n.status(400).json({error:"Validaci\xF3n fallida",details:t.errors});n.status(500).json({error:"Error al subir comprobante"})}}),console.log("\u2705 [Routes] Registrando endpoint POST /api/payment-vouchers/upload"),a.post("/api/payment-vouchers/upload-test",$,(i,n)=>{console.log("\u{1F9EA} [TEST] Endpoint de prueba llamado"),console.log("\u{1F9EA} [TEST] Content-Type:",i.headers["content-type"]),console.log("\u{1F9EA} [TEST] req.body:",i.body),console.log("\u{1F9EA} [TEST] req.body keys:",Object.keys(i.body||{})),n.json({message:"Test endpoint funcionando",contentType:i.headers["content-type"],bodyKeys:Object.keys(i.body||{}),body:i.body})}),a.post("/api/payment-vouchers/upload",$,c,(i,n,t)=>{console.log("\u{1F4E4} [Upload] ========== INICIO DE UPLOAD =========="),console.log("\u{1F4E4} [Upload] Petici\xF3n recibida en /api/payment-vouchers/upload"),console.log("\u{1F4E4} [Upload] Content-Type:",i.headers["content-type"]),console.log("\u{1F4E4} [Upload] Content-Length:",i.headers["content-length"]),console.log("\u{1F4E4} [Upload] req.body ANTES de multer:",i.body),console.log("\u{1F4E4} [Upload] req.body keys ANTES de multer:",Object.keys(i.body||{})),b.single("voucher")(i,n,s=>{if(s){console.error("\u274C [Multer] Error detectado:",{message:s.message,code:s.code,field:s.field,name:s.name}),console.error("\u274C [Multer] Stack trace:",s.stack);let d=s.message;return s.code==="LIMIT_FILE_SIZE"?d="El archivo excede el tama\xF1o m\xE1ximo permitido (10MB)":s.code==="LIMIT_UNEXPECTED_FILE"?d='Campo de archivo inesperado. Aseg\xFArate de usar el campo "voucher"':s.message.includes("Solo se permiten")&&(d=s.message),n.status(400).json({error:"Error al procesar archivo",details:d,code:s.code||"MULTER_ERROR"})}console.log("\u2705 [Multer] Archivo procesado exitosamente"),console.log("\u{1F4E4} [Upload] req.body DESPU\xC9S de multer:",i.body),console.log("\u{1F4E4} [Upload] req.body keys DESPU\xC9S de multer:",Object.keys(i.body||{})),console.log("\u{1F4E4} [Upload] req.file:",i.file?{originalname:i.file.originalname,mimetype:i.file.mimetype,size:i.file.size}:"null"),t()})},async(i,n)=>{try{let t=V(i),s=i.file;if(console.log("\u{1F4C1} [Upload] Archivo recibido:",s?{originalname:s.originalname,mimetype:s.mimetype,size:s.size,path:s.path}:"null"),!s)return console.error("\u274C [Upload] No se recibi\xF3 ning\xFAn archivo"),n.status(400).json({error:"No se subi\xF3 ning\xFAn archivo",details:"Aseg\xFArate de seleccionar un archivo antes de subirlo"});console.log("\u{1F50D} [Upload] Iniciando an\xE1lisis del documento...");let{analyzePaymentDocument:d}=await Promise.resolve().then(()=>(wt(),St)),u=await import("fs"),g=await import("path"),y=u.readFileSync(s.path);console.log("\u{1F4C4} [Upload] Buffer le\xEDdo, tama\xF1o:",y.length,"bytes");let m=await d(y,s.mimetype);console.log("\u2705 [Upload] An\xE1lisis completado:",{documentType:m.documentType,ocrConfidence:m.ocrConfidence,extractedAmount:m.extractedAmount,extractedSupplierName:m.extractedSupplierName}),console.log("\u{1F4CB} [Upload] req.body recibido:",JSON.stringify(i.body,null,2)),console.log("\u{1F4CB} [Upload] req.body keys:",Object.keys(i.body||{}));let f=F=>{if(F==null||F==="")return;let re=typeof F=="string"?Number(F):F;if(!(isNaN(re)||re<=0))return re},I={payerCompanyId:f(i.body?.payerCompanyId),clientId:f(i.body?.clientId),companyId:f(i.body?.companyId),scheduledPaymentId:f(i.body?.scheduledPaymentId),notes:i.body?.notes||void 0,notify:i.body?.notify==="true"||i.body?.notify==="1"||i.body?.notify===!0,emailTo:i.body?.emailTo?Array.isArray(i.body.emailTo)?i.body.emailTo:i.body.emailTo.split(",").map(F=>F.trim()).filter(F=>F):[],emailCc:i.body?.emailCc?Array.isArray(i.body.emailCc)?i.body.emailCc:i.body.emailCc.split(",").map(F=>F.trim()).filter(F=>F):[],emailMessage:i.body?.emailMessage||void 0};if(console.log("\u2705 [Upload] Datos parseados:",I),m.documentType==="invoice"&&!I.payerCompanyId)return n.status(400).json({error:"PayerCompanyId requerido",details:"Se requiere especificar la empresa pagadora para procesar la factura. Aseg\xFArate de seleccionar la empresa antes de subir el archivo."});if(console.log(`\u{1F4E4} [Upload] Procesando documento: ${s.originalname} (tipo: ${m.documentType})`),m.documentType==="invoice"){if(!m.extractedSupplierName||!m.extractedAmount||!m.extractedDueDate)return n.status(400).json({error:"Factura incompleta",details:"La factura debe contener al menos: proveedor, monto y fecha de vencimiento"});try{console.log("\u{1F4CB} [Invoice Detection] Factura detectada, creando cuenta por pagar autom\xE1ticamente");let F=null,re=m.extractedSupplierName||"",De=m.extractedTaxId||"";if(!I.payerCompanyId)return n.status(400).json({error:"PayerCompanyId requerido para procesar factura"});let Ue=I.payerCompanyId,Je=(await x.getClientsByCompany(Ue)).find(fr=>fr.name.toLowerCase().includes(re.toLowerCase())||re.toLowerCase().includes(fr.name.toLowerCase()));Je?(F=Je.id,console.log(`\u{1F517} [Invoice Detection] Proveedor encontrado: ${Je.name} (ID: ${F})`)):console.log(`\u26A0\uFE0F [Invoice Detection] Proveedor no encontrado, se crear\xE1 con nombre: ${re}`);let gt={companyId:Ue,supplierId:F,supplierName:re,amount:m.extractedAmount,currency:m.extractedCurrency||"MXN",dueDate:m.extractedDueDate,reference:m.extractedInvoiceNumber||m.extractedReference||`Factura ${Date.now()}`,status:"idrall_imported",sourceType:"manual",notes:`Factura detectada autom\xE1ticamente desde ${s.originalname}. ${De?`RFC: ${De}`:""}`,createdBy:t.id},Ye=await x.createScheduledPayment(gt);console.log(`\u2705 [Invoice Detection] Cuenta por pagar creada: ID ${Ye.id}`);let At=new Date().getFullYear(),yr=String(new Date().getMonth()+1).padStart(2,"0"),Ee=g.join(process.cwd(),"uploads","facturas",String(At),yr);u.existsSync(Ee)||u.mkdirSync(Ee,{recursive:!0});let Nt=`${Date.now()}-${s.originalname}`,yt=g.join(Ee,Nt);u.copyFileSync(s.path,yt);let{db:Nn}=await Promise.resolve().then(()=>(le(),Ke)),{scheduledPayments:hr}=await Promise.resolve().then(()=>(ie(),Ne)),{eq:Cn}=await import("drizzle-orm");return await Nn.update(hr).set({hydralFileUrl:yt,hydralFileName:s.originalname}).where(Cn(hr.id,Ye.id)),n.status(201).json({scheduledPayment:Ye,analysis:m,documentType:"invoice",message:"Factura procesada y cuenta por pagar creada exitosamente"})}catch(F){return console.error("\u274C [Invoice Detection] Error creando cuenta por pagar:",F),n.status(500).json({error:"Error al crear cuenta por pagar",details:F instanceof Error?F.message:"Error desconocido"})}}if(m.documentType==="voucher"&&!I.scheduledPaymentId)return n.status(400).json({error:"Los comprobantes deben asociarse a una factura existente",details:"Por favor, sube primero la factura o selecciona una cuenta por pagar existente"});let E=null,N=null;if(I.scheduledPaymentId){let{db:F}=await Promise.resolve().then(()=>(le(),Ke)),{scheduledPayments:re}=await Promise.resolve().then(()=>(ie(),Ne)),{eq:De}=await import("drizzle-orm"),[Ue]=await F.select().from(re).where(De(re.id,I.scheduledPaymentId));if(N=Ue,!N)return n.status(404).json({error:"Cuenta por pagar no encontrada"});N.supplierId&&(E=await x.getClient(N.supplierId)),!E&&N.supplierName&&(E={id:N.supplierId||0,name:N.supplierName,companyId:N.companyId,email:null,requiresPaymentComplement:!1})}else if(I.clientId){if(E=await x.getClient(I.clientId),!E)return n.status(404).json({error:"Cliente no encontrado"})}else return n.status(400).json({error:"Se requiere clientId o scheduledPaymentId para comprobantes"});let A=(m.documentType==="voucher"||m.documentType==="rep"?["extractedAmount","extractedDate","extractedBank","extractedReference","extractedCurrency"]:["extractedAmount","extractedSupplierName","extractedDueDate"]).every(F=>{let re=m[F];return re!=null}),w;A&&m.ocrConfidence>=.7?w="validado":w="pendiente_validacion";let S=new Date,D=S.getFullYear(),M=String(S.getMonth()+1).padStart(2,"0"),O=g.join(process.cwd(),"uploads","comprobantes",String(D),M);u.existsSync(O)||u.mkdirSync(O,{recursive:!0});let Y=`${Date.now()}-${s.originalname}`,G=g.join(O,Y);u.renameSync(s.path,G);let ae=I.companyId||E?.companyId||I.payerCompanyId,$e=I.clientId||(N?.supplierId??0);if(!$e||$e===0)return n.status(400).json({error:"Se requiere un cliente v\xE1lido para crear el comprobante"});if(!I.payerCompanyId)return n.status(400).json({error:"PayerCompanyId requerido para crear comprobante"});let He=I.payerCompanyId,be={companyId:ae,payerCompanyId:He,clientId:$e,clientName:E?.name||N?.supplierName||"Cliente",scheduledPaymentId:I.scheduledPaymentId||null,status:w,voucherFileUrl:G,voucherFileName:s.originalname,voucherFileType:s.mimetype,extractedAmount:m.extractedAmount,extractedDate:m.extractedDate,extractedBank:m.extractedBank,extractedReference:m.extractedReference,extractedCurrency:m.extractedCurrency,extractedOriginAccount:m.extractedOriginAccount,extractedDestinationAccount:m.extractedDestinationAccount,extractedTrackingKey:m.extractedTrackingKey,extractedBeneficiaryName:m.extractedBeneficiaryName,ocrConfidence:m.ocrConfidence,notify:I.notify||!1,emailTo:I.emailTo||[],emailCc:I.emailCc||[],emailMessage:I.emailMessage||null,notes:I.notes||null,uploadedBy:t.id},Ie=await x.createPaymentVoucher(be),oe=w,Pe=null,_e=null;try{if(I.scheduledPaymentId&&N){let F=N;F&&(Math.abs((F.amount-(m.extractedAmount||0))/F.amount)<=.01?(oe="cerrado",Pe=F.id,console.log(`\u{1F517} [Automation] Vinculado con pago programado ${F.id}`)):m.extractedAmount&&m.extractedAmount<F.amount?(oe="pendiente_complemento",console.log("\u26A0\uFE0F [Automation] Pago parcial detectado")):(oe="pendiente_asociacion",console.log("\u2753 [Automation] Monto no coincide, requiere asociaci\xF3n")))}else m.extractedAmount&&m.extractedReference&&(oe="pendiente_asociacion");if(E?.requiresPaymentComplement&&oe!=="cerrado"&&oe==="validado"&&(oe="pendiente_complemento"),oe!==w&&(await x.updatePaymentVoucher(Ie.id,{status:oe,linkedInvoiceId:Pe,linkedInvoiceUuid:_e}),Ie.status=oe),I.notify&&(I.emailTo?.length||E?.email)){let{emailService:F}=await Promise.resolve().then(()=>(qt(),Kr)),re=await import("fs"),De=I.emailTo?.length?I.emailTo:E?.email?[E.email]:[];if(De.length>0)try{if(!I.payerCompanyId){console.warn("\u26A0\uFE0F [Email] PayerCompanyId no disponible, usando nombre gen\xE9rico");return}let Ue=I.payerCompanyId,Je=(await x.getCompany(Ue))?.name||"Empresa",gt=`Comprobante de pago \u2013 ${Je} \u2013 ${m.extractedCurrency||"MXN"} ${m.extractedAmount?.toLocaleString("es-MX")||"N/A"}`,Ye=`
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                  <h2 style="color: #2563eb; border-bottom: 3px solid #2563eb; padding-bottom: 10px;">
                    Comprobante de Pago
                  </h2>
                  
                  <div style="background-color: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <p style="margin: 0; font-size: 16px;"><strong>Estimado/a ${E?.name||"Cliente"},</strong></p>
                    <p style="margin: 10px 0; font-size: 14px;">
                      Se ha registrado el siguiente comprobante de pago:
                    </p>
                  </div>

                  <div style="background-color: #eff6ff; padding: 15px; border-radius: 8px; border-left: 4px solid #2563eb; margin: 20px 0;">
                    <p style="margin: 5px 0;"><strong>Empresa Pagadora:</strong> ${Je}</p>
                    ${m.extractedAmount?`<p style="margin: 5px 0;"><strong>Monto:</strong> ${m.extractedCurrency||"MXN"} $${m.extractedAmount.toLocaleString("es-MX")}</p>`:""}
                    ${m.extractedDate?`<p style="margin: 5px 0;"><strong>Fecha:</strong> ${new Date(m.extractedDate).toLocaleDateString("es-MX")}</p>`:""}
                    ${m.extractedBank?`<p style="margin: 5px 0;"><strong>Banco:</strong> ${m.extractedBank}</p>`:""}
                    ${m.extractedReference?`<p style="margin: 5px 0;"><strong>Referencia:</strong> ${m.extractedReference}</p>`:""}
                    ${m.extractedTrackingKey?`<p style="margin: 5px 0;"><strong>Clave de Rastreo:</strong> ${m.extractedTrackingKey}</p>`:""}
                  </div>

                  ${I.emailMessage?`<div style="background-color: #fef3c7; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <p style="margin: 0; font-size: 14px;"><strong>Mensaje:</strong></p>
                    <p style="margin: 5px 0; font-size: 14px;">${I.emailMessage}</p>
                  </div>`:""}

                  <p style="margin-top: 20px; font-size: 14px;">
                    El comprobante se encuentra adjunto a este correo.
                  </p>

                  <p style="margin-top: 20px; font-size: 14px;">
                    Saludos cordiales,<br>
                    <strong>Lolita</strong><br>
                    Equipo de Tesorer\xEDa - Econova
                  </p>
                </div>
              `,At=re.readFileSync(G),yr={filename:s.originalname,content:At,type:s.mimetype},Ee=await F.sendEmail({to:De[0],subject:gt,html:Ye},"treasury");if(Ee.success||Ee.error){let{db:Nt}=await Promise.resolve().then(()=>(le(),Ke)),{emailOutbox:yt}=await Promise.resolve().then(()=>(ie(),Ne));await Nt.insert(yt).values({voucherId:Ie.id,emailTo:De,emailCc:I.emailCc||[],subject:gt,htmlContent:Ye,status:Ee.success?"sent":"failed",messageId:Ee.messageId||null,errorMessage:Ee.error||null,sentAt:Ee.success?new Date:null}),console.log(`\u{1F4E7} [Email] ${Ee.success?"Enviado":"Error"}: ${De[0]}`)}}catch(Ue){console.error("\u{1F4E7} [Email] Error enviando correo:",Ue)}}console.log(`\u{1F916} [Automation] Flujo autom\xE1tico completado: ${oe}`)}catch(F){console.error("\u{1F916} [Automation] Error en flujo autom\xE1tico:",F)}console.log(`\u2705 [Upload] Comprobante creado con ID: ${Ie.id}, estado: ${Ie.status}`),n.status(201).json({voucher:Ie,analysis:m,autoStatus:w,requiresComplement:E?.requiresPaymentComplement||!1,scheduledPayment:N||null,documentType:m.documentType})}catch(t){if(console.error("\u274C [Upload] Error completo:",t),console.error("\u274C [Upload] Stack trace:",t instanceof Error?t.stack:"No stack available"),t instanceof q.ZodError)return console.error("\u274C [Upload] Error de validaci\xF3n Zod:",t.errors),n.status(400).json({error:"Validaci\xF3n fallida",details:t.errors.map(s=>`${s.path.join(".")}: ${s.message}`).join(", ")});if(t instanceof Error){if(console.error("\u274C [Upload] Error message:",t.message),t.message.includes("No se subi\xF3")||t.message.includes("archivo"))return n.status(400).json({error:"Error al procesar archivo",details:t.message});if(t.message.includes("PayerCompanyId")||t.message.includes("empresa"))return n.status(400).json({error:"Datos incompletos",details:t.message})}n.status(500).json({error:"Error al subir comprobante",details:t instanceof Error?t.message:"Error desconocido"})}}),a.put("/api/payment-vouchers/:id/status",$,async(i,n)=>{try{let t=parseInt(i.params.id),d=q.object({status:q.enum(["pendiente_validacion","validado","pendiente_asociacion","pendiente_complemento","complemento_recibido","cerrado","cierre_contable"])}).parse(i.body),u=await x.updatePaymentVoucherStatus(t,d.status);if(!u)return n.status(404).json({error:"Payment voucher not found"});n.json(u)}catch(t){if(console.error("Error updating payment voucher status:",t),t instanceof q.ZodError)return n.status(400).json({error:"Validaci\xF3n fallida",details:t.errors});n.status(500).json({error:"Failed to update payment voucher status"})}}),a.put("/api/payment-vouchers/:id",$,async(i,n)=>{try{let t=parseInt(i.params.id),d=q.object({invoiceFileUrl:q.string().optional(),invoiceFileName:q.string().optional(),invoiceFileType:q.string().optional(),complementFileUrl:q.string().optional(),complementFileName:q.string().optional(),complementFileType:q.string().optional(),notes:q.string().optional()}).parse(i.body);if(Object.keys(d).length===0)return n.status(400).json({error:"No fields to update"});let u=await x.updatePaymentVoucher(t,d);if(!u)return n.status(404).json({error:"Payment voucher not found"});n.json(u)}catch(t){if(console.error("Error updating payment voucher:",t),t instanceof q.ZodError)return n.status(400).json({error:"Validaci\xF3n fallida",details:t.errors});n.status(500).json({error:"Failed to update payment voucher"})}}),a.get("/api/fx/source-series",$,async(i,n)=>{try{let t=i.query.source||"MONEX",s=parseInt(i.query.days)||30,d=await Or(t,s);n.json(d)}catch(t){console.error("Error fetching source series:",t),n.status(500).json({error:"Failed to fetch source series"})}}),a.get("/api/fx/compare",$,async(i,n)=>{try{let t=parseInt(i.query.days)||30,s=parseFloat(i.query.usd_monthly)||25e3,d=await Ur(t,s);n.json(d)}catch(t){console.error("Error fetching comparison:",t),n.status(500).json({error:"Failed to fetch comparison"})}}),a.post("/api/fx/import-historical",$,async(i,n)=>{try{let{importBanxicoHistoricalData:t}=await Promise.resolve().then(()=>(sr(),ar)),{startDate:s,endDate:d}=i.body;if(!s||!d)return n.status(400).json({error:"startDate and endDate are required"});let u=await t(s,d);n.json(u)}catch(t){console.error("Error importing historical data:",t),n.status(500).json({error:"Failed to import historical data"})}}),a.post("/api/admin/seed-fx-rates",$,async(i,n)=>{try{if(V(i).role!=="admin")return n.status(403).json({error:"Solo administradores pueden ejecutar este endpoint"});let{startDate:s,endDate:d}=i.body,u=s||"2025-09-01",g=d||"2025-10-31";console.log(`\u{1F4E5} Importando tipos de cambio de Banxico: ${u} a ${g}`);let{importBanxicoHistoricalData:y}=await Promise.resolve().then(()=>(sr(),ar)),m=await y(u,g);console.log(`\u2705 Importaci\xF3n completada: ${m.imported} registros nuevos`),n.json({message:`Importados ${m.imported} tipos de cambio (${m.skipped} ya exist\xEDan)`,...m})}catch(t){console.error("\u274C Error al importar tipos de cambio:",t),n.status(500).json({error:"Error al importar tipos de cambio",details:t instanceof Error?t.message:String(t)})}});let T=ke({storage:ke.diskStorage({destination:(i,n,t)=>{t(null,"uploads/idrall/")},filename:(i,n,t)=>{let s=Date.now()+"-"+Math.round(Math.random()*1e9);t(null,`idrall-${s}-${n.originalname}`)}}),fileFilter:(i,n,t)=>{["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","text/csv"].includes(n.mimetype)||n.originalname.endsWith(".xlsx")||n.originalname.endsWith(".xls")?t(null,!0):t(new Error("Solo se permiten archivos Excel (.xlsx, .xls) o CSV"))},limits:{fileSize:10*1024*1024}});if(a.post("/api/idrall/upload",$,T.single("excel"),async(i,n)=>{try{let t=V(i),s=i.file;if(!s)return n.status(400).json({error:"No se subi\xF3 ning\xFAn archivo Excel"});let u=q.object({companyId:q.string().transform(A=>{let w=Number(A);if(!w||w<=0)throw new Error("CompanyId inv\xE1lido");return w}),createAsPending:q.string().optional().transform(A=>A==="true")}).parse(i.body);console.log(`\u{1F4CA} [IdrallUpload] Procesando Excel: ${s.originalname} para empresa ${u.companyId}`);let g=await import("fs"),m=(await import("path")).join(process.cwd(),"uploads","idrall");g.existsSync(m)||g.mkdirSync(m,{recursive:!0});let{IdrallParser:f}=await Promise.resolve().then(()=>(mn(),un)),I=await f.parseExcel(s.path);if(!I.success)return n.status(400).json({error:"Error procesando archivo Excel",details:I.errors,totalRows:I.totalRows});console.log(`\u2705 [IdrallUpload] Excel procesado: ${I.payments.length} pagos v\xE1lidos`);let{storage:E}=await Promise.resolve().then(()=>(et(),Cr)),N=[],C=[];for(let A of I.payments)try{let w=await f.findMatchingClient(A,u.companyId),S=null,D=A.proveedor||A.cliente||"Proveedor IDRALL";w.found?(S=w.client.id,D=w.client.name,console.log(`\u{1F517} [IdrallUpload] Cliente encontrado: ${D} (${w.matchType})`)):console.log(`\u26A0\uFE0F [IdrallUpload] Cliente no encontrado para: ${D}`);let M={companyId:u.companyId,clientId:S,clientName:D,amount:A.monto||A.importe||0,currency:A.moneda||"MXN",description:A.concepto||A.descripcion||"Pago IDRALL",dueDate:A.fecha_pago||A.fecha?new Date(A.fecha_pago||A.fecha||new Date):new Date,reference:A.referencia||A.factura||A.folio||"",bank:A.banco||"",account:A.cuenta||"",status:u.createAsPending?"pending":"scheduled",source:"idrall",originalData:A,createdBy:t.id},O=await E.createScheduledPayment(M);N.push(O)}catch(w){let S=`Error creando pago para ${A.proveedor||A.cliente}: ${w instanceof Error?w.message:"Error desconocido"}`;C.push(S),console.error(`\u274C [IdrallUpload] ${S}`)}try{g.unlinkSync(s.path)}catch(A){console.warn("\u26A0\uFE0F [IdrallUpload] Error limpiando archivo temporal:",A)}console.log(`\u{1F389} [IdrallUpload] Procesamiento completado: ${N.length} pagos creados, ${C.length} errores`),n.json({success:!0,message:"Excel procesado exitosamente",summary:{totalRows:I.totalRows,validPayments:I.payments.length,createdPayments:N.length,errors:C.length},createdPayments:N.map(A=>({id:A.id,clientName:A.clientName,amount:A.amount,dueDate:A.dueDate,status:A.status})),errors:C})}catch(t){if(console.error("\u274C [IdrallUpload] Error procesando Excel:",t),t instanceof q.ZodError)return n.status(400).json({error:"Validaci\xF3n fallida",details:t.errors});n.status(500).json({error:"Error procesando archivo Excel de IDRALL",details:t instanceof Error?t.message:String(t)})}}),a.post("/api/test-email",$,async(i,n)=>{try{let{to:t,department:s="treasury",useTestEmail:d=!0}=i.body;if(!t)return n.status(400).json({error:"Email destination required"});let u=d?"onboarding@resend.dev":void 0;console.log(`[TEST EMAIL] Enviando prueba a ${t} desde ${u||"dominio configurado"}`);let g=await Et.sendEmail({to:t,from:u,subject:"Prueba de Email - Sistema Econova",html:`
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h2 style="color: #2563eb;">\u2705 Email de Prueba Exitoso</h2>
            <p>Este es un email de prueba del sistema de Econova.</p>
            <div style="background-color: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <p><strong>Departamento:</strong> ${s}</p>
              <p><strong>Remitente:</strong> ${u||"Dominio configurado"}</p>
              <p><strong>Timestamp:</strong> ${new Date().toLocaleString("es-MX")}</p>
              <p><strong>Estado:</strong> \u2705 Funcionando correctamente</p>
            </div>
            <p>El sistema de emails est\xE1 configurado y funcionando.</p>
            <p>Saludos,<br>Equipo de Desarrollo - Econova</p>
          </div>
        `},s);g.success||console.error("[TEST EMAIL] Error:",g.error),n.json({success:g.success,message:g.success?"Email enviado exitosamente. Revisa tu bandeja de entrada (y spam).":`Error enviando email: ${g.error}`,messageId:g.messageId,error:g.error,from:u||"dominio configurado"})}catch(t){console.error("[TEST EMAIL] Error en test de email:",t),n.status(500).json({success:!1,error:`Error interno del servidor: ${t?.message||String(t)}`})}}),k.info("\u2705 All routes have been configured successfully"),process.env.NODE_ENV==="development"){let n=(a._router?.stack||[]).filter(s=>s.route&&s.route.path&&s.route.path.includes("exchange-rates"));k.debug(`[Routes] Found ${n.length} exchange-rates routes registered`,{count:n.length,routes:n.map(s=>({path:s.route.path,methods:Object.keys(s.route.methods).filter(d=>d!=="_all")}))});let t=n.filter(s=>s.route.path.includes("/api/api/"));t.length>0&&k.warn(`\u26A0\uFE0F Found ${t.length} route(s) with double-prefixed path`,{routes:t.map(s=>s.route.path)})}return a}or();function hn(a,r,e){try{let c=a.user;if(!c)return e();let l=a.query.companyId?parseInt(a.query.companyId):a.body?.companyId;l&&c.companyId&&l!==c.companyId&&(console.log("\u{1F6A8} [SECURITY ALERT] Cross-company access attempt:"),console.log(`   User: ${c.name} (ID: ${c.id}, Company: ${c.companyId})`),console.log(`   Requested Company: ${l}`),console.log(`   Endpoint: ${a.method} ${a.path}`),console.log(`   IP: ${a.ip}`),console.log(`   User-Agent: ${a.get("User-Agent")}`),console.log(`   Timestamp: ${new Date().toISOString()}`),console.log("   ---")),c.role==="admin"&&l&&console.log(`\u{1F7E1} [ADMIN ACCESS] Admin ${c.name} accessing company ${l}`),l&&c.companyId===l&&console.log(`\u{1F7E2} [NORMAL ACCESS] User ${c.name} accessing own company data`),e()}catch(o){console.error("[SECURITY MONITOR ERROR]:",o),e()}}function fn(a,r,e){let o=a.ip,c=a.body?.email;console.log(`\u{1F510} [LOGIN ATTEMPT] IP: ${o}, Email: ${c}, Time: ${new Date().toISOString()}`),e()}function vn(a,r,e){let o=a.user,c=a.file;c&&console.log(`\u{1F4C1} [FILE UPLOAD] User: ${o?.name}, File: ${c.originalname}, Size: ${c.size} bytes`),e()}function bn(a,r,e){let o=a.user,c=a.path;["/api/users","/api/companies","/api/kpis","/api/shipments","/api/clients"].some(p=>c.includes(p))&&console.log(`\u{1F50D} [API ACCESS] User: ${o?.name}, Endpoint: ${c}, Method: ${a.method}`),e()}le();var ut={debug:(a,r)=>{try{let{logger:e}=(rt(),$t(It));e.debug(a,r)}catch{console.log(`[DEBUG] ${a}`,r||"")}},error:(a,r)=>{try{let{logger:e}=(rt(),$t(It));e.error(a,r)}catch{console.error(`[ERROR] ${a}`,r||"")}},info:(a,r)=>{try{let{logger:e}=(rt(),$t(It));e.info(a,r)}catch{console.log(`[INFO] ${a}`,r||"")}}};async function In(a,r){let e=Date.now(),o={status:"healthy",timestamp:new Date().toISOString(),services:{database:"down",openai:"not_configured",sendgrid:"not_configured"},metrics:{uptime:process.uptime(),memoryUsage:process.memoryUsage(),version:process.env.npm_package_version||"1.0.0"}};try{try{let b=P.execute("SELECT 1"),T=new Promise((i,n)=>setTimeout(()=>n(new Error("Database check timeout")),2e3));await Promise.race([b,T]),o.services.database="up",ut.debug("Database health check passed")}catch(b){o.services.database="down",o.status==="healthy"&&(o.status="degraded"),ut.error("Database health check failed",{error:b instanceof Error?b.message:String(b)})}process.env.OPENAI_API_KEY&&process.env.OPENAI_API_KEY!=="your-openai-api-key-here"?o.services.openai="up":(o.services.openai="not_configured",o.status==="healthy"&&(o.status="degraded"));let c=process.env.SENDGRID_API_KEY&&process.env.SENDGRID_API_KEY!=="your-sendgrid-api-key",l=process.env.RESEND_API_KEY&&process.env.RESEND_API_KEY!=="your-resend-api-key";c||l?o.services.sendgrid="up":(o.services.sendgrid="not_configured",o.status==="healthy"&&(o.status="degraded"));let p=Date.now()-e;ut.info("Health check completed",{status:o.status,responseTime:`${p}ms`,services:o.services}),r.status(200).json(o)}catch(c){ut.error("Health check failed",{error:c instanceof Error?c.message:String(c)}),o.status="unhealthy",r.status(200).json(o)}}async function En(a,r){try{let e=P.execute("SELECT 1"),o=new Promise((c,l)=>setTimeout(()=>l(new Error("Database readiness check timeout")),2e3));await Promise.race([e,o]),r.status(200).json({status:"ready"})}catch(e){ut.error("Readiness check failed",{error:e instanceof Error?e.message:String(e)}),r.status(200).json({status:"not_ready",message:e instanceof Error?e.message:String(e)})}}async function Sn(a,r){r.status(200).json({status:"alive",timestamp:new Date().toISOString(),uptime:process.uptime()})}import Ve from"path";import pt from"fs";import wn from"express-rate-limit";import*as ve from"@sentry/node";import ra from"helmet";process.env.SENTRY_DSN?(ve.init({dsn:process.env.SENTRY_DSN,environment:process.env.NODE_ENV||"development",tracesSampleRate:process.env.NODE_ENV==="production"?.1:1,replaysSessionSampleRate:process.env.NODE_ENV==="production"?.1:0,replaysOnErrorSampleRate:1,beforeSend(a,r){return r.request?.url?.includes("/health")?null:a},release:process.env.RAILWAY_GIT_COMMIT_SHA||"local",integrations:[new ve.Integrations.Http({tracing:!0})]}),console.log("\u2705 Sentry error tracking initialized")):console.log("\u26A0\uFE0F  Sentry DSN not configured - error tracking disabled");function na(){try{let a=process.env.NODE_ENV||"undefined",r=process.env.NODE_ENV==="production"?"production":"development";console.log(`
\u{1F50D} === BOOT DIAGNOSTICS ===`),console.log(`\u{1F4CA} NODE_ENV: ${a}`),console.log(`\u{1F4CA} Express env will be: ${r}`),console.log(`\u{1F4CA} Current working directory: ${process.cwd()}`);let e=import.meta.url,o=Ve.dirname(ea(e));console.log(`\u{1F4CA} Script directory: ${o}`);let c=Ve.resolve(o,"index.js"),l=Ve.resolve(o,"public"),p=Ve.resolve(l,"index.html"),h=Ve.resolve(o,"..","server","dist","index.js"),b=Ve.resolve(o,"..","dist","public"),T=Ve.resolve(b,"index.html");console.log(`\u{1F4C2} Expected dist/index.js: ${c}`),console.log(`\u{1F4C2} Expected dist/public: ${l}`),console.log(`\u{1F4C2} Expected dist/public/index.html: ${p}`),console.log(`\u2705 dist/index.js exists: ${pt.existsSync(c)} (expected for production)`),console.log(`\u2705 dist/public exists: ${pt.existsSync(l)} (expected for production)`),console.log(`\u2705 dist/public/index.html exists: ${pt.existsSync(p)} (expected for production)`),console.log("\u{1F4E6} Build artifacts in current locations:"),console.log(`   backend (server/dist/index.js): ${pt.existsSync(h)}`),console.log(`   frontend (dist/public/index.html): ${pt.existsSync(T)}`);let i=["DATABASE_URL","JWT_SECRET","SENDGRID_API_KEY","REPL_ID","REPL_SLUG"];console.log("\u{1F512} Environment variables status:"),i.forEach(n=>{let t=!!process.env[n],s=process.env[n]?.length||0;console.log(`   ${n}: ${t?"\u2705 SET":"\u274C MISSING"} ${t?`(${s} chars)`:""}`)}),console.log(`=== END BOOT DIAGNOSTICS ===
`)}catch(a){console.error("\u26A0\uFE0F Error in boot diagnostics:",a),console.log(`Continuing server startup...
`)}}try{na()}catch(a){console.error("\u26A0\uFE0F Boot diagnostics failed (non-critical):",a)}var B=Tt(),Pn=process.env.NODE_ENV||"development";B.set("env",Pn);Pn==="production"&&B.set("trust proxy",1);B.get("/health",(a,r)=>{r.status(200).json({status:"healthy",service:"kpis-grupo-orsega"})});B.head("/health",(a,r)=>{r.status(200).end()});B.get("/healthz",(a,r)=>{r.status(200).json({status:"ok"})});B.head("/healthz",(a,r)=>{r.status(200).end()});B.use(ta());B.use((a,r,e)=>{if((a.path.includes("/upload")||a.path.includes("/payment-vouchers"))&&(console.log("\u{1F50D} [Early] Petici\xF3n recibida:",a.method,a.path),console.log("\u{1F50D} [Early] Content-Type:",a.headers["content-type"]),console.log("\u{1F50D} [Early] Content-Length:",a.headers["content-length"]),console.log("\u{1F50D} [Early] Authorization header presente:",!!a.headers.authorization),console.log("\u{1F50D} [Early] Authorization header:",a.headers.authorization?`${a.headers.authorization.substring(0,30)}...`:"null"),console.log("\u{1F50D} [Early] Todos los headers:",Object.keys(a.headers))),(a.headers["content-type"]||"").includes("multipart/form-data"))return console.log("\u23ED\uFE0F [Early] Saltando body parsers para multipart/form-data"),e();e()});B.use(Tt.json());B.use(Tt.urlencoded({extended:!1}));B.use(ra({contentSecurityPolicy:{directives:{defaultSrc:["'self'"],scriptSrc:["'self'","'unsafe-inline'","'unsafe-eval'"],styleSrc:["'self'","'unsafe-inline'"],imgSrc:["'self'","data:","https:","blob:"],connectSrc:["'self'"],fontSrc:["'self'"],objectSrc:["'none'"],mediaSrc:["'self'","blob:"],frameSrc:["'self'","blob:"]}},crossOriginEmbedderPolicy:!1,crossOriginOpenerPolicy:{policy:"same-origin-allow-popups"},hsts:{maxAge:31536e3,includeSubDomains:!0,preload:!0}}));var xn={windowMs:15*60*1e3,standardHeaders:!0,legacyHeaders:!1,handler:(a,r)=>{r.status(429).json({message:"Demasiadas solicitudes. Intenta nuevamente m\xE1s tarde.",retryAfter:900})},skip:a=>a.path==="/health"||a.path==="/healthz"||a.path==="/api/health"},oa=process.env.NODE_ENV==="production"?wn({...xn,max:1e3}):wn({...xn,max:5e3});B.use("/api",oa);B.use("/api",hn);B.use("/api/login",fn);B.use("/api/upload",vn);B.use("/api",bn);B.use(Tt.static(Ve.join(process.cwd(),"public")));function Tn(a){if(!a||typeof a!="object")return a;let r=["password","token","authorization","apiKey","secret","jwt"],e=Array.isArray(a)?[]:{};for(let[o,c]of Object.entries(a))r.some(l=>o.toLowerCase().includes(l))?e[o]="[REDACTED]":typeof c=="object"&&c!==null?e[o]=Tn(c):e[o]=c;return e}B.use((a,r,e)=>{if(a.path==="/health"||a.path==="/healthz")return e();let o=Date.now(),c=a.path,l,p=r.json;r.json=function(h,...b){return l=h,p.apply(r,[h,...b])},r.on("finish",()=>{let h=Date.now()-o;if(c.startsWith("/api")){let b=`${a.method} ${c} ${r.statusCode} in ${h}ms`;if(l){let T=Tn(l);b+=` :: ${JSON.stringify(T)}`}b.length>80&&(b=b.slice(0,79)+"\u2026"),console.log(b)}}),e()});process.env.SENTRY_DSN&&(B.use(ve.Handlers.requestHandler()),B.use(ve.Handlers.tracingHandler()));var gr=Zo(B),Ce=process.env.PORT?parseInt(process.env.PORT,10):8080;(!Ce||isNaN(Ce))&&(console.error("\u274C ERROR: Invalid PORT value:",process.env.PORT),process.exit(1));try{gr.listen(Ce,"0.0.0.0",()=>{console.log(`\u2705 Server listening on port ${Ce}`),console.log("\u{1F310} Accessible on:"),console.log(`   - http://localhost:${Ce}`),console.log(`   - http://127.0.0.1:${Ce}`),console.log(`   - http://0.0.0.0:${Ce}`),console.log(`\u{1F4CA} NODE_ENV: ${process.env.NODE_ENV||"not set"}`),console.log(`\u{1F5C4}\uFE0F DATABASE_URL exists: ${!!process.env.DATABASE_URL}`),console.log(`\u{1F511} JWT_SECRET exists: ${!!process.env.JWT_SECRET}`),console.log(`\u{1F3E5} Healthcheck available at: http://localhost:${Ce}/health`),console.log(`\u2705 Server ready! Open http://localhost:${Ce} in your browser`)}),gr.on("error",a=>{a.code==="EADDRINUSE"?(console.error(`\u274C ERROR: Port ${Ce} is already in use`),process.exit(1)):console.error("\u274C Server error:",a)})}catch(a){console.error("\u274C CRITICAL: Failed to start server:",a),process.exit(1)}process.env.SENTRY_DSN&&B.use(ve.Handlers.errorHandler());B.use((a,r,e,o)=>{process.env.SENTRY_DSN&&a&&ve.captureException(a);let c=a.status||a.statusCode||500,l=a.message||"Internal Server Error";r.path!=="/health"&&r.path!=="/healthz"&&(console.error(`[Server Error ${c}]:`,a.message),c>=500&&console.error("Full error stack:",a.stack)),e.status(c).json({message:l})});process.on("unhandledRejection",(a,r)=>{console.error("\u274C Unhandled Rejection at:",r,"reason:",a),process.env.SENTRY_DSN&&ve.captureException(a)});process.on("uncaughtException",a=>{console.error("\u274C Uncaught Exception:",a),process.env.SENTRY_DSN&&ve.captureException(a),(a.message.includes("EADDRINUSE")||a.message.includes("PORT"))&&process.exit(1)});(async()=>{try{console.log("\u{1F504} Starting async initialization..."),B.get("/api/health",In),B.get("/api/health/ready",En),B.get("/api/health/live",Sn),console.log("\u2705 Health check endpoints registered");try{yn(B),console.log("\u2705 API routes registered")}catch(r){console.error("\u26A0\uFE0F Warning: Error registering routes (server still running):",r),console.error("\u26A0\uFE0F Error details:",r)}let a=B.get("env");if(console.log(`\u{1F680} Express environment detected: ${a}`),a==="development"){console.log("\u{1F527} Setting up Vite middleware for development...");try{let{setupVite:r}=await Promise.resolve().then(()=>(pr(),mr));await r(B,gr),console.log("\u2705 Vite middleware configured")}catch(r){console.error("\u274C Failed to load Vite middleware (non-critical):",r)}}else{console.log("\u{1F4E6} Setting up static file serving for production...");try{let{serveStatic:r}=await Promise.resolve().then(()=>(pr(),mr));r(B),console.log("\u2705 Static file serving configured")}catch(r){console.error("\u26A0\uFE0F Warning: Failed to setup static files (non-critical):",r)}}console.log("\u23F8\uFE0F  Auto-cierre autom\xE1tico DESACTIVADO - cierre manual requerido"),console.log("\u2705 Sistema configurado para cierre manual");try{nr(),console.log("\u2705 DOF scheduler initialized")}catch(r){console.error("\u26A0\uFE0F Warning: Failed to initialize DOF scheduler (non-critical):",r)}B.use("/api/*",(r,e)=>{console.log(`\u274C [404] API route not found: ${r.method} ${r.originalUrl}`),e.status(404).json({error:"API route not found",path:r.originalUrl,method:r.method})}),console.log("\u2705 All server initialization completed")}catch(a){console.error("\u26A0\uFE0F CRITICAL: Error during async initialization:",a),console.error("\u26A0\uFE0F But server is still running and /health should work")}})();
