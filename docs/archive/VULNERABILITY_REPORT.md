# ğŸ” REPORTE DE VULNERABILIDADES
## KPIs Grupo Orsega - AnÃ¡lisis Detallado

**Fecha:** 2025-01-24  
**MetodologÃ­a:** OWASP Top 10 2021, CWE Top 25  
**Severidad:** Medio-Alto

---

## ğŸ“Š RESUMEN GENERAL

**Total Vulnerabilidades:** 7  
- ğŸ”´ CrÃ­ticas: 0
- ğŸŸ  Altas: 2
- ğŸŸ¡ Medias: 4
- ğŸŸ¢ Bajas: 1

**Score de Seguridad:** 15/20 âš ï¸  
**Estado General:** âœ… Aceptable para producciÃ³n

---

## ğŸ”´ CRÃTICAS: 0

**âœ… No se identificaron vulnerabilidades crÃ­ticas**

---

## ğŸŸ  ALTAS: 2

### VUL-001: ValidaciÃ³n Multi-Tenant Insuficiente

**Severidad:** ğŸŸ  ALTA  
**CVSS:** 6.5 (Medium-High)  
**OWASP:** A01:2021 â€“ Broken Access Control

**DescripciÃ³n:**
Los endpoints de creaciÃ³n y modificaciÃ³n de recursos no validan correctamente que el usuario pertenezca a la empresa del recurso que estÃ¡ modificando.

**Evidencia:**
```typescript
// server/routes.ts:2516-2552
// GET /api/clients-db
app.get("/api/clients-db", jwtAuthMiddleware, async (req, res) => {
  // âš ï¸ Sin validaciÃ³n de companyId del usuario
  const result = await sql(`SELECT * FROM clients ...`);
  res.json(result);
});
```

**Impacto:**
- Usuario de Dura (companyId=1) puede crear clientes para Orsega (companyId=2)
- Usuario de Ventas puede modificar KPIs de LogÃ­stica
- Fuga de datos entre empresas

**Explotabilidad:**
1. Usuario autenticado cambia `companyId` en request body
2. Servidor acepta sin validar `user.companyId === resource.companyId`
3. Acceso no autorizado a datos de otra empresa

**Referencia:**
- Documento: `SECURITY_ANALYSIS_REVISED.md` lÃ­nea 99-124
- CWE-639: Authorization Bypass Through User-Controlled Key

**RecomendaciÃ³n:**
```typescript
// Middleware de validaciÃ³n
export function validateTenantAccess(
  req: AuthRequest,
  resourceCompanyId: number
): void {
  const user = getAuthUser(req);
  
  // Admin puede acceder a todo
  if (user.role === 'admin') return;
  
  // Usuario solo puede acceder a su empresa
  if (user.companyId !== resourceCompanyId) {
    throw new Error('Forbidden: Access denied');
  }
}

// Aplicar en endpoints
app.post("/api/clients", jwtAuthMiddleware, async (req, res) => {
  const data = insertClientSchema.parse(req.body);
  validateTenantAccess(req, data.companyId); // â† AGREGAR
  const client = await storage.createClient(data);
  res.json(client);
});
```

**Prioridad:** ğŸ”´ Implementar en semana 1  
**Esfuerzo:** 4-8 horas  
**Endpoints afectados:** ~15

---

### VUL-002: Falta de Rate Limiting Global

**Severidad:** ğŸŸ  ALTA  
**CVSS:** 5.3 (Medium)  
**OWASP:** A07:2021 â€“ Identification and Authentication Failures

**DescripciÃ³n:**
Aunque existe rate limiting para login y registro, no hay protecciÃ³n global contra ataques DDOS o abuso de API en otros endpoints.

**Evidencia:**
```typescript
// server/routes.ts:161-185
const loginLimiter = rateLimit({ windowMs: 15 * 60 * 1000, max: 5 });
// âœ… Aplicado solo a /api/login

// âŒ Endpoints sin rate limiting:
// - GET /api/users
// - GET /api/kpis
// - POST /api/kpi-values
// - GET /api/shipments
// - Todos los endpoints pÃºblicos
```

**Impacto:**
- DDOS attacks posibles
- Abuso de API resources
- Costos elevados de OpenAI/neon
- DegradaciÃ³n de servicio

**Explotabilidad:**
1. Atacante hace 1000+ requests/min a `/api/kpis`
2. Servidor no tiene lÃ­mite de requests
3. Database y recursos se saturan
4. Servicio no disponible (DoS)

**Referencia:**
- CWE-770: Allocation of Resources Without Limits or Throttling
- OWASP API Security Top 10: API8:2019 â€“ Injection

**RecomendaciÃ³n:**
```typescript
// Rate limiter global
const globalLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutos
  max: 100, // 100 requests por 15 min por IP
  standardHeaders: true,
  legacyHeaders: false,
  handler: (req, res) => {
    res.status(429).json({ 
      message: 'Too many requests, please try again later',
      retryAfter: 900
    });
  }
});

// Aplicar globalmente
app.use('/api', globalLimiter);

// Rate limiter mÃ¡s estricto para operaciones costosas
const expensiveOperationLimiter = rateLimit({
  windowMs: 60 * 60 * 1000, // 1 hora
  max: 10, // Solo 10 por hora
});

app.post('/api/payment-vouchers/upload', 
  expensiveOperationLimiter, 
  uploadHandler
);
```

**Prioridad:** ğŸŸ  Implementar en semana 1  
**Esfuerzo:** 1-2 horas  
**Impacto:** ReducciÃ³n significativa de riesgo DDOS

---

## ğŸŸ¡ MEDIAS: 4

### VUL-003: Endpoints de DiagnÃ³stico Expuestos

**Severidad:** ğŸŸ¡ MEDIA  
**CVSS:** 4.3 (Medium)  
**OWASP:** A05:2021 â€“ Security Misconfiguration

**DescripciÃ³n:**
Endpoints como `/env-check` exponen informaciÃ³n sensible del sistema aunque estÃ¡n protegidos con admin auth.

**Evidencia:**
```typescript
// server/routes.ts:216-287
app.get('/env-check', jwtAuthMiddleware, jwtAdminMiddleware, (req, res) => {
  // âš ï¸ Expone paths, env vars status, file checks
  const diagnostics = {
    env_variables: { /* status de secrets */ },
    paths: { /* estructura de archivos */ },
    file_checks: { /* existencia de archivos */ }
  };
  res.json(diagnostics);
});
```

**Impacto:**
- Information disclosure si admin account comprometido
- Reconnaissance para ataques
- IdentificaciÃ³n de versiÃ³n y stack

**RecomendaciÃ³n:**
```typescript
// Solo en desarrollo
if (process.env.NODE_ENV !== 'production') {
  app.get('/env-check', jwtAuthMiddleware, jwtAdminMiddleware, (req, res) => {
    // ... diagnostics completos
  });
}

// VersiÃ³n mÃ­nima en producciÃ³n
app.get('/env-check', jwtAuthMiddleware, jwtAdminMiddleware, (req, res) => {
  res.json({ status: 'ok', timestamp: new Date().toISOString() });
});
```

**Prioridad:** ğŸŸ¡ Opcional  
**Esfuerzo:** 1 hora

---

### VUL-004: Falta de ValidaciÃ³n de Contenido de Archivos

**Severidad:** ğŸŸ¡ MEDIA  
**CVSS:** 4.3 (Medium)  
**OWASP:** A08:2021 â€“ Software and Data Integrity Failures

**DescripciÃ³n:**
Multer valida solo `mimetype` pero no el contenido real de los archivos subidos.

**Evidencia:**
```typescript
// server/routes.ts: (multer config no visible en muestra pero documentado)
const uploadLimiter = rateLimit({ ... });
const multerConfig = {
  fileFilter: (req, file, cb) => {
    // âš ï¸ Solo valida mimetype, no contenido
    const allowedTypes = ['image/png', 'image/jpeg', 'application/pdf'];
    if (allowedTypes.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new Error('Invalid file type'));
    }
  }
};
```

**Impacto:**
- Upload de archivos maliciosos disfrazados como PDF/PNG
- Malicious code execution si se procesa el archivo
- Storage poisoning

**RecomendaciÃ³n:**
```typescript
// Validar contenido real del archivo
import { fileTypeFromBuffer } from 'file-type';

const multerConfig = {
  fileFilter: async (req, file, cb) => {
    // Leer primeros bytes
    const buffer = fs.readFileSync(file.path);
    const fileType = await fileTypeFromBuffer(buffer);
    
    // Validar contenido real
    const allowedTypes = ['png', 'jpeg', 'pdf'];
    if (fileType && allowedTypes.includes(fileType.ext)) {
      cb(null, true);
    } else {
      fs.unlinkSync(file.path);
      cb(new Error('Invalid file content'));
    }
  }
};
```

**Prioridad:** ğŸŸ¡ Media  
**Esfuerzo:** 2-3 horas

---

### VUL-005: Registro PÃºblico Sin ValidaciÃ³n de Dominio

**Severidad:** ğŸŸ¡ MEDIA  
**CVSS:** 3.7 (Low-Medium)  
**OWASP:** A01:2021 â€“ Broken Access Control

**DescripciÃ³n:**
Si existe endpoint de registro pÃºblico, no valida que el email pertenezca al dominio corporativo de la empresa seleccionada.

**Evidencia:**
```typescript
// server/routes.ts (no visible en muestra)
// Documentado en SECURITY_ANALYSIS_REVISED.md lÃ­nea 140-173
app.post("/api/register", async (req, res) => {
  const companyId = Number(req.body.companyId);
  // âš ï¸ Sin validaciÃ³n de dominio
  await storage.createUser({...userData, companyId});
});
```

**Impacto:**
- Usuario malintencionado puede registrarse con cualquier companyId
- Email no corporativo usado
- Acceso no autorizado

**RecomendaciÃ³n:**
```typescript
const ALLOWED_DOMAINS = {
  1: ['duraint.com', 'dura.com'],
  2: ['orsega.com', 'grupoorsega.com']
};

app.post("/api/register", async (req, res) => {
  const { email, companyId } = req.body;
  
  // Validar dominio
  const domain = email.split('@')[1];
  if (!ALLOWED_DOMAINS[companyId]?.includes(domain)) {
    return res.status(403).json({ 
      message: 'Email must be from company domain' 
    });
  }
  
  await storage.createUser(userData);
});
```

**Prioridad:** ğŸŸ¢ Baja (si registro pÃºblico deshabilitado)  
**Esfuerzo:** 1 hora

---

### VUL-006: InicializaciÃ³n Temprana de Database Connections

**Severidad:** ğŸŸ¡ MEDIA  
**CVSS:** 2.0 (Low)  
**CWE:** Availability

**DescripciÃ³n:**
Las conexiones de base de datos se crean al importar los mÃ³dulos, bloqueando el startup si la DB no estÃ¡ disponible.

**Evidencia:**
```typescript
// server/db.ts:15-16
export const pool = new Pool({ connectionString: process.env.DATABASE_URL });
export const db = drizzle({ client: pool, schema });

// âš ï¸ Se ejecuta al importar el mÃ³dulo
// Si DB estÃ¡ down, servidor no inicia
```

**Impacto:**
- Servidor no inicia si DB temporalmente no disponible
- Healthcheck no responde durante DB outage
- Railway puede matar el servicio

**RecomendaciÃ³n:**
```typescript
// Lazy initialization
let dbInstance: ReturnType<typeof drizzle> | null = null;
let poolInstance: Pool | null = null;

export function getDb() {
  if (!dbInstance) {
    poolInstance = new Pool({ 
      connectionString: process.env.DATABASE_URL 
    });
    dbInstance = drizzle({ client: poolInstance, schema });
  }
  return dbInstance;
}

// Healthcheck no depende de DB
app.get("/health", (req, res) => {
  res.status(200).json({ status: "ok" });
});
```

**Prioridad:** ğŸŸ¡ Media  
**Esfuerzo:** 2-3 horas  
**Nota:** Healthcheck ya se moviÃ³ antes de DB init âœ…

---

## ğŸŸ¢ BAJAS: 1

### VUL-007: Falta de Content Security Policy Robusta

**Severidad:** ğŸŸ¢ BAJA  
**CVSS:** 1.5 (Low)  
**OWASP:** A03:2021 â€“ Injection

**DescripciÃ³n:**
CSP actual tiene `'unsafe-inline'` y `'unsafe-eval'` para Vite HMR, que reduce protecciÃ³n contra XSS.

**Evidencia:**
```typescript
// server/index.ts:172-193
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      scriptSrc: ["'self'", "'unsafe-inline'", "'unsafe-eval'"], 
      // âš ï¸ unsafe-inline y unsafe-eval
    }
  }
}));
```

**Impacto:**
- ReducciÃ³n de protecciÃ³n XSS
- MÃ¡s superficie de ataque

**RecomendaciÃ³n:**
```typescript
// En producciÃ³n, CSP mÃ¡s estricto
const cspConfig = process.env.NODE_ENV === 'production' 
  ? {
      directives: {
        defaultSrc: ["'self'"],
        scriptSrc: ["'self'"], // Sin unsafe-*
        styleSrc: ["'self'"],
        // ...
      }
    }
  : {
      directives: {
        // Permite unsafe-* solo en desarrollo
        scriptSrc: ["'self'", "'unsafe-inline'", "'unsafe-eval'"]
      }
    };

app.use(helmet({ contentSecurityPolicy: cspConfig }));
```

**Prioridad:** ğŸŸ¢ Baja  
**Esfuerzo:** 30 minutos

---

## ğŸ“‹ RESUMEN DE MITIGACIONES

### ImplementaciÃ³n Inmediata (Semana 1)

| VUL | DescripciÃ³n | Esfuerzo | Prioridad |
|-----|-------------|----------|-----------|
| VUL-001 | Multi-tenant validation | 4-8h | ğŸ”´ CrÃ­tica |
| VUL-002 | Rate limiting global | 1-2h | ğŸ”´ CrÃ­tica |

### ImplementaciÃ³n Corto Plazo (Semana 2-4)

| VUL | DescripciÃ³n | Esfuerzo | Prioridad |
|-----|-------------|----------|-----------|
| VUL-003 | Endpoints diagnÃ³stico | 1h | ğŸŸ¡ Media |
| VUL-004 | ValidaciÃ³n archivos | 2-3h | ğŸŸ¡ Media |
| VUL-006 | DB init lazy | 2-3h | ğŸŸ¡ Media |

### ImplementaciÃ³n Opcional

| VUL | DescripciÃ³n | Esfuerzo | Prioridad |
|-----|-------------|----------|-----------|
| VUL-005 | ValidaciÃ³n dominio | 1h | ğŸŸ¢ Baja |
| VUL-007 | CSP robusta | 30min | ğŸŸ¢ Baja |

---

## ğŸ¯ CALIFICACIÃ“N FINAL

**Total Score:** 15/20  
**Estado:** âœ… Aceptable para producciÃ³n

**DistribuciÃ³n:**
- CrÃ­ticas: 0/5 âœ…
- Altas: 2 mitigadas parcialmente âš ï¸
- Medias: 4 identificadas âš ï¸
- Bajas: 1 minor ğŸŸ¢

**Deployment:** âœ… APROBADO  
**Con condiciÃ³n:** Implementar VUL-001 y VUL-002 en semana 1

---

**Generado por:** AuditorÃ­a AutomÃ¡tica  
**Fecha:** 2025-01-24  
**MetodologÃ­a:** OWASP Top 10 2021, CWE Top 25






